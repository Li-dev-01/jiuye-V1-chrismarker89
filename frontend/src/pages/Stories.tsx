/**
 * Â∞±‰∏öÊïÖ‰∫ãÂ±ïÁ§∫È°µÈù¢
 * Â±ïÁ§∫ÊâÄÊúâÁî®Êà∑ÂèëÂ∏ÉÁöÑÂ∞±‰∏öÊïÖ‰∫ã
 */

import React, { useState, useEffect } from 'react';
import {
  Card, Row, Col, Typography, Space, Tag, Button,
  Select, Input, Pagination, Empty, Spin, Modal, Avatar
} from 'antd';
import {
  BookOutlined, SearchOutlined, EyeOutlined, HeartOutlined,
  UserOutlined, PlusOutlined, StarOutlined, FrownOutlined
} from '@ant-design/icons';
import { useAuth } from '../stores/universalAuthStore';
import { UserType } from '../types/uuid-system';
import { storyService } from '../services/storyService';
import type { Story } from '../services/storyService';
import { ManagementAdminService } from '../services/ManagementAdminService';
import { UnifiedCard } from '../components/common/UnifiedCard';
import type { UnifiedCardData } from '../components/common/UnifiedCard';
import StoryForm from '../components/forms/StoryForm';
import SwipeViewer from '../components/common/SwipeViewer';
import '../styles/UnifiedPages.css';

const { Title, Text, Paragraph } = Typography;
const { Search } = Input;
const { Option } = Select;

// ÂÜÖÂÆπÊ∏ÖÁêÜÂáΩÊï∞ - ÁßªÈô§ÂàÜÁ±ªÊ†áËØÜÁ¨¶
const cleanContent = (content: string): string => {
  if (!content) return '';

  // ÁßªÈô§ÂºÄÂ§¥ÁöÑÂàÜÁ±ªÊ†áËØÜÁ¨¶ÔºåÂ¶Ç [growth]„ÄÅ[interview]„ÄÅ[career_change] Á≠â
  const cleaned = content.replace(/^\[[\w_]+\]\s*/, '');

  return cleaned.trim();
};

const Stories: React.FC = () => {
  const { currentUser, isAuthenticated } = useAuth();
  const [stories, setStories] = useState<Story[]>([]);
  const [featuredStories, setFeaturedStories] = useState<Story[]>([]);
  const [loading, setLoading] = useState<boolean>(true);
  const [featuredLoading, setFeaturedLoading] = useState<boolean>(true);
  const [total, setTotal] = useState<number>(0);
  const [currentPage, setCurrentPage] = useState<number>(1);
  const [pageSize, setPageSize] = useState<number>(12);
  const [swipeCurrentPage, setSwipeCurrentPage] = useState<number>(1);
  const [swipeStories, setSwipeStories] = useState<Story[]>([]);
  const [swipeLoading, setSwipeLoading] = useState<boolean>(false);
  const [searchText, setSearchText] = useState<string>('');
  const [selectedCategory, setSelectedCategory] = useState<string>('');
  const [selectedTags, setSelectedTags] = useState<string[]>([]);
  const [availableTags, setAvailableTags] = useState<any[]>([]);
  const [sortBy, setSortBy] = useState<string>('published_at');
  const [createModalVisible, setCreateModalVisible] = useState<boolean>(false);
  const [selectedStory, setSelectedStory] = useState<Story | null>(null);
  const [detailModalVisible, setDetailModalVisible] = useState<boolean>(false);

  // ÊªëÂä®ÊµèËßàÂô®Áä∂ÊÄÅ
  const [swipeViewerVisible, setSwipeViewerVisible] = useState<boolean>(false);
  const [currentSwipeIndex, setCurrentSwipeIndex] = useState<number>(0);
  const [userLikes, setUserLikes] = useState<Set<number>>(new Set());
  const [userDislikes, setUserDislikes] = useState<Set<number>>(new Set());

  // Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶ÂèØ‰ª•ÂèëÂ∏É
  const canPublish = isAuthenticated && currentUser?.userType === UserType.SEMI_ANONYMOUS;

  // ÊïÖ‰∫ãÂàÜÁ±ªÈÄâÈ°π
  const categories = [
    { value: '', label: 'ÂÖ®ÈÉ®ÂàÜÁ±ª' },
    { value: 'job-hunting', label: 'Ê±ÇËÅåÁªèÂéÜ', icon: 'üîç' },
    { value: 'career-change', label: 'ËÅå‰∏öËΩ¨Êç¢', icon: 'üîÑ' },
    { value: 'entrepreneurship', label: 'Âàõ‰∏öÁªèÂéÜ', icon: 'üöÄ' },
    { value: 'internship', label: 'ÂÆû‰π†‰ΩìÈ™å', icon: 'üìö' },
    { value: 'workplace', label: 'ËÅåÂú∫ÊïÖ‰∫ã', icon: 'üè¢' },
    { value: 'growth', label: 'ÊàêÈïøÂéÜÁ®ã', icon: 'üå±' }
  ];

  // ÊéíÂ∫èÈÄâÈ°π
  const sortOptions = [
    { value: 'published_at', label: 'ÊúÄÊñ∞ÂèëÂ∏É' },
    { value: 'view_count', label: 'ÊúÄÂ§öÊµèËßà' },
    { value: 'like_count', label: 'ÊúÄÂ§öÁÇπËµû' }
  ];

  useEffect(() => {
    loadAvailableTags();
  }, []);

  useEffect(() => {
    loadStories();
    loadFeaturedStories();
  }, [currentPage, pageSize, selectedCategory, selectedTags, sortBy]);

  // Âä†ËΩΩÊïÖ‰∫ãÂàóË°®
  const loadStories = async () => {
    setLoading(true);
    try {
      const result = await storyService.getStories({
        page: currentPage,
        pageSize: pageSize,
        category: selectedCategory || undefined,
        tags: selectedTags.length > 0 ? selectedTags : undefined,
        sortBy: sortBy as any,
        sortOrder: 'desc',
        published: true
      });

      if (result.success && result.data) {
        setStories(result.data.stories);
        setTotal(result.data.total);
      } else {
        console.error('Failed to load stories:', result.error);
      }
    } catch (error) {
      console.error('Load stories error:', error);
    } finally {
      setLoading(false);
    }
  };

  // Âä†ËΩΩÂèØÁî®Ê†áÁ≠æ
  const loadAvailableTags = async () => {
    try {
      const tags = await ManagementAdminService.getContentTags();
      // Á≠õÈÄâÊïÖ‰∫ãÁõ∏ÂÖ≥ÁöÑÊ†áÁ≠æ
      const storyTags = tags.filter((tag: any) =>
        tag.content_type === 'story' || tag.content_type === 'all'
      );
      setAvailableTags(storyTags);
    } catch (error) {
      console.error('Load tags error:', error);
    }
  };

  // Âä†ËΩΩÁ≤æÈÄâÊïÖ‰∫ã
  const loadFeaturedStories = async () => {
    setFeaturedLoading(true);
    try {
      const result = await storyService.getFeaturedStories({
        pageSize: 6
      });

      if (result.success && result.data) {
        setFeaturedStories(result.data.stories);
      }
    } catch (error) {
      console.error('Load featured stories error:', error);
    } finally {
      setFeaturedLoading(false);
    }
  };

  // ÊêúÁ¥¢ÊïÖ‰∫ã
  const handleSearch = async (value: string) => {
    setSearchText(value);
    if (value.trim()) {
      setLoading(true);
      try {
        const result = await storyService.searchStories(value, {
          page: 1,
          pageSize: pageSize,
          category: selectedCategory || undefined,
          sortBy: sortBy as any,
          sortOrder: 'desc'
        });

        if (result.success && result.data) {
          setStories(result.data.stories);
          setTotal(result.data.total);
          setCurrentPage(1);
        }
      } catch (error) {
        console.error('Search stories error:', error);
      } finally {
        setLoading(false);
      }
    } else {
      loadStories();
    }
  };

  // Êü•ÁúãÊïÖ‰∫ãËØ¶ÊÉÖ - ‰ΩøÁî®ÊªëÂä®ÊµèËßàÂô®
  const handleViewStory = async (story: Story) => {
    try {
      // Â¢ûÂä†ÊµèËßàÈáè
      await storyService.incrementViewCount(story.id);

      // ÊâæÂà∞ÊïÖ‰∫ãÂú®ÂàóË°®‰∏≠ÁöÑÁ¥¢Âºï
      const index = stories.findIndex(s => s.id === story.id);
      if (index !== -1) {
        setCurrentSwipeIndex(index);
        setSwipeViewerVisible(true);

        // ÂàùÂßãÂåñÊªëÂä®ÊµèËßàÂô®ÁöÑÊï∞ÊçÆ
        setSwipeStories([...stories]);
        setSwipeCurrentPage(currentPage);

        // Êõ¥Êñ∞Êú¨Âú∞ÊµèËßàÈáè
        setStories(prev => prev.map(s =>
          s.id === story.id
            ? { ...s, viewCount: s.viewCount + 1 }
            : s
        ));
      }
    } catch (error) {
      console.error('View story error:', error);
    }
  };

  // Âú®ÊªëÂä®ÊµèËßàÂô®‰∏≠Âä†ËΩΩÊõ¥Â§öÊïÖ‰∫ã
  const handleLoadMoreInSwipe = async () => {
    if (swipeLoading || swipeStories.length >= total) return;

    setSwipeLoading(true);
    try {
      const nextPage = swipeCurrentPage + 1;
      const result = await storyService.getStories({
        page: nextPage,
        pageSize: pageSize,
        category: selectedCategory || undefined,
        tags: selectedTags.length > 0 ? selectedTags : undefined,
        sortBy: sortBy as any,
        sortOrder: 'desc',
        published: true
      });

      if (result.success && result.data) {
        setSwipeStories(prev => [...prev, ...result.data.stories]);
        setSwipeCurrentPage(nextPage);
      }
    } catch (error) {
      console.error('Load more stories in swipe error:', error);
    } finally {
      setSwipeLoading(false);
    }
  };

  // ÁÇπÂáªÂç°ÁâáÂ§ÑÁêÜÂáΩÊï∞ - ÈÄÇÈÖçUnifiedCard
  const handleCardClick = (cardData: UnifiedCardData) => {
    const story = stories.find(s => s.id === cardData.id);
    if (story) {
      handleViewStory(story);
    }
  };

  // ÁÇπËµûÊïÖ‰∫ã
  const handleLike = async (storyOrId: Story | number) => {
    if (!isAuthenticated) {
      Modal.info({
        title: 'ÈúÄË¶ÅÁôªÂΩï',
        content: 'ËØ∑ÁôªÂΩïÂêéÂÜçËøõË°åÁÇπËµûÊìç‰Ωú',
        onOk: () => {
          // Ëß¶ÂèëÂÖ®Â±Ä‰∫ã‰ª∂ÊâìÂºÄÂçäÂåøÂêçÁôªÂΩï
          window.dispatchEvent(new Event('openSemiAnonymousLogin'));
        }
      });
      return;
    }

    const storyId = typeof storyOrId === 'number' ? storyOrId : storyOrId.id;

    try {
      const result = await storyService.likeStory(storyId);
      if (result.success) {
        // Êõ¥Êñ∞Êú¨Âú∞Áä∂ÊÄÅ
        setStories(prev => prev.map(story =>
          story.id === storyId
            ? { ...story, likeCount: story.likeCount + 1 }
            : story
        ));

        // Êõ¥Êñ∞Áî®Êà∑ÁÇπËµûÁä∂ÊÄÅ
        setUserLikes(prev => new Set([...prev, storyId]));
      }
    } catch (error) {
      console.error('Like story error:', error);
    }
  };

  // Ë∏©ÊïÖ‰∫ã
  const handleDislike = async (storyOrId: Story | number) => {
    if (!isAuthenticated) {
      Modal.info({
        title: 'ÈúÄË¶ÅÁôªÂΩï',
        content: 'ËØ∑ÁôªÂΩïÂêéÂÜçËøõË°åÊìç‰Ωú',
        onOk: () => {
          // Ëß¶ÂèëÂÖ®Â±Ä‰∫ã‰ª∂ÊâìÂºÄÂçäÂåøÂêçÁôªÂΩï
          window.dispatchEvent(new Event('openSemiAnonymousLogin'));
        }
      });
      return;
    }

    const storyId = typeof storyOrId === 'number' ? storyOrId : storyOrId.id;

    try {
      const result = await storyService.dislikeStory(storyId);
      if (result.success) {
        // Êõ¥Êñ∞Êú¨Âú∞Áä∂ÊÄÅ
        setStories(prev => prev.map(story =>
          story.id === storyId
            ? { ...story, dislikeCount: (story.dislikeCount || 0) + 1 }
            : story
        ));

        // Êõ¥Êñ∞Áî®Êà∑Ë∏©Áä∂ÊÄÅ
        setUserDislikes(prev => new Set([...prev, storyId]));
      }
    } catch (error) {
      console.error('Dislike story error:', error);
    }
  };

  // ‰∏ãËΩΩÊïÖ‰∫ã
  const handleDownload = (story: Story) => {
    // ËøôÈáåÂèØ‰ª•Ë∞ÉÁî®Áé∞ÊúâÁöÑ‰∏ãËΩΩÂäüËÉΩ
    console.log('Download story:', story.id);
  };

  // Ëé∑ÂèñÂàÜÁ±ªÊ†áÁ≠æÈ¢úËâ≤
  const getCategoryColor = (category: string) => {
    const colors: Record<string, string> = {
      'job-hunting': 'blue',
      'career-change': 'green',
      'entrepreneurship': 'orange',
      'internship': 'purple',
      'workplace': 'cyan',
      'growth': 'pink'
    };
    return colors[category] || 'default';
  };

  // ËΩ¨Êç¢ÊïÖ‰∫ãÊï∞ÊçÆ‰∏∫Áªü‰∏ÄÂç°ÁâáÊï∞ÊçÆÊ†ºÂºè
  const convertStoryToCardData = (story: Story): UnifiedCardData => ({
    id: story.id,
    type: 'story',
    title: cleanContent(story.title || ''),
    summary: cleanContent(story.summary || ''),
    category: story.category,
    tags: story.tags,
    likeCount: story.likeCount,
    dislikeCount: story.dislikeCount,
    createdAt: story.createdAt,
    publishedAt: story.publishedAt,
    authorName: story.authorName,
    isAnonymous: story.isAnonymous,
    isFeatured: story.isFeatured,
    readingTime: story.readingTime
  });

  // Ê∏≤ÊüìÊïÖ‰∫ãÂç°Áâá
  const renderStoryCard = (story: Story, featured = false) => (
    <Col xs={24} sm={12} lg={8} xl={featured ? 12 : 6} key={story.id}>
      <UnifiedCard
        data={convertStoryToCardData(story)}
        featured={featured}
        onClick={handleCardClick}
        onLike={handleLike}
        onDislike={handleDislike}
        categories={categories}
      />
    </Col>
  );

  return (
    <div className="unified-page">
      {/* È°µÈù¢Â§¥ÈÉ® */}
      <div className="page-header">
        <div className="header-content">
          <Title level={2}>
            <BookOutlined style={{ color: '#1890ff' }} />
            Â∞±‰∏öÊïÖ‰∫ã
          </Title>
          <Paragraph type="secondary">
            ÂàÜ‰∫´‰Ω†ÁöÑÂ∞±‰∏öÁªèÂéÜÔºåÂêØÂèë‰ªñ‰∫∫ÁöÑËÅå‰∏öÈÅìË∑Ø
          </Paragraph>
        </div>
        
        {canPublish && (
          <Button
            type="primary"
            icon={<PlusOutlined />}
            size="large"
            onClick={() => setCreateModalVisible(true)}
          >
            ÂèëÂ∏ÉÊïÖ‰∫ã
          </Button>
        )}
      </div>

      {/* Á≤æÈÄâÊïÖ‰∫ã */}
      {featuredStories.length > 0 && (
        <Card className="featured-section" title="‚ú® Á≤æÈÄâÊïÖ‰∫ã">
          <Spin spinning={featuredLoading}>
            <Row gutter={[16, 16]}>
              {featuredStories.map(story => renderStoryCard(story, true))}
            </Row>
          </Spin>
        </Card>
      )}

      {/* Á≠õÈÄâÂíåÊêúÁ¥¢ */}
      <Card className="filter-card">
        <Row gutter={[16, 16]} align="middle">
          <Col xs={24} sm={12} md={8}>
            <Search
              placeholder="ÊêúÁ¥¢ÊïÖ‰∫ãÊ†áÈ¢òÊàñÂÜÖÂÆπ..."
              allowClear
              onSearch={handleSearch}
              style={{ width: '100%' }}
            />
          </Col>
          
          <Col xs={12} sm={6} md={4}>
            <Select
              placeholder="ÈÄâÊã©ÂàÜÁ±ª"
              style={{ width: '100%' }}
              value={selectedCategory}
              onChange={setSelectedCategory}
            >
              {categories.map(cat => (
                <Option key={cat.value} value={cat.value}>
                  <Space>
                    {cat.icon && <span>{cat.icon}</span>}
                    <span>{cat.label}</span>
                  </Space>
                </Option>
              ))}
            </Select>
          </Col>
          
          <Col xs={24} sm={12} md={8}>
            <Select
              mode="multiple"
              placeholder="ÈÄâÊã©Ê†áÁ≠æÁ≠õÈÄâ"
              style={{ width: '100%' }}
              value={selectedTags}
              onChange={setSelectedTags}
              allowClear
              maxTagCount="responsive"
              showSearch
              filterOption={(input, option) => {
                const tag = availableTags.find(t => t.id === option?.value);
                return tag?.tag_name.toLowerCase().includes(input.toLowerCase()) ||
                       tag?.tag_name_en?.toLowerCase().includes(input.toLowerCase()) ||
                       tag?.tag_key.toLowerCase().includes(input.toLowerCase());
              }}
              notFoundContent={availableTags.length === 0 ? "Âä†ËΩΩ‰∏≠..." : "Êó†ÂåπÈÖçÊ†áÁ≠æ"}
            >
              {/* ÁÉ≠Èó®Ê†áÁ≠æÂàÜÁªÑ */}
              {availableTags
                .filter(tag => tag.usage_count > 10)
                .sort((a, b) => b.usage_count - a.usage_count)
                .slice(0, 5)
                .map(tag => (
                  <Option key={`hot-${tag.id}`} value={tag.id}>
                    <Tag color={tag.color} style={{ margin: 0 }}>
                      üî• {tag.tag_name} ({tag.usage_count})
                    </Tag>
                  </Option>
                ))}

              {/* ÂàÜÈöîÁ∫ø */}
              {availableTags.some(tag => tag.usage_count > 10) && (
                <Option disabled key="divider" value="divider">
                  <div style={{ borderTop: '1px solid #f0f0f0', margin: '4px 0' }}></div>
                </Option>
              )}

              {/* ÊâÄÊúâÊ†áÁ≠æ */}
              {availableTags
                .sort((a, b) => a.tag_name.localeCompare(b.tag_name))
                .map(tag => (
                  <Option key={tag.id} value={tag.id}>
                    <Tag color={tag.color} style={{ margin: 0 }}>
                      {tag.tag_name}
                      {tag.usage_count > 0 && (
                        <span style={{ marginLeft: 4, opacity: 0.7 }}>
                          ({tag.usage_count})
                        </span>
                      )}
                    </Tag>
                  </Option>
                ))}
            </Select>
          </Col>

          <Col xs={12} sm={6} md={4}>
            <Select
              placeholder="ÊéíÂ∫èÊñπÂºè"
              style={{ width: '100%' }}
              value={sortBy}
              onChange={setSortBy}
            >
              {sortOptions.map(opt => (
                <Option key={opt.value} value={opt.value}>
                  {opt.label}
                </Option>
              ))}
            </Select>
          </Col>
          
          <Col xs={24} md={8}>
            <div className="stats-info">
              <Text type="secondary">
                ÂÖ± {total} ‰∏™ÊïÖ‰∫ã
                {searchText && ` ‚Ä¢ ÊêúÁ¥¢"${searchText}"`}
                {selectedCategory && ` ‚Ä¢ ${categories.find(c => c.value === selectedCategory)?.label}`}
              </Text>
            </div>
          </Col>
        </Row>
      </Card>

      {/* ÊïÖ‰∫ãÂàóË°® */}
      <div className="content-area">
        <Spin spinning={loading}>
          {stories.length > 0 ? (
            <>
              <Row gutter={[16, 16]}>
                {stories.map(story => renderStoryCard(story))}
              </Row>
              
              <div className="pagination-wrapper">
                <Pagination
                  current={currentPage}
                  total={total}
                  pageSize={pageSize}
                  showSizeChanger
                  showQuickJumper
                  showTotal={(total, range) => 
                    `Á¨¨ ${range[0]}-${range[1]} Êù°ÔºåÂÖ± ${total} Êù°`
                  }
                  onChange={(page, size) => {
                    setCurrentPage(page);
                    if (size !== pageSize) {
                      setPageSize(size);
                    }
                  }}
                />
              </div>
            </>
          ) : (
            <Empty
              description={
                searchText || selectedCategory 
                  ? "Ê≤°ÊúâÊâæÂà∞ÂåπÈÖçÁöÑÊïÖ‰∫ã" 
                  : "ÊöÇÊó†ÊïÖ‰∫ãÂàÜ‰∫´"
              }
              image={Empty.PRESENTED_IMAGE_SIMPLE}
            >
              {canPublish && !searchText && !selectedCategory && (
                <Button 
                  type="primary" 
                  icon={<PlusOutlined />}
                  onClick={() => setCreateModalVisible(true)}
                >
                  ÂèëÂ∏ÉÁ¨¨‰∏Ä‰∏™ÊïÖ‰∫ã
                </Button>
              )}
            </Empty>
          )}
        </Spin>
      </div>

      {/* ÂèëÂ∏ÉÊïÖ‰∫ãÊ®°ÊÄÅÊ°Ü */}
      <StoryForm
        mode="modal"
        visible={createModalVisible}
        onCancel={() => setCreateModalVisible(false)}
        onSuccess={() => {
          setCreateModalVisible(false);
          loadStories(); // ÈáçÊñ∞Âä†ËΩΩÂàóË°®
        }}
      />

      {/* ÊïÖ‰∫ãËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü */}
      <Modal
        title={selectedStory?.title}
        visible={detailModalVisible}
        onCancel={() => setDetailModalVisible(false)}
        footer={null}
        width={800}
      >
        {selectedStory && (
          <div className="story-detail">
            <div className="story-detail-meta">
              <Space>
                <Tag color={getCategoryColor(selectedStory.category)}>
                  {categories.find(c => c.value === selectedStory.category)?.label}
                </Tag>
                {selectedStory.isFeatured && (
                  <Tag color="gold">Á≤æÈÄâ</Tag>
                )}
              </Space>
              <div style={{ marginTop: 8 }}>
                <Space>
                  <Avatar size="small" icon={<UserOutlined />} />
                  <Text>{selectedStory.authorName}</Text>
                  <Text type="secondary">‚Ä¢</Text>
                  <Text type="secondary">
                    {new Date(selectedStory.publishedAt || selectedStory.createdAt).toLocaleString()}
                  </Text>
                </Space>
              </div>
            </div>
            
            <div className="story-detail-content">
              <Paragraph style={{ whiteSpace: 'pre-wrap', fontSize: '16px', lineHeight: '1.8' }}>
                {cleanContent(selectedStory.content)}
              </Paragraph>
            </div>
            
            {selectedStory.tags && selectedStory.tags.length > 0 && (
              <div className="story-detail-tags">
                <Text strong>Ê†áÁ≠æÔºö</Text>
                <Space wrap style={{ marginTop: 8 }}>
                  {selectedStory.tags.map(tag => (
                    <Tag key={tag}>{tag}</Tag>
                  ))}
                </Space>
              </div>
            )}
            
            <div className="story-detail-stats">
              <Space>
                <Text type="secondary">
                  <EyeOutlined /> {selectedStory.viewCount} Ê¨°ÊµèËßà
                </Text>
                <Text type="secondary">
                  <HeartOutlined /> {selectedStory.likeCount} Ê¨°ÁÇπËµû
                </Text>
              </Space>
            </div>
          </div>
        )}
      </Modal>

      {/* ÊªëÂä®ÊµèËßàÂô® */}
      <SwipeViewer
        visible={swipeViewerVisible}
        onClose={() => setSwipeViewerVisible(false)}
        items={swipeStories}
        currentIndex={currentSwipeIndex}
        onIndexChange={setCurrentSwipeIndex}
        onLike={handleLike}
        onDislike={handleDislike}
        onDownload={canPublish ? handleDownload : undefined}
        contentType="story"
        userLikes={userLikes}
        userDislikes={userDislikes}
        hasMore={swipeStories.length < total}
        onLoadMore={handleLoadMoreInSwipe}
      />
    </div>
  );
};

export default Stories;
