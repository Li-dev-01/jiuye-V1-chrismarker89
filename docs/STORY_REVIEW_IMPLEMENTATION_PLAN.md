# 🚀 故事审核系统实施计划

**计划时间**: 2025-09-30  
**计划模式**: PLAN (RIPER-5-AI)  
**预计工期**: 3周  
**优先级**: 🔴 最高

---

## 📋 任务分解

### 第一周: 核心功能修复 (2025-10-01 ~ 2025-10-07)

#### 任务 1.1: 修复故事提交数据流转 ⭐⭐⭐⭐⭐

**文件**: `backend/src/routes/stories.ts`  
**预计时间**: 4小时  
**优先级**: 🔴 最高

**具体步骤**:
1. 导入 `StoryAuditController`
2. 修改 POST `/api/stories` 路由
3. 替换直接插入逻辑为审核流程调用
4. 添加错误处理和日志

**验收标准**:
- ✅ 故事提交后进入 `pending_stories` 表
- ✅ 审核流程被正确触发
- ✅ 审核结果正确返回给前端

**代码示例**:
```typescript
// backend/src/routes/stories.ts
import { StoryAuditController } from '../services/storyAuditController';

stories.post('/', async (c) => {
  const body = await c.req.json();
  const { title, content, category, tags, user_id } = body;
  
  // 使用审核控制器
  const controller = new StoryAuditController(c.env, c.env.DB);
  const result = await controller.processStorySubmission({
    user_id,
    content: `${title}\n\n${content}`,
    user_ip: c.req.header('CF-Connecting-IP'),
    user_agent: c.req.header('User-Agent')
  });
  
  return c.json({
    success: result.success,
    data: result,
    message: result.message
  });
});
```

---

#### 任务 1.2: 更新前端提交逻辑 ⭐⭐⭐⭐

**文件**: `frontend/src/pages/StorySubmitPage.tsx`  
**预计时间**: 2小时  
**优先级**: 🔴 高

**具体步骤**:
1. 修改提交成功后的处理逻辑
2. 根据审核状态显示不同提示
3. 添加审核中状态的跳转逻辑

**验收标准**:
- ✅ 审核通过：显示成功，跳转到故事页面
- ✅ 审核拒绝：显示拒绝原因
- ✅ 审核中：显示审核中提示，跳转到我的内容

**代码示例**:
```typescript
if (result.success) {
  if (result.data.status === 'approved') {
    message.success('故事发布成功！');
    navigate('/stories');
  } else if (result.data.status === 'rejected') {
    message.error('故事未通过审核：' + result.data.message);
  } else {
    message.info('故事已提交，正在审核中');
    navigate('/user/my-content');
  }
}
```

---

#### 任务 1.3: 创建敏感词库数据库表 ⭐⭐⭐⭐

**文件**: `backend/database/sensitive-words-schema.sql` (新建)  
**预计时间**: 2小时  
**优先级**: 🔴 高

**具体步骤**:
1. 创建 `sensitive_words` 表
2. 创建 `sensitive_word_hits` 表
3. 创建相关索引
4. 准备初始敏感词数据

**验收标准**:
- ✅ 表结构创建成功
- ✅ 索引创建成功
- ✅ 可以插入和查询敏感词

---

#### 任务 1.4: 实现敏感词管理API ⭐⭐⭐⭐

**文件**: `backend/src/routes/sensitiveWords.ts` (新建)  
**预计时间**: 6小时  
**优先级**: 🔴 高

**API端点**:
- `GET /api/sensitive-words` - 获取敏感词列表
- `POST /api/sensitive-words` - 添加敏感词
- `PUT /api/sensitive-words/:id` - 更新敏感词
- `DELETE /api/sensitive-words/:id` - 删除敏感词
- `POST /api/sensitive-words/batch` - 批量导入
- `POST /api/sensitive-words/test` - 测试检测
- `GET /api/sensitive-words/statistics` - 获取统计

**验收标准**:
- ✅ 所有API端点正常工作
- ✅ 支持分类和严重程度筛选
- ✅ 批量导入功能正常
- ✅ 测试功能准确

---

#### 任务 1.5: 集成敏感词到审核流程 ⭐⭐⭐⭐⭐

**文件**: `backend/src/services/tieredAuditService.ts`  
**预计时间**: 4小时  
**优先级**: 🔴 最高

**具体步骤**:
1. 修改规则审核逻辑，从数据库读取敏感词
2. 替换硬编码的 AUDIT_RULES
3. 记录敏感词命中情况
4. 更新敏感词命中统计

**验收标准**:
- ✅ 审核时使用数据库敏感词
- ✅ 敏感词命中被正确记录
- ✅ 命中统计实时更新

---

### 第二周: 管理界面开发 (2025-10-08 ~ 2025-10-14)

#### 任务 2.1: 开发敏感词管理页面 ⭐⭐⭐⭐

**文件**: `reviewer-admin-dashboard/src/pages/AdminSensitiveWords.tsx` (新建)  
**预计时间**: 8小时  
**优先级**: 🟡 中

**功能模块**:
1. **敏感词列表**
   - 表格展示 (词语、分类、严重程度、动作、命中次数)
   - 分类筛选 (政治、色情、暴力等)
   - 严重程度筛选 (高、中、低)
   - 搜索功能
   - 分页功能

2. **添加/编辑敏感词**
   - 表单对话框
   - 字段验证
   - 重复检查

3. **批量导入**
   - CSV文件上传
   - JSON格式导入
   - 导入预览
   - 错误处理

4. **敏感词测试工具**
   - 文本输入框
   - 实时检测
   - 命中高亮显示
   - 检测结果详情

5. **统计分析**
   - 分类分布图表
   - 命中率排行
   - 趋势分析

**验收标准**:
- ✅ 所有功能模块正常工作
- ✅ UI美观，交互流畅
- ✅ 支持移动端访问

---

#### 任务 2.2: 开发审核监控页面 ⭐⭐⭐⭐

**文件**: `reviewer-admin-dashboard/src/pages/AdminReviewMonitoring.tsx` (新建)  
**预计时间**: 8小时  
**优先级**: 🟡 中

**功能模块**:
1. **实时监控面板**
   - 审核通过率 (实时)
   - 审核拒绝率 (实时)
   - 人工审核率 (实时)
   - 平均审核时间

2. **三层审核效果对比**
   - 规则审核效果
   - AI审核效果
   - 人工审核效果
   - 对比图表

3. **误判分析**
   - 误判案例列表
   - 误判原因分析
   - 改进建议

4. **审核耗时统计**
   - 各层审核耗时
   - 耗时趋势图
   - 性能瓶颈分析

5. **人工审核工作量**
   - 审核员工作量统计
   - 审核效率排行
   - 工作负载分布

**验收标准**:
- ✅ 实时数据更新
- ✅ 图表展示清晰
- ✅ 数据准确可靠

---

#### 任务 2.3: 集成到管理员后台 ⭐⭐⭐

**文件**: `reviewer-admin-dashboard/src/App.tsx`  
**预计时间**: 2小时  
**优先级**: 🟡 中

**具体步骤**:
1. 添加路由配置
2. 添加菜单项
3. 配置权限控制

**验收标准**:
- ✅ 菜单正常显示
- ✅ 路由跳转正常
- ✅ 权限控制生效

---

### 第三周: 测试和优化 (2025-10-15 ~ 2025-10-21)

#### 任务 3.1: 创建测试内容库 ⭐⭐⭐

**文件**: `backend/database/test-content-schema.sql` (新建)  
**预计时间**: 4小时  
**优先级**: 🟢 低

**具体步骤**:
1. 创建测试内容表
2. 创建测试执行记录表
3. 准备测试数据集

**测试数据类别**:
- 正常内容 (应通过)
- 轻微违规 (应进入人工审核)
- 严重违规 (应直接拒绝)
- 边界案例 (测试规则边界)

---

#### 任务 3.2: 实现自动化测试 ⭐⭐⭐

**文件**: `backend/src/routes/auditTesting.ts` (新建)  
**预计时间**: 6小时  
**优先级**: 🟢 低

**API端点**:
- `POST /api/audit-testing/run` - 运行测试
- `GET /api/audit-testing/results` - 获取测试结果
- `GET /api/audit-testing/report` - 生成测试报告

**验收标准**:
- ✅ 自动化测试可执行
- ✅ 测试结果准确
- ✅ 生成详细报告

---

#### 任务 3.3: 性能优化 ⭐⭐⭐⭐

**预计时间**: 8小时  
**优先级**: 🟡 中

**优化项目**:
1. **数据库查询优化**
   - 添加必要索引
   - 优化复杂查询
   - 使用查询缓存

2. **API响应优化**
   - 减少不必要的数据传输
   - 使用分页加载
   - 实现数据缓存

3. **前端性能优化**
   - 组件懒加载
   - 虚拟滚动
   - 防抖节流

**验收标准**:
- ✅ API响应时间 < 200ms
- ✅ 页面加载时间 < 2s
- ✅ 大数据量下流畅运行

---

#### 任务 3.4: 文档完善 ⭐⭐⭐

**预计时间**: 4小时  
**优先级**: 🟢 低

**文档清单**:
1. **用户文档**
   - 故事提交指南
   - 审核规则说明
   - 常见问题解答

2. **管理员文档**
   - 敏感词管理指南
   - 审核监控使用说明
   - 系统配置指南

3. **开发文档**
   - API接口文档
   - 数据库设计文档
   - 部署指南

**验收标准**:
- ✅ 文档完整准确
- ✅ 示例代码可运行
- ✅ 图表清晰易懂

---

## 📊 进度跟踪

### 第一周任务清单

- [ ] 任务 1.1: 修复故事提交数据流转 (4h)
- [ ] 任务 1.2: 更新前端提交逻辑 (2h)
- [ ] 任务 1.3: 创建敏感词库数据库表 (2h)
- [ ] 任务 1.4: 实现敏感词管理API (6h)
- [ ] 任务 1.5: 集成敏感词到审核流程 (4h)

**总计**: 18小时 (约2.5个工作日)

### 第二周任务清单

- [ ] 任务 2.1: 开发敏感词管理页面 (8h)
- [ ] 任务 2.2: 开发审核监控页面 (8h)
- [ ] 任务 2.3: 集成到管理员后台 (2h)

**总计**: 18小时 (约2.5个工作日)

### 第三周任务清单

- [ ] 任务 3.1: 创建测试内容库 (4h)
- [ ] 任务 3.2: 实现自动化测试 (6h)
- [ ] 任务 3.3: 性能优化 (8h)
- [ ] 任务 3.4: 文档完善 (4h)

**总计**: 22小时 (约3个工作日)

---

## 🎯 里程碑

### 里程碑 1: 核心功能修复 (第一周结束)
- ✅ 审核流程正常工作
- ✅ 敏感词库可管理
- ✅ 数据流转正确

### 里程碑 2: 管理界面完成 (第二周结束)
- ✅ 敏感词管理界面可用
- ✅ 审核监控界面可用
- ✅ 集成到管理后台

### 里程碑 3: 系统上线 (第三周结束)
- ✅ 测试通过
- ✅ 性能达标
- ✅ 文档完善
- ✅ 正式上线

---

## ⚠️ 风险和应对

### 风险 1: 数据迁移问题
**描述**: 现有 `valid_stories` 表中的数据可能需要迁移  
**影响**: 中  
**应对**: 
- 保留现有数据不变
- 新提交的故事使用新流程
- 提供数据迁移脚本 (可选)

### 风险 2: 性能问题
**描述**: 敏感词检测可能影响提交性能  
**影响**: 中  
**应对**:
- 使用索引优化查询
- 实现敏感词缓存
- 异步处理AI审核

### 风险 3: 误判率高
**描述**: 自动审核可能误判正常内容  
**影响**: 高  
**应对**:
- 调整审核阈值
- 增加人工审核比例
- 持续优化规则

---

## 📝 下一步行动

1. **立即开始**: 任务 1.1 - 修复故事提交数据流转
2. **准备工作**: 搭建开发环境，准备测试数据
3. **团队协作**: 分配任务，建立沟通机制
4. **进度跟踪**: 每日更新任务进度，及时调整计划

---

**计划制定时间**: 2025-09-30  
**计划模式**: PLAN (RIPER-5-AI)  
**下一步**: 进入 EXECUTE 模式，开始实施

