# UUIDç”¨æˆ·ç®¡ç†ç³»ç»Ÿå®ç°æ–‡æ¡£

## ğŸ¯ ç³»ç»Ÿæ¦‚è¿°

UUIDç”¨æˆ·ç®¡ç†ç³»ç»Ÿæ˜¯ä¸€ä¸ªç»Ÿä¸€çš„ç”¨æˆ·èº«ä»½ç®¡ç†è§£å†³æ–¹æ¡ˆï¼Œæ”¯æŒ5ç§ç”¨æˆ·ç±»å‹çš„è®¤è¯ã€æƒé™ç®¡ç†å’Œå†…å®¹å…³è”ã€‚ç³»ç»Ÿé‡‡ç”¨å‰åç«¯åˆ†ç¦»æ¶æ„ï¼Œæä¾›å®Œæ•´çš„APIæ¥å£å’Œå‰ç«¯ç»„ä»¶ã€‚

## ğŸ“‹ ç”¨æˆ·ç±»å‹

### 1. å…¨åŒ¿åç”¨æˆ· (Anonymous)
- **UUIDæ ¼å¼**: `anon-YYYYMMDD-uuid`
- **æƒé™**: æµè§ˆå†…å®¹ã€æäº¤é—®å·
- **ä¼šè¯æ—¶é•¿**: 24å°æ—¶
- **ç‰¹ç‚¹**: åŸºäºè®¾å¤‡æŒ‡çº¹è¯†åˆ«ï¼Œæ— éœ€æ³¨å†Œ

### 2. åŠåŒ¿åç”¨æˆ· (Semi-Anonymous)
- **UUIDæ ¼å¼**: `semi-YYYYMMDD-uuid`
- **æƒé™**: æµè§ˆå†…å®¹ã€æäº¤é—®å·ã€ç®¡ç†è‡ªå·±çš„å†…å®¹ã€ä¸‹è½½æƒé™
- **ä¼šè¯æ—¶é•¿**: 24å°æ—¶
- **ç‰¹ç‚¹**: A+Bç»„åˆè®¤è¯ï¼Œå¯ç®¡ç†å…³è”å†…å®¹

### 3. å®¡æ ¸å‘˜ (Reviewer)
- **UUIDæ ¼å¼**: `rev-uuid`
- **æƒé™**: å†…å®¹å®¡æ ¸ã€æŸ¥çœ‹å®¡æ ¸ç»Ÿè®¡
- **ä¼šè¯æ—¶é•¿**: 1å°æ—¶
- **ç‰¹ç‚¹**: ç”±ç®¡ç†å‘˜åˆ›å»ºï¼Œè´Ÿè´£å†…å®¹å®¡æ ¸

### 4. ç®¡ç†å‘˜ (Admin)
- **UUIDæ ¼å¼**: `admin-uuid`
- **æƒé™**: é¡¹ç›®ç®¡ç†ã€ç”¨æˆ·ç®¡ç†ã€ç³»ç»Ÿè®¾ç½®
- **ä¼šè¯æ—¶é•¿**: 1å°æ—¶
- **ç‰¹ç‚¹**: å®Œæ•´çš„é¡¹ç›®ç®¡ç†æƒé™

### 5. è¶…çº§ç®¡ç†å‘˜ (Super Admin)
- **UUIDæ ¼å¼**: `super-uuid`
- **æƒé™**: æ‰€æœ‰æƒé™ã€é¡¹ç›®å¼€å…³æ§åˆ¶
- **ä¼šè¯æ—¶é•¿**: 1å°æ—¶
- **ç‰¹ç‚¹**: æœ€é«˜æƒé™ï¼Œå¯æ§åˆ¶é¡¹ç›®çŠ¶æ€

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### å‰ç«¯æ¶æ„
```
src/
â”œâ”€â”€ types/
â”‚   â””â”€â”€ uuid-system.ts          # ç±»å‹å®šä¹‰
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ uuidUserService.ts      # ç”¨æˆ·ç®¡ç†æœåŠ¡
â”‚   â”œâ”€â”€ uuidApi.ts              # APIæœåŠ¡
â”‚   â””â”€â”€ uuidQuestionnaireService.ts # é—®å·é€‚é…å™¨
â”œâ”€â”€ stores/
â”‚   â””â”€â”€ universalAuthStore.ts   # çŠ¶æ€ç®¡ç†
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”œâ”€â”€ SemiAnonymousLogin.tsx
â”‚   â”‚   â””â”€â”€ IdentityConflictDialog.tsx
â”‚   â””â”€â”€ common/
â”‚       â””â”€â”€ UserStatusIndicator.tsx
â””â”€â”€ utils/
    â””â”€â”€ crypto.ts               # åŠ å¯†å·¥å…·
```

### åç«¯æ¶æ„
```
backend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â””â”€â”€ uuid.ts             # UUIDè·¯ç”±
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ uuid.ts             # UUIDå·¥å…·
â””â”€â”€ database/
    â””â”€â”€ migrations/
        â””â”€â”€ 010_create_uuid_system_tables.sql
```

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½

### 1. ç”¨æˆ·è®¤è¯
- **åŠåŒ¿åè®¤è¯**: A+Bç»„åˆéªŒè¯
- **å…¨åŒ¿åè®¤è¯**: è®¾å¤‡æŒ‡çº¹è¯†åˆ«
- **ç®¡ç†å‘˜è®¤è¯**: ç”¨æˆ·åå¯†ç éªŒè¯
- **ä¼šè¯ç®¡ç†**: è‡ªåŠ¨è¿‡æœŸå’Œåˆ·æ–°

### 2. æƒé™æ§åˆ¶
- **åŸºäºè§’è‰²çš„æƒé™**: æ¯ç§ç”¨æˆ·ç±»å‹æœ‰å›ºå®šæƒé™
- **ç»†ç²’åº¦æ§åˆ¶**: æ”¯æŒåŠŸèƒ½çº§æƒé™æ£€æŸ¥
- **åŠ¨æ€æƒé™**: è¿è¡Œæ—¶æƒé™éªŒè¯

### 3. èº«ä»½åˆ‡æ¢
- **å†²çªæ£€æµ‹**: è‡ªåŠ¨æ£€æµ‹èº«ä»½å†²çª
- **ç¡®è®¤æœºåˆ¶**: ç”¨æˆ·ç¡®è®¤ååˆ‡æ¢èº«ä»½
- **çŠ¶æ€æ¸…ç†**: åˆ‡æ¢æ—¶æ¸…ç†æ—§çŠ¶æ€

### 4. å†…å®¹å…³è”
- **ç”¨æˆ·å†…å®¹æ˜ å°„**: å†…å®¹ä¸ç”¨æˆ·UUIDå…³è”
- **çŠ¶æ€ç®¡ç†**: å†…å®¹å®¡æ ¸çŠ¶æ€è·Ÿè¸ª
- **æƒé™æ§åˆ¶**: åŸºäºç”¨æˆ·ç±»å‹çš„å†…å®¹è®¿é—®

## ğŸ“Š æ•°æ®åº“è®¾è®¡

### æ ¸å¿ƒè¡¨ç»“æ„

#### universal_users - ç»Ÿä¸€ç”¨æˆ·è¡¨
```sql
CREATE TABLE universal_users (
    uuid VARCHAR(64) PRIMARY KEY,
    user_type ENUM('anonymous', 'semi_anonymous', 'reviewer', 'admin', 'super_admin'),
    identity_hash VARCHAR(128) UNIQUE,
    username VARCHAR(50) UNIQUE,
    password_hash VARCHAR(255),
    display_name VARCHAR(100),
    permissions JSON,
    profile JSON,
    metadata JSON,
    status ENUM('active', 'inactive', 'suspended'),
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    last_active_at TIMESTAMP
);
```

#### user_sessions - ç”¨æˆ·ä¼šè¯è¡¨
```sql
CREATE TABLE user_sessions (
    session_id VARCHAR(64) PRIMARY KEY,
    user_uuid VARCHAR(64),
    session_token VARCHAR(128) UNIQUE,
    device_fingerprint VARCHAR(128),
    expires_at TIMESTAMP,
    is_active BOOLEAN,
    created_at TIMESTAMP
);
```

#### user_content_mappings - ç”¨æˆ·å†…å®¹å…³è”è¡¨
```sql
CREATE TABLE user_content_mappings (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_uuid VARCHAR(64),
    content_type ENUM('questionnaire', 'story', 'voice', 'comment'),
    content_id VARCHAR(64),
    status ENUM('draft', 'pending', 'approved', 'rejected'),
    created_at TIMESTAMP
);
```

## ğŸ” å®‰å…¨ç‰¹æ€§

### 1. æ•°æ®åŠ å¯†
- **èº«ä»½å“ˆå¸Œ**: SHA-256 + ç›å€¼åŠ å¯†
- **å¯†ç å­˜å‚¨**: bcryptå“ˆå¸Œ
- **ä¼šè¯ä»¤ç‰Œ**: å®‰å…¨éšæœºç”Ÿæˆ

### 2. é˜²æŠ¤æœºåˆ¶
- **é˜²æš´åŠ›ç ´è§£**: å¤±è´¥æ¬¡æ•°é™åˆ¶
- **ä¼šè¯ç®¡ç†**: è‡ªåŠ¨è¿‡æœŸå’Œæ¸…ç†
- **è®¾å¤‡ç»‘å®š**: è®¾å¤‡æŒ‡çº¹éªŒè¯

### 3. å®¡è®¡æ—¥å¿—
- **è®¤è¯æ—¥å¿—**: è®°å½•æ‰€æœ‰è®¤è¯å°è¯•
- **æ“ä½œæ—¥å¿—**: è®°å½•ç”¨æˆ·æ“ä½œ
- **å®‰å…¨äº‹ä»¶**: è®°å½•å¼‚å¸¸è¡Œä¸º

## ğŸš€ APIæ¥å£

### è®¤è¯æ¥å£
```typescript
// åŠåŒ¿åè®¤è¯
POST /api/uuid/auth/semi-anonymous
{
  "identityA": "13812345678",
  "identityB": "1234",
  "deviceInfo": {...}
}

// å…¨åŒ¿åè®¤è¯
POST /api/uuid/auth/anonymous
{
  "deviceInfo": {...}
}

// ç®¡ç†å‘˜è®¤è¯
POST /api/uuid/auth/admin
{
  "username": "admin",
  "password": "password",
  "userType": "admin"
}

// ä¼šè¯éªŒè¯
POST /api/uuid/auth/validate
{
  "sessionToken": "token"
}

// ç”¨æˆ·ç™»å‡º
POST /api/uuid/auth/logout
{
  "sessionToken": "token"
}
```

### ç”¨æˆ·ç®¡ç†æ¥å£
```typescript
// è·å–ç”¨æˆ·ä¿¡æ¯
GET /api/uuid/users/{uuid}

// æ›´æ–°ç”¨æˆ·ä¿¡æ¯
PATCH /api/uuid/users/{uuid}

// å…³è”ç”¨æˆ·å†…å®¹
POST /api/uuid/content/link

// è·å–ç”¨æˆ·å†…å®¹
GET /api/uuid/users/{uuid}/content

// ç”¨æˆ·ç»Ÿè®¡
GET /api/uuid/statistics
```

## ğŸ§ª æµ‹è¯•

### å•å…ƒæµ‹è¯•
- **UUIDç”Ÿæˆå’Œè§£æ**: æµ‹è¯•UUIDæ ¼å¼å’Œè§£æé€»è¾‘
- **A+BéªŒè¯**: æµ‹è¯•è¾“å…¥æ ¼å¼éªŒè¯
- **æƒé™ç³»ç»Ÿ**: æµ‹è¯•æƒé™æ£€æŸ¥é€»è¾‘
- **åŠ å¯†åŠŸèƒ½**: æµ‹è¯•å“ˆå¸Œå’ŒåŠ å¯†å‡½æ•°

### é›†æˆæµ‹è¯•
- **è®¤è¯æµç¨‹**: æµ‹è¯•å®Œæ•´çš„ç™»å½•æµç¨‹
- **èº«ä»½åˆ‡æ¢**: æµ‹è¯•èº«ä»½å†²çªå¤„ç†
- **æƒé™æ§åˆ¶**: æµ‹è¯•æƒé™æ£€æŸ¥é›†æˆ
- **ç»„ä»¶äº¤äº’**: æµ‹è¯•UIç»„ä»¶é›†æˆ

### è¿è¡Œæµ‹è¯•
```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
npm run test

# è¿è¡Œç‰¹å®šæµ‹è¯•
npm run test uuid-system

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
npm run test:coverage
```

## ğŸ“ˆ ç»Ÿè®¡åŠŸèƒ½

### 1. ç”¨æˆ·ç»Ÿè®¡
- **æ¯æ—¥æ–°å¢ç”¨æˆ·**: æŒ‰ç”¨æˆ·ç±»å‹ç»Ÿè®¡
- **æ´»è·ƒç”¨æˆ·**: æŒ‰æ—¶é—´æ®µç»Ÿè®¡
- **ç”¨æˆ·åˆ†å¸ƒ**: æŒ‰ç±»å‹å’Œåœ°åŒºç»Ÿè®¡

### 2. å†…å®¹ç»Ÿè®¡
- **æäº¤ç»Ÿè®¡**: æŒ‰å†…å®¹ç±»å‹ç»Ÿè®¡
- **å®¡æ ¸ç»Ÿè®¡**: å®¡æ ¸é€šè¿‡ç‡å’Œæ•ˆç‡
- **ä¸‹è½½ç»Ÿè®¡**: çƒ­é—¨å†…å®¹æ’è¡Œ

### 3. æ€§èƒ½ç›‘æ§
- **APIå“åº”æ—¶é—´**: æ¥å£æ€§èƒ½ç›‘æ§
- **æ•°æ®åº“æ€§èƒ½**: æŸ¥è¯¢æ•ˆç‡ç›‘æ§
- **ç”¨æˆ·è¡Œä¸º**: æ“ä½œè·¯å¾„åˆ†æ

## ğŸ”§ éƒ¨ç½²é…ç½®

### ç¯å¢ƒå˜é‡
```bash
# æ•°æ®åº“é…ç½®
DATABASE_URL=mysql://user:pass@host:port/db

# JWTå¯†é’¥
JWT_SECRET=your-secret-key

# ä¼šè¯é…ç½®
SESSION_TIMEOUT_ANONYMOUS=86400
SESSION_TIMEOUT_SEMI_ANONYMOUS=86400
SESSION_TIMEOUT_REVIEWER=3600
SESSION_TIMEOUT_ADMIN=3600

# å®‰å…¨é…ç½®
MAX_FAILED_ATTEMPTS=5
LOCKOUT_DURATION=900
```

### æ•°æ®åº“è¿ç§»
```bash
# è¿è¡Œè¿ç§»
npm run migrate

# å›æ»šè¿ç§»
npm run migrate:rollback

# é‡ç½®æ•°æ®åº“
npm run migrate:reset
```

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### å‰ç«¯ä½¿ç”¨
```typescript
import { useUniversalAuthStore } from '@/stores/universalAuthStore';

// ç»„ä»¶ä¸­ä½¿ç”¨
const { 
  currentUser, 
  loginSemiAnonymous, 
  loginAnonymous, 
  hasPermission 
} = useUniversalAuthStore();

// åŠåŒ¿åç™»å½•
await loginSemiAnonymous('13812345678', '1234');

// æƒé™æ£€æŸ¥
if (hasPermission(Permission.DOWNLOAD_CONTENT)) {
  // æ˜¾ç¤ºä¸‹è½½æŒ‰é’®
}
```

### åç«¯ä½¿ç”¨
```typescript
import { createUUIDRoutes } from './routes/uuid';

// æ·»åŠ åˆ°åº”ç”¨
app.route('/api/uuid', createUUIDRoutes());
```

## ğŸ”„ ç»´æŠ¤å’Œç›‘æ§

### 1. å®šæœŸä»»åŠ¡
- **ä¼šè¯æ¸…ç†**: æ¯å°æ—¶æ¸…ç†è¿‡æœŸä¼šè¯
- **æ—¥å¿—æ¸…ç†**: æ¯å¤©æ¸…ç†æ—§æ—¥å¿—
- **ç»Ÿè®¡æ›´æ–°**: æ¯å¤©æ›´æ–°ç»Ÿè®¡ç¼“å­˜

### 2. ç›‘æ§æŒ‡æ ‡
- **è®¤è¯æˆåŠŸç‡**: ç›‘æ§è®¤è¯å¤±è´¥ç‡
- **ä¼šè¯æ´»è·ƒåº¦**: ç›‘æ§ç”¨æˆ·æ´»è·ƒæƒ…å†µ
- **ç³»ç»Ÿæ€§èƒ½**: ç›‘æ§APIå“åº”æ—¶é—´

### 3. æ•…éšœå¤„ç†
- **æ•°æ®å¤‡ä»½**: å®šæœŸå¤‡ä»½ç”¨æˆ·æ•°æ®
- **æ•…éšœæ¢å¤**: å¿«é€Ÿæ¢å¤æœºåˆ¶
- **å®‰å…¨å“åº”**: å®‰å…¨äº‹ä»¶å¤„ç†æµç¨‹

## ğŸ“ æ›´æ–°æ—¥å¿—

### v1.0.0 (2025-01-27)
- âœ… å®ŒæˆUUIDç”¨æˆ·ç®¡ç†ç³»ç»ŸåŸºç¡€æ¶æ„
- âœ… å®ç°5ç§ç”¨æˆ·ç±»å‹è®¤è¯
- âœ… å®Œæˆå‰åç«¯APIé›†æˆ
- âœ… æ·»åŠ å®Œæ•´çš„æµ‹è¯•è¦†ç›–
- âœ… å®ç°èº«ä»½å†²çªå¤„ç†æœºåˆ¶
- âœ… å®Œæˆæ•°æ®åº“è®¾è®¡å’Œè¿ç§»
- âœ… æ·»åŠ å®‰å…¨ç‰¹æ€§å’Œå®¡è®¡æ—¥å¿—

## ğŸ¤ è´¡çŒ®æŒ‡å—

1. **ä»£ç è§„èŒƒ**: éµå¾ªé¡¹ç›®ä»£ç è§„èŒƒ
2. **æµ‹è¯•è¦æ±‚**: æ–°åŠŸèƒ½å¿…é¡»åŒ…å«æµ‹è¯•
3. **æ–‡æ¡£æ›´æ–°**: æ›´æ–°ç›¸å…³æ–‡æ¡£
4. **å®‰å…¨å®¡æŸ¥**: å®‰å…¨ç›¸å…³ä»£ç éœ€è¦å®¡æŸ¥

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿæˆ–æäº¤Issueã€‚
