# æ•°æ®åˆ†æé¡µé¢é—®é¢˜å…¨é¢åˆ†ææŠ¥å‘Š

## ğŸ“‹ é—®é¢˜ç°çŠ¶

### ç”¨æˆ·æŠ¥å‘Šçš„é”™è¯¯
```
Failed to load resource: net::ERR_CONNECTION_REFUSED
:8787/api/universal-questionnaire/statistics/employment-survey-2024?include_test_data=true
```

### é”™è¯¯å‘ç”Ÿä½ç½®
- **é¡µé¢**: `/analytics` (NewQuestionnaireVisualizationPage)
- **æœåŠ¡**: `questionnaireVisualizationService.getDataSourceInfo()`
- **APIè°ƒç”¨**: `http://localhost:8787/api/universal-questionnaire/statistics/employment-survey-2024`

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### 1. æ•°æ®æºé…ç½®é—®é¢˜

**å½“å‰é…ç½®** (`frontend/src/config/dataSourceConfig.ts`):
```typescript
CURRENT_SOURCE: 'mock' as DataSourceType,
FORCE_MOCK_IN_DEV: true,
```

**é—®é¢˜**: `NewQuestionnaireVisualizationPage` ä¸­çš„ `getDataSourceInfo()` æ–¹æ³•**æ²¡æœ‰æ£€æŸ¥æ•°æ®æºé…ç½®**ï¼Œç›´æ¥è°ƒç”¨çœŸå®APIã€‚

### 2. APIç«¯ç‚¹é…ç½®é—®é¢˜

**å½“å‰é…ç½®** (`frontend/src/config/apiConfig.ts`):
```typescript
BASE_URL: import.meta.env.VITE_API_BASE_URL || 'http://localhost:8787',
```

**é—®é¢˜**: 
- å¼€å‘ç¯å¢ƒé»˜è®¤ä½¿ç”¨ `localhost:8787`
- æœ¬åœ°æ²¡æœ‰è¿è¡Œåç«¯æœåŠ¡
- å¯¼è‡´ `ERR_CONNECTION_REFUSED`

### 3. æœåŠ¡æ–¹æ³•ä¸ä¸€è‡´

**é—®é¢˜å¯¹æ¯”**:

| æœåŠ¡æ–¹æ³• | æ˜¯å¦æ£€æŸ¥æ•°æ®æº | çŠ¶æ€ |
|---------|--------------|------|
| `getVisualizationSummary()` | âœ… æ˜¯ | æ­£å¸¸ |
| `getDimensionData()` | âœ… æ˜¯ | æ­£å¸¸ |
| `getAllDimensionsData()` | âœ… æ˜¯ | æ­£å¸¸ |
| **`getDataSourceInfo()`** | âŒ å¦ | **é”™è¯¯** |

## ğŸ—ï¸ é¡¹ç›®æ¶æ„åˆ†æ

### é—®å·ç³»ç»Ÿæ¶æ„

```
é¡¹ç›®åŒ…å«3ä¸ªé—®å·ç³»ç»Ÿ:
â”œâ”€â”€ é—®å·1 (questionnaire-v1-2024)
â”‚   â”œâ”€â”€ API: /api/questionnaire-v1/*
â”‚   â”œâ”€â”€ æ•°æ®åº“è¡¨: questionnaire_responses
â”‚   â””â”€â”€ ç”¨é€”: ä¼ ç»Ÿé—®å·ç³»ç»Ÿ
â”‚
â”œâ”€â”€ é—®å·2 (questionnaire-v2-2024)
â”‚   â”œâ”€â”€ API: /api/questionnaire-v2/*
â”‚   â”œâ”€â”€ æ•°æ®åº“è¡¨: questionnaire_v2_responses
â”‚   â””â”€â”€ ç”¨é€”: æ™ºèƒ½é—®å·ç³»ç»Ÿï¼ˆç»æµå‹åŠ›+å°±ä¸šä¿¡å¿ƒï¼‰
â”‚
â””â”€â”€ Universal Questionnaire (employment-survey-2024)
    â”œâ”€â”€ API: /api/universal-questionnaire/*
    â”œâ”€â”€ æ•°æ®åº“è¡¨: questionnaire_submissions
    â””â”€â”€ ç”¨é€”: ç»Ÿä¸€é—®å·æ¥å£
```

### æ•°æ®å¯è§†åŒ–æœåŠ¡æ¶æ„

```
å‰ç«¯å¯è§†åŒ–æœåŠ¡:
â”œâ”€â”€ questionnaireVisualizationService (é—®å·1æ•°æ®)
â”‚   â”œâ”€â”€ æ•°æ®æº: universal-questionnaire API
â”‚   â”œâ”€â”€ æ¨¡æ‹Ÿæ•°æ®: mockVisualizationService
â”‚   â””â”€â”€ ä½¿ç”¨é¡µé¢: NewQuestionnaireVisualizationPage
â”‚
â”œâ”€â”€ questionnaire2VisualizationService (é—®å·2æ•°æ®)
â”‚   â”œâ”€â”€ æ•°æ®æº: questionnaire-v2 API
â”‚   â”œâ”€â”€ æ¨¡æ‹Ÿæ•°æ®: questionnaire2MockVisualizationData
â”‚   â””â”€â”€ ä½¿ç”¨é¡µé¢: SecondQuestionnaireAnalyticsPage
â”‚
â””â”€â”€ hybridVisualizationService (æ··åˆæ•°æ®)
    â”œâ”€â”€ ä¾èµ–: questionnaire2VisualizationService
    â”œâ”€â”€ è½¬æ¢: Questionnaire1StyleAdapter
    â””â”€â”€ ä½¿ç”¨é¡µé¢: SecondQuestionnaireAnalyticsPage
```

### APIç«¯ç‚¹æ˜ å°„

**ç”Ÿäº§ç¯å¢ƒ**:
```
https://employment-survey-api-prod.chrismarker89.workers.dev
â”œâ”€â”€ /api/questionnaire-v1/*
â”œâ”€â”€ /api/questionnaire-v2/*
â””â”€â”€ /api/universal-questionnaire/*
```

**å¼€å‘ç¯å¢ƒ**:
```
http://localhost:8787 (éœ€è¦æœ¬åœ°å¯åŠ¨åç«¯)
â”œâ”€â”€ /api/questionnaire-v1/*
â”œâ”€â”€ /api/questionnaire-v2/*
â””â”€â”€ /api/universal-questionnaire/*
```

## ğŸ¯ ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: ä¿®å¤ `getDataSourceInfo()` æ–¹æ³•ï¼ˆæ¨èï¼‰

**ä¿®æ”¹æ–‡ä»¶**: `frontend/src/services/questionnaireVisualizationService.ts`

**ä¿®æ”¹å†…å®¹**:
```typescript
async getDataSourceInfo(): Promise<{
  source: string;
  totalResponses: number;
  dataQuality: any;
  lastUpdated: string;
  availableDimensions: string[];
}> {
  // âœ… æ·»åŠ æ•°æ®æºæ£€æŸ¥
  if (useMockData()) {
    console.log('ğŸ“Š ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ® - æ•°æ®æºä¿¡æ¯');
    return {
      source: 'mock',
      totalResponses: 1247,
      dataQuality: {
        completionRate: 89.3,
        validityScore: 94.7,
        consistencyScore: 91.2
      },
      lastUpdated: new Date().toISOString(),
      availableDimensions: getAllFrontendDimensionIds()
    };
  }

  // åŸæœ‰çš„APIè°ƒç”¨é€»è¾‘...
  try {
    const response = await fetch(`${this.universalQuestionnaireUrl}/statistics/employment-survey-2024?include_test_data=true`);
    // ...
  } catch (error) {
    console.error('è·å–æ•°æ®æºä¿¡æ¯å¤±è´¥:', error);
    throw error;
  }
}
```

### æ–¹æ¡ˆ2: ä¿®æ”¹ `NewQuestionnaireVisualizationPage`

**ä¿®æ”¹æ–‡ä»¶**: `frontend/src/pages/analytics/NewQuestionnaireVisualizationPage.tsx`

**ä¿®æ”¹å†…å®¹**:
```typescript
const loadVisualizationData = async () => {
  try {
    setLoading(true);
    setError(null);

    // è·å–å…¼å®¹æ€§æŠ¥å‘Š
    const compatReport = getCompatibilityReport();
    setCompatibilityReport(compatReport);

    // âœ… æ·»åŠ æ•°æ®æºæ£€æŸ¥
    if (useMockData()) {
      console.log('ğŸ“Š ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®æ¨¡å¼');
      // è·³è¿‡ getDataSourceInfo è°ƒç”¨
      setDataQuality({
        completionRate: 89.3,
        validityScore: 94.7,
        consistencyScore: 91.2
      });
    } else {
      // åªåœ¨ä½¿ç”¨çœŸå®APIæ—¶è°ƒç”¨
      const dataSourceInfo = await questionnaireVisualizationService.getDataSourceInfo();
      setDataQuality(dataSourceInfo.dataQuality);
    }

    // åŠ è½½æ‘˜è¦æ•°æ®ï¼ˆå·²ç»æœ‰æ•°æ®æºæ£€æŸ¥ï¼‰
    const summaryData = await questionnaireVisualizationService.getVisualizationSummary();
    setSummary(summaryData);

    // ...
  } catch (error) {
    // ...
  }
};
```

### æ–¹æ¡ˆ3: ä¿®æ”¹APIé…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

**ä¿®æ”¹æ–‡ä»¶**: `frontend/src/config/apiConfig.ts`

**ä¿®æ”¹å†…å®¹**:
```typescript
export const API_CONFIG = {
  // âœ… å¼€å‘ç¯å¢ƒä½¿ç”¨ç”Ÿäº§APIï¼Œé¿å…æœ¬åœ°åç«¯ä¾èµ–
  BASE_URL: import.meta.env.VITE_API_BASE_URL || 
    (import.meta.env.DEV 
      ? 'https://employment-survey-api-prod.chrismarker89.workers.dev'
      : 'https://employment-survey-api-prod.chrismarker89.workers.dev'
    ),
  // ...
};
```

## ğŸ“Š æ¨èä¿®å¤æ­¥éª¤

### ç¬¬ä¸€æ­¥: ä¿®å¤ `getDataSourceInfo()` æ–¹æ³•
è¿™æ˜¯æœ€æ ¹æœ¬çš„ä¿®å¤ï¼Œç¡®ä¿æ‰€æœ‰æœåŠ¡æ–¹æ³•éƒ½éµå¾ªæ•°æ®æºé…ç½®ã€‚

### ç¬¬äºŒæ­¥: éªŒè¯å…¶ä»–æœåŠ¡æ–¹æ³•
æ£€æŸ¥æ‰€æœ‰å¯è§†åŒ–æœåŠ¡ä¸­æ˜¯å¦è¿˜æœ‰å…¶ä»–æ–¹æ³•æ²¡æœ‰æ£€æŸ¥æ•°æ®æºé…ç½®ã€‚

### ç¬¬ä¸‰æ­¥: æ·»åŠ ä¸€é”®å¯¼å‡ºåŠŸèƒ½
ä¸ºæµ‹è¯•é¡µé¢æ·»åŠ å¯¼å‡ºåŠŸèƒ½ï¼Œæ–¹ä¾¿ç”¨æˆ·åé¦ˆé—®é¢˜ã€‚

## ğŸ”§ å®æ–½è®¡åˆ’

1. **ç«‹å³ä¿®å¤**: ä¿®æ”¹ `getDataSourceInfo()` æ–¹æ³•
2. **æµ‹è¯•éªŒè¯**: æœ¬åœ°æµ‹è¯• + ç”Ÿäº§ç¯å¢ƒæµ‹è¯•
3. **éƒ¨ç½²ä¸Šçº¿**: æ„å»ºå¹¶éƒ¨ç½²åˆ°Cloudflare Pages
4. **ç”¨æˆ·éªŒè¯**: æä¾›æµ‹è¯•é“¾æ¥ç»™ç”¨æˆ·ç¡®è®¤

## ğŸ“ é¢„æœŸç»“æœ

ä¿®å¤å:
- âœ… `/analytics` é¡µé¢æ­£å¸¸åŠ è½½
- âœ… ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®å±•ç¤º
- âœ… æ— APIè¿æ¥é”™è¯¯
- âœ… æ‰€æœ‰å›¾è¡¨æ­£å¸¸æ˜¾ç¤º
- âœ… æ•°æ®è´¨é‡æŠ¥å‘Šæ­£å¸¸æ˜¾ç¤º

## ğŸ‰ æ€»ç»“

**æ ¹æœ¬åŸå› **: `getDataSourceInfo()` æ–¹æ³•æ²¡æœ‰éµå¾ªæ•°æ®æºé…ç½®ï¼Œç›´æ¥è°ƒç”¨APIå¯¼è‡´è¿æ¥é”™è¯¯ã€‚

**è§£å†³æ–¹æ¡ˆ**: åœ¨æ–¹æ³•ä¸­æ·»åŠ æ•°æ®æºæ£€æŸ¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®æ—¶è¿”å›æ¨¡æ‹Ÿçš„æ•°æ®æºä¿¡æ¯ã€‚

**å½±å“èŒƒå›´**: ä»…å½±å“ `/analytics` é¡µé¢çš„æ•°æ®æºä¿¡æ¯æ˜¾ç¤ºï¼Œä¸å½±å“å…¶ä»–åŠŸèƒ½ã€‚

**ä¿®å¤éš¾åº¦**: ä½ - åªéœ€æ·»åŠ å‡ è¡Œä»£ç å³å¯ä¿®å¤ã€‚
