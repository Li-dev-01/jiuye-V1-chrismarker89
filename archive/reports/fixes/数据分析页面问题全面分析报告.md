# 数据分析页面问题全面分析报告

## 📋 问题现状

### 用户报告的错误
```
Failed to load resource: net::ERR_CONNECTION_REFUSED
:8787/api/universal-questionnaire/statistics/employment-survey-2024?include_test_data=true
```

### 错误发生位置
- **页面**: `/analytics` (NewQuestionnaireVisualizationPage)
- **服务**: `questionnaireVisualizationService.getDataSourceInfo()`
- **API调用**: `http://localhost:8787/api/universal-questionnaire/statistics/employment-survey-2024`

## 🔍 根本原因分析

### 1. 数据源配置问题

**当前配置** (`frontend/src/config/dataSourceConfig.ts`):
```typescript
CURRENT_SOURCE: 'mock' as DataSourceType,
FORCE_MOCK_IN_DEV: true,
```

**问题**: `NewQuestionnaireVisualizationPage` 中的 `getDataSourceInfo()` 方法**没有检查数据源配置**，直接调用真实API。

### 2. API端点配置问题

**当前配置** (`frontend/src/config/apiConfig.ts`):
```typescript
BASE_URL: import.meta.env.VITE_API_BASE_URL || 'http://localhost:8787',
```

**问题**: 
- 开发环境默认使用 `localhost:8787`
- 本地没有运行后端服务
- 导致 `ERR_CONNECTION_REFUSED`

### 3. 服务方法不一致

**问题对比**:

| 服务方法 | 是否检查数据源 | 状态 |
|---------|--------------|------|
| `getVisualizationSummary()` | ✅ 是 | 正常 |
| `getDimensionData()` | ✅ 是 | 正常 |
| `getAllDimensionsData()` | ✅ 是 | 正常 |
| **`getDataSourceInfo()`** | ❌ 否 | **错误** |

## 🏗️ 项目架构分析

### 问卷系统架构

```
项目包含3个问卷系统:
├── 问卷1 (questionnaire-v1-2024)
│   ├── API: /api/questionnaire-v1/*
│   ├── 数据库表: questionnaire_responses
│   └── 用途: 传统问卷系统
│
├── 问卷2 (questionnaire-v2-2024)
│   ├── API: /api/questionnaire-v2/*
│   ├── 数据库表: questionnaire_v2_responses
│   └── 用途: 智能问卷系统（经济压力+就业信心）
│
└── Universal Questionnaire (employment-survey-2024)
    ├── API: /api/universal-questionnaire/*
    ├── 数据库表: questionnaire_submissions
    └── 用途: 统一问卷接口
```

### 数据可视化服务架构

```
前端可视化服务:
├── questionnaireVisualizationService (问卷1数据)
│   ├── 数据源: universal-questionnaire API
│   ├── 模拟数据: mockVisualizationService
│   └── 使用页面: NewQuestionnaireVisualizationPage
│
├── questionnaire2VisualizationService (问卷2数据)
│   ├── 数据源: questionnaire-v2 API
│   ├── 模拟数据: questionnaire2MockVisualizationData
│   └── 使用页面: SecondQuestionnaireAnalyticsPage
│
└── hybridVisualizationService (混合数据)
    ├── 依赖: questionnaire2VisualizationService
    ├── 转换: Questionnaire1StyleAdapter
    └── 使用页面: SecondQuestionnaireAnalyticsPage
```

### API端点映射

**生产环境**:
```
https://employment-survey-api-prod.chrismarker89.workers.dev
├── /api/questionnaire-v1/*
├── /api/questionnaire-v2/*
└── /api/universal-questionnaire/*
```

**开发环境**:
```
http://localhost:8787 (需要本地启动后端)
├── /api/questionnaire-v1/*
├── /api/questionnaire-v2/*
└── /api/universal-questionnaire/*
```

## 🎯 修复方案

### 方案1: 修复 `getDataSourceInfo()` 方法（推荐）

**修改文件**: `frontend/src/services/questionnaireVisualizationService.ts`

**修改内容**:
```typescript
async getDataSourceInfo(): Promise<{
  source: string;
  totalResponses: number;
  dataQuality: any;
  lastUpdated: string;
  availableDimensions: string[];
}> {
  // ✅ 添加数据源检查
  if (useMockData()) {
    console.log('📊 使用模拟数据 - 数据源信息');
    return {
      source: 'mock',
      totalResponses: 1247,
      dataQuality: {
        completionRate: 89.3,
        validityScore: 94.7,
        consistencyScore: 91.2
      },
      lastUpdated: new Date().toISOString(),
      availableDimensions: getAllFrontendDimensionIds()
    };
  }

  // 原有的API调用逻辑...
  try {
    const response = await fetch(`${this.universalQuestionnaireUrl}/statistics/employment-survey-2024?include_test_data=true`);
    // ...
  } catch (error) {
    console.error('获取数据源信息失败:', error);
    throw error;
  }
}
```

### 方案2: 修改 `NewQuestionnaireVisualizationPage`

**修改文件**: `frontend/src/pages/analytics/NewQuestionnaireVisualizationPage.tsx`

**修改内容**:
```typescript
const loadVisualizationData = async () => {
  try {
    setLoading(true);
    setError(null);

    // 获取兼容性报告
    const compatReport = getCompatibilityReport();
    setCompatibilityReport(compatReport);

    // ✅ 添加数据源检查
    if (useMockData()) {
      console.log('📊 使用模拟数据模式');
      // 跳过 getDataSourceInfo 调用
      setDataQuality({
        completionRate: 89.3,
        validityScore: 94.7,
        consistencyScore: 91.2
      });
    } else {
      // 只在使用真实API时调用
      const dataSourceInfo = await questionnaireVisualizationService.getDataSourceInfo();
      setDataQuality(dataSourceInfo.dataQuality);
    }

    // 加载摘要数据（已经有数据源检查）
    const summaryData = await questionnaireVisualizationService.getVisualizationSummary();
    setSummary(summaryData);

    // ...
  } catch (error) {
    // ...
  }
};
```

### 方案3: 修改API配置（生产环境）

**修改文件**: `frontend/src/config/apiConfig.ts`

**修改内容**:
```typescript
export const API_CONFIG = {
  // ✅ 开发环境使用生产API，避免本地后端依赖
  BASE_URL: import.meta.env.VITE_API_BASE_URL || 
    (import.meta.env.DEV 
      ? 'https://employment-survey-api-prod.chrismarker89.workers.dev'
      : 'https://employment-survey-api-prod.chrismarker89.workers.dev'
    ),
  // ...
};
```

## 📊 推荐修复步骤

### 第一步: 修复 `getDataSourceInfo()` 方法
这是最根本的修复，确保所有服务方法都遵循数据源配置。

### 第二步: 验证其他服务方法
检查所有可视化服务中是否还有其他方法没有检查数据源配置。

### 第三步: 添加一键导出功能
为测试页面添加导出功能，方便用户反馈问题。

## 🔧 实施计划

1. **立即修复**: 修改 `getDataSourceInfo()` 方法
2. **测试验证**: 本地测试 + 生产环境测试
3. **部署上线**: 构建并部署到Cloudflare Pages
4. **用户验证**: 提供测试链接给用户确认

## 📝 预期结果

修复后:
- ✅ `/analytics` 页面正常加载
- ✅ 使用模拟数据展示
- ✅ 无API连接错误
- ✅ 所有图表正常显示
- ✅ 数据质量报告正常显示

## 🎉 总结

**根本原因**: `getDataSourceInfo()` 方法没有遵循数据源配置，直接调用API导致连接错误。

**解决方案**: 在方法中添加数据源检查，使用模拟数据时返回模拟的数据源信息。

**影响范围**: 仅影响 `/analytics` 页面的数据源信息显示，不影响其他功能。

**修复难度**: 低 - 只需添加几行代码即可修复。
