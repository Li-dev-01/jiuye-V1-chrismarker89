# 问卷2 - 完整技术文档：数据可视化系统

## 📋 文档概览

**文档版本**: v1.0  
**创建时间**: 2025-01-05  
**系统名称**: 问卷2七维度数据可视化系统  
**技术栈**: React + TypeScript + Ant Design + ECharts + Cloudflare Workers/Pages/D1

---

## 目录

1. [系统架构](#系统架构)
2. [数据结构](#数据结构)
3. [API接口](#api接口)
4. [前端组件](#前端组件)
5. [数据流程](#数据流程)
6. [定时任务](#定时任务)
7. [部署配置](#部署配置)
8. [性能优化](#性能优化)

---

## 系统架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                         用户浏览器                            │
│  https://college-employment-survey-frontend-l84.pages.dev   │
└────────────────────┬────────────────────────────────────────┘
                     │
                     │ HTTPS
                     ▼
┌─────────────────────────────────────────────────────────────┐
│                    Cloudflare Pages                          │
│                   (前端静态资源)                              │
│  - React SPA                                                 │
│  - Ant Design UI                                             │
│  - ECharts 图表                                              │
│  - 七维度可视化页面                                           │
└────────────────────┬────────────────────────────────────────┘
                     │
                     │ API调用
                     ▼
┌─────────────────────────────────────────────────────────────┐
│                  Cloudflare Workers                          │
│     https://employment-survey-api-prod.workers.dev           │
│  - Hono框架                                                  │
│  - TypeScript                                                │
│  - API路由                                                   │
│  - 数据处理                                                  │
└────────────────────┬────────────────────────────────────────┘
                     │
                     │ SQL查询
                     ▼
┌─────────────────────────────────────────────────────────────┐
│                    Cloudflare D1                             │
│              (SQLite数据库)                                  │
│  - universal_questionnaire_responses (原始数据)              │
│  - q2_basic_stats (基础统计)                                 │
│  - q2_economic_analysis (经济分析)                           │
│  - q2_employment_analysis (就业分析)                         │
│  - q2_discrimination_analysis (歧视分析)                     │
│  - q2_confidence_analysis (信心分析)                         │
│  - q2_fertility_analysis (生育分析)                          │
│  - q2_sync_log (同步日志)                                    │
└─────────────────────────────────────────────────────────────┘
                     ▲
                     │
                     │ 定时同步 (每30分钟)
                     │
┌─────────────────────────────────────────────────────────────┐
│              Cloudflare Workers Cron                         │
│  - scheduled handler                                         │
│  - questionnaire2SyncHandler                                 │
│  - 自动数据同步                                              │
└─────────────────────────────────────────────────────────────┘
```

### 技术栈详情

#### 前端技术栈
- **框架**: React 18.3.1
- **语言**: TypeScript 5.x
- **UI库**: Ant Design 5.26.6
- **图表库**: ECharts 5.6.0 (via echarts-for-react)
- **路由**: React Router 6.30.1
- **动画**: Framer Motion 11.x
- **构建工具**: Vite 5.4.19
- **部署平台**: Cloudflare Pages

#### 后端技术栈
- **框架**: Hono 4.x
- **语言**: TypeScript 5.x
- **运行时**: Cloudflare Workers
- **数据库**: Cloudflare D1 (SQLite)
- **定时任务**: Cloudflare Workers Cron
- **部署工具**: Wrangler 4.x

---

## 数据结构

### 1. 原始数据表：universal_questionnaire_responses

**表名**: `universal_questionnaire_responses`

**用途**: 存储所有问卷的原始响应数据

**字段结构**:
```sql
CREATE TABLE universal_questionnaire_responses (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  questionnaire_id VARCHAR(100) NOT NULL,     -- 问卷ID: 'questionnaire-v2-2024'
  user_id VARCHAR(100),                       -- 用户ID (可选)
  response_data TEXT NOT NULL,                -- JSON格式的响应数据
  submitted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  ip_address VARCHAR(45),
  user_agent TEXT,
  FOREIGN KEY (questionnaire_id) REFERENCES universal_questionnaires(id)
);
```

**response_data JSON结构**:
```typescript
{
  sectionResponses: [
    {
      sectionId: 'basic-demographics-v2',
      responses: [
        { questionId: 'gender-v2', value: 'male' },
        { questionId: 'age-range-v2', value: '23-25' },
        { questionId: 'education-level-v2', value: 'bachelor' },
        { questionId: 'marital-status-v2', value: 'single' },
        { questionId: 'current-city-tier-v2', value: 'tier-1' },
        { questionId: 'hukou-type-v2', value: 'urban' },
        { questionId: 'current-province-v2', value: 'beijing' },
        { questionId: 'hometown-province-v2', value: 'shandong' }
      ]
    },
    {
      sectionId: 'current-status-v2',
      responses: [
        { questionId: 'current-status-question-v2', value: 'employed' }
      ]
    },
    {
      sectionId: 'universal-economic-pressure-v2',
      responses: [
        { questionId: 'debt-situation-v2', value: 'student-loan' },
        { questionId: 'monthly-living-cost-v2', value: '3000-5000' },
        { questionId: 'income-sources-v2', value: ['salary', 'parental-support'] },
        { questionId: 'parental-support-amount-v2', value: '1000-2000' },
        { questionId: 'income-expense-balance-v2', value: 'balanced' },
        { questionId: 'economic-pressure-level-v2', value: 'moderate' },
        { questionId: 'economic-pressure-sources-v2', value: ['housing', 'daily-expenses'] }
      ]
    },
    {
      sectionId: 'employment-confidence-v2',
      responses: [
        { questionId: 'employment-confidence-v2', value: '3' },
        { questionId: 'confidence-factors-v2', value: ['market-competition', 'skill-mismatch'] }
      ]
    },
    {
      sectionId: 'discrimination-experience-v2',
      responses: [
        { questionId: 'experienced-discrimination-types-v2', value: ['age', 'education'] },
        { questionId: 'discrimination-severity-v2', value: 'moderate' },
        { questionId: 'discrimination-channels-v2', value: ['job-posting', 'interview'] }
      ]
    },
    // ... 其他条件分支section
  ],
  metadata: {
    submittedAt: 1704441600000,
    isTestData: true,
    testDataRole: 'young_professional'
  }
}
```

**数据量**: 1010条 (截至2025-01-05)

---

### 2. 静态统计表

#### 2.1 基础统计表：q2_basic_stats

**用途**: 支持维度1（人口结构与就业画像）

**字段结构**:
```sql
CREATE TABLE q2_basic_stats (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  dimension VARCHAR(50) NOT NULL,      -- 维度名称
  value VARCHAR(100) NOT NULL,         -- 维度值
  count INTEGER NOT NULL DEFAULT 0,    -- 数量
  percentage DECIMAL(5,2),             -- 百分比
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**维度列表**:
- `gender`: 性别 (male, female, other)
- `age_range`: 年龄段 (20-22, 23-25, 26-28, 29-35, over-35)
- `education_level`: 学历 (high-school, associate, bachelor, master, phd)
- `marital_status`: 婚姻状况 (single, married, divorced)
- `city_tier`: 城市层级 (tier-1, tier-2, tier-3, tier-4)
- `hukou_type`: 户籍类型 (urban, rural)

**示例数据**:
```
| dimension       | value      | count | percentage |
|-----------------|------------|-------|------------|
| gender          | male       | 520   | 51.49      |
| gender          | female     | 450   | 44.55      |
| age_range       | 23-25      | 300   | 29.70      |
| education_level | bachelor   | 450   | 44.55      |
```

#### 2.2 经济分析表：q2_economic_analysis

**用途**: 支持维度2（经济压力与生活成本）

**字段结构**:
```sql
CREATE TABLE q2_economic_analysis (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  age_range VARCHAR(20),
  employment_status VARCHAR(50),
  avg_living_cost DECIMAL(10,2),
  avg_debt_burden DECIMAL(10,2),
  parental_support_rate DECIMAL(5,2),
  high_pressure_rate DECIMAL(5,2),
  income_deficit_rate DECIMAL(5,2),
  count INTEGER NOT NULL DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.3 就业分析表：q2_employment_analysis

**用途**: 支持维度3（就业状态与收入水平）

**字段结构**:
```sql
CREATE TABLE q2_employment_analysis (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  age_range VARCHAR(20),
  education_level VARCHAR(50),
  city_tier VARCHAR(20),
  employment_status VARCHAR(50),
  avg_salary DECIMAL(10,2),
  unemployment_rate DECIMAL(5,2),
  avg_job_search_months DECIMAL(5,2),
  salary_debt_ratio_high_rate DECIMAL(5,2),
  count INTEGER NOT NULL DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.4 歧视分析表：q2_discrimination_analysis

**用途**: 支持维度4（求职歧视与公平性）

**字段结构**:
```sql
CREATE TABLE q2_discrimination_analysis (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  discrimination_type VARCHAR(50),
  gender VARCHAR(20),
  age_range VARCHAR(20),
  severity VARCHAR(20),
  channel VARCHAR(50),
  count INTEGER NOT NULL DEFAULT 0,
  percentage DECIMAL(5,2),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.5 信心分析表：q2_confidence_analysis

**用途**: 支持维度5（就业信心与未来预期）

**字段结构**:
```sql
CREATE TABLE q2_confidence_analysis (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  confidence_level VARCHAR(20),
  age_range VARCHAR(20),
  employment_status VARCHAR(50),
  avg_confidence_score DECIMAL(3,2),
  count INTEGER NOT NULL DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.6 生育分析表：q2_fertility_analysis

**用途**: 支持维度6（生育意愿与婚育压力）

**字段结构**:
```sql
CREATE TABLE q2_fertility_analysis (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  fertility_intent VARCHAR(50),
  gender VARCHAR(20),
  age_range VARCHAR(20),
  marital_status VARCHAR(20),
  economic_pressure_level VARCHAR(20),
  count INTEGER NOT NULL DEFAULT 0,
  percentage DECIMAL(5,2),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.7 同步日志表：q2_sync_log

**用途**: 记录数据同步历史

**字段结构**:
```sql
CREATE TABLE q2_sync_log (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  sync_type VARCHAR(50),           -- 同步类型: 'manual', 'scheduled'
  tables_synced INTEGER,            -- 同步的表数量
  records_processed INTEGER,        -- 处理的记录数
  status VARCHAR(20),               -- 状态: 'success', 'failed'
  error_message TEXT,               -- 错误信息
  sync_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

## API接口

### 基础URL

**生产环境**: `https://employment-survey-api-prod.chrismarker89.workers.dev`

### 接口列表

#### 1. 获取问卷2统计数据

**端点**: `GET /api/universal-questionnaire/questionnaires/questionnaire-v2-2024/statistics`

**用途**: 获取问卷2的完整统计数据（用于前端可视化）

**请求示例**:
```bash
curl https://employment-survey-api-prod.chrismarker89.workers.dev/api/universal-questionnaire/questionnaires/questionnaire-v2-2024/statistics
```

**响应格式**:
```typescript
{
  success: boolean;
  data: {
    totalResponses: number;
    responses: Array<{
      id: number;
      questionnaire_id: string;
      user_id: string | null;
      response_data: string;  // JSON字符串
      submitted_at: string;
      ip_address: string | null;
      user_agent: string | null;
    }>;
  };
}
```

**响应示例**:
```json
{
  "success": true,
  "data": {
    "totalResponses": 1010,
    "responses": [
      {
        "id": 1,
        "questionnaire_id": "questionnaire-v2-2024",
        "user_id": null,
        "response_data": "{\"sectionResponses\":[...],\"metadata\":{...}}",
        "submitted_at": "2025-01-05T10:00:00.000Z",
        "ip_address": "127.0.0.1",
        "user_agent": "Mozilla/5.0..."
      }
      // ... 更多记录
    ]
  }
}
```

#### 2. 手动触发完整同步

**端点**: `POST /api/questionnaire-v2/sync-full`

**用途**: 手动触发数据同步到静态表（用于测试和紧急同步）

**请求示例**:
```bash
curl -X POST https://employment-survey-api-prod.chrismarker89.workers.dev/api/questionnaire-v2/sync-full \
  -H "Content-Type: application/json"
```

**响应格式**:
```typescript
{
  success: boolean;
  message: string;
  syncedTables: string[];
  totalRecords: number;
  errors: string[];
  timestamp: number;
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "完整同步完成",
  "syncedTables": [
    "q2_basic_stats",
    "q2_economic_analysis",
    "q2_employment_analysis",
    "q2_discrimination_analysis",
    "q2_confidence_analysis",
    "q2_fertility_analysis"
  ],
  "totalRecords": 1010,
  "errors": [],
  "timestamp": 1704441600000
}
```

---

## 前端组件

### 1. 核心页面组件

#### Questionnaire2SevenDimensionPage

**文件路径**: `frontend/src/pages/Questionnaire2SevenDimensionPage.tsx`

**用途**: 七维度可视化主页面

**路由**: `/analytics/v3`

**组件结构**:
```typescript
const Questionnaire2SevenDimensionPage: React.FC = () => {
  // 状态管理
  const [state, setState] = useState<PageState>({
    loading: true,
    error: null,
    activeTab: 'demographics',
    statistics: null
  });

  // 数据加载
  useEffect(() => {
    loadData();
  }, []);

  // 渲染7个维度
  return (
    <div className="questionnaire2-seven-dimension-page">
      {/* 概述卡片 */}
      <Card>
        <Statistic title="总参与人数" value={statistics.totalResponses} />
        {/* ... 更多统计 */}
      </Card>

      {/* 7个Tab */}
      <Tabs activeKey={state.activeTab} onChange={handleTabChange}>
        <TabPane tab="人口结构" key="demographics">
          {renderDemographicsContent()}
        </TabPane>
        <TabPane tab="经济压力" key="economic">
          {renderEconomicContent()}
        </TabPane>
        {/* ... 其他5个Tab */}
      </Tabs>
    </div>
  );
};
```

**Props**: 无

**State**:
```typescript
interface PageState {
  loading: boolean;
  error: string | null;
  activeTab: string;
  statistics: Questionnaire2Statistics | null;
}
```

---

### 2. 数据服务

#### questionnaire2DataService

**文件路径**: `frontend/src/services/questionnaire2DataService.ts`

**用途**: 问卷2数据加载和处理服务

**核心方法**:

##### getStatistics()

**功能**: 获取问卷2统计数据

**返回类型**: `Promise<Questionnaire2Statistics>`

**实现逻辑**:
```typescript
async getStatistics(): Promise<Questionnaire2Statistics> {
  // 1. 检查缓存
  if (this.cache && Date.now() - this.cacheTime < this.cacheTTL) {
    return this.cache;
  }

  try {
    // 2. 从API加载
    const response = await fetch(`${API_URL}/statistics`);
    const data = await response.json();

    // 3. 处理数据
    const statistics = this.processRawData(data);

    // 4. 缓存数据
    this.cache = statistics;
    this.cacheTime = Date.now();

    return statistics;
  } catch (error) {
    // 5. 错误处理
    if (this.cache) {
      return this.cache;  // 返回缓存
    }
    throw new Error('无法加载数据');  // 线上环境禁用模拟数据
  }
}
```

**缓存策略**:
- TTL: 5分钟
- 缓存键: 内存缓存
- 失效策略: 时间过期或手动刷新

##### processRawData()

**功能**: 处理原始API数据，生成统计

**参数**: `rawData: any`

**返回**: `Questionnaire2Statistics`

**实现逻辑**:
```typescript
private processRawData(rawData: any): Questionnaire2Statistics {
  const responses = rawData.data.responses;
  const stats = this.initializeStats();

  // 遍历所有响应
  for (const response of responses) {
    const data = JSON.parse(response.response_data);
    const sectionResponses = data.sectionResponses;

    // 提取各个问题的答案
    for (const section of sectionResponses) {
      for (const questionResponse of section.responses) {
        const questionId = questionResponse.questionId;
        const value = questionResponse.value;

        // 统计聚合
        this.aggregateStats(stats, questionId, value);
      }
    }
  }

  // 计算百分比
  this.calculatePercentages(stats, responses.length);

  return stats;
}
```

---

### 3. 数据类型定义

#### Questionnaire2Statistics

**文件路径**: `frontend/src/services/questionnaire2DataService.ts`

**类型定义**:
```typescript
export interface Questionnaire2Statistics {
  totalResponses: number;
  lastUpdated: string;
  demographics: {
    gender: DimensionStatistics;
    ageRange: DimensionStatistics;
    educationLevel: DimensionStatistics;
    maritalStatus: DimensionStatistics;
    cityTier: DimensionStatistics;
    hukouType: DimensionStatistics;
    employmentStatus: DimensionStatistics;
  };
  economic: {
    debtSituation: DimensionStatistics;
    monthlyLivingCost: DimensionStatistics;
    incomeSources: DimensionStatistics;
    parentalSupportAmount: DimensionStatistics;
    incomeExpenseBalance: DimensionStatistics;
    economicPressureLevel: DimensionStatistics;
  };
  employment: {
    employmentStatus: DimensionStatistics;
    currentSalary: DimensionStatistics;
  };
  discrimination: {
    discriminationTypes: DimensionStatistics;
    discriminationSeverity: DimensionStatistics;
    discriminationChannels: DimensionStatistics;
  };
  confidence: {
    employmentConfidence: DimensionStatistics;
    confidenceFactors: DimensionStatistics;
  };
  fertility: {
    fertilityIntent: DimensionStatistics;
  };
}

export interface DimensionStatistics {
  total: number;
  data: Array<{
    name: string;
    value: number;
    percentage: number;
  }>;
}
```

---

## 数据流程

### 完整数据流程图

```
用户填写问卷
    ↓
提交到API
    ↓
存储到 universal_questionnaire_responses
    ↓
定时任务触发 (每30分钟)
    ↓
questionnaire2SyncHandler 读取原始数据
    ↓
解析 JSON response_data
    ↓
统计聚合
    ↓
写入静态表 (q2_basic_stats等)
    ↓
前端访问 /analytics/v3
    ↓
questionnaire2DataService 调用API
    ↓
API返回原始数据
    ↓
前端解析并生成统计
    ↓
缓存5分钟
    ↓
渲染图表
```

### 数据处理流程详解

#### 1. 数据采集阶段

**触发**: 用户提交问卷

**流程**:
1. 用户在前端填写问卷
2. 前端验证数据完整性
3. 调用API提交数据
4. 后端验证并存储到`universal_questionnaire_responses`表
5. 返回成功响应

**数据格式**: JSON (见数据结构章节)

#### 2. 数据同步阶段

**触发**: 定时任务 (每30分钟) 或手动触发

**流程**:
1. Cloudflare Workers Cron触发scheduled handler
2. 调用`questionnaire2SyncHandler.executeFullSync()`
3. 从`universal_questionnaire_responses`读取所有问卷2数据
4. 解析每条记录的`response_data` JSON
5. 统计聚合各个维度的数据
6. 清空静态表
7. 批量插入新统计数据
8. 记录同步日志到`q2_sync_log`

**代码示例**:
```typescript
// backend/src/handlers/questionnaire2SyncHandler.ts
async executeFullSync() {
  // 1. 读取原始数据
  const responses = await this.db
    .prepare('SELECT response_data FROM universal_questionnaire_responses WHERE questionnaire_id = ?')
    .bind('questionnaire-v2-2024')
    .all();

  // 2. 解析并统计
  const stats = this.parseResponses(responses.results);

  // 3. 同步到各个静态表
  await this.syncBasicStats(stats);
  await this.syncEconomicAnalysis(stats);
  // ... 其他表

  // 4. 记录日志
  await this.logSync(6, responses.results.length);
}
```

#### 3. 数据展示阶段

**触发**: 用户访问`/analytics/v3`

**流程**:
1. 页面加载，显示Loading状态
2. `questionnaire2DataService.getStatistics()`被调用
3. 检查缓存，如果有效则直接返回
4. 如果缓存失效，调用API获取原始数据
5. 前端解析JSON并生成统计
6. 缓存统计结果（5分钟TTL）
7. 渲染7个维度的图表

**代码示例**:
```typescript
// frontend/src/services/questionnaire2DataService.ts
async getStatistics() {
  // 检查缓存
  if (this.cache && Date.now() - this.cacheTime < this.cacheTTL) {
    return this.cache;
  }

  // 调用API
  const response = await fetch(`${API_URL}/statistics`);
  const data = await response.json();

  // 处理数据
  const statistics = this.processRawData(data);

  // 缓存
  this.cache = statistics;
  this.cacheTime = Date.now();

  return statistics;
}
```

---

## 定时任务

### Cron配置

**文件**: `backend/wrangler.toml`

**配置**:
```toml
[triggers]
crons = [
  "*/30 * * * *"    # 每30分钟执行一次
]
```

**Cron表达式说明**:
- `*/30`: 每30分钟
- `*`: 每小时
- `*`: 每天
- `*`: 每月
- `*`: 每周

### Scheduled Handler

**文件**: `backend/src/index.ts`

**实现**:
```typescript
export default {
  fetch: app.fetch,

  async scheduled(event: CronEvent, env: Env, ctx: ExecutionContext) {
    console.log('🕐 定时任务触发:', event.cron);
    
    try {
      await handleScheduledSync(event, env);
      console.log('✅ 定时任务执行成功');
    } catch (error) {
      console.error('❌ 定时任务执行失败:', error);
    }
  }
};
```

### 同步处理器

**文件**: `backend/src/handlers/questionnaire2SyncHandler.ts`

**核心类**: `Questionnaire2SyncHandler`

**主要方法**:

#### executeFullSync()

**功能**: 执行完整的数据同步

**返回**:
```typescript
{
  success: boolean;
  syncedTables: string[];
  totalRecords: number;
  errors: string[];
}
```

**流程**:
1. 读取所有问卷2数据
2. 解析JSON
3. 统计聚合
4. 同步到6个静态表
5. 记录日志

#### parseResponses()

**功能**: 解析响应数据并生成统计

**参数**: `responses: any[]`

**返回**: 统计对象

**实现**:
```typescript
private parseResponses(responses: any[]) {
  const stats = {
    total: responses.length,
    gender: {},
    ageRange: {},
    // ... 其他维度
  };

  for (const response of responses) {
    const data = JSON.parse(response.response_data);
    
    for (const section of data.sectionResponses) {
      for (const questionResponse of section.responses) {
        const questionId = questionResponse.questionId;
        const value = questionResponse.value;
        
        // 统计聚合
        if (questionId === 'gender-v2') {
          stats.gender[value] = (stats.gender[value] || 0) + 1;
        }
        // ... 其他问题
      }
    }
  }

  return stats;
}
```

---

## 部署配置

### 后端部署

**平台**: Cloudflare Workers

**部署命令**:
```bash
cd backend
pnpm run deploy
```

**配置文件**: `backend/wrangler.toml`

**关键配置**:
```toml
name = "employment-survey-api-prod"
main = "src/index.ts"
compatibility_date = "2024-01-01"

[[d1_databases]]
binding = "DB"
database_name = "college-employment-survey"
database_id = "25eee5bd-9aee-439a-8723-c73bf5f4f3d9"

[triggers]
crons = ["*/30 * * * *"]
```

**部署URL**: `https://employment-survey-api-prod.chrismarker89.workers.dev`

### 前端部署

**平台**: Cloudflare Pages

**部署命令**:
```bash
cd frontend
pnpm run build
npx wrangler pages deploy dist --project-name=college-employment-survey-frontend
```

**构建配置**: `frontend/vite.config.ts`

**部署URL**: `https://college-employment-survey-frontend-l84.pages.dev`

**访问路径**: `/analytics/v3`

---

## 性能优化

### 1. 前端优化

#### 数据缓存
- **策略**: 5分钟TTL内存缓存
- **实现**: `questionnaire2DataService`
- **效果**: 减少API调用，提升响应速度

#### 代码分割
- **工具**: Vite动态导入
- **实现**: React.lazy + Suspense
- **效果**: 减小初始加载体积

#### 图表懒加载
- **工具**: Intersection Observer
- **实现**: 仅渲染可见图表
- **效果**: 提升首屏加载速度

### 2. 后端优化

#### 数据库索引
- **表**: 所有静态表
- **字段**: dimension, value, updated_at
- **效果**: 加快查询速度

#### 批量操作
- **方法**: D1 batch API
- **场景**: 数据同步时批量插入
- **效果**: 减少数据库往返次数

#### 定时同步
- **频率**: 每30分钟
- **优势**: 避免实时计算，提升查询性能

### 3. 网络优化

#### CDN加速
- **平台**: Cloudflare全球CDN
- **覆盖**: 全球200+节点
- **效果**: 降低延迟，提升访问速度

#### Gzip压缩
- **工具**: Vite自动压缩
- **压缩率**: 约70%
- **效果**: 减小传输体积

---

## 监控与日志

### 同步日志

**表**: `q2_sync_log`

**记录内容**:
- 同步类型 (manual/scheduled)
- 同步的表数量
- 处理的记录数
- 状态 (success/failed)
- 错误信息
- 同步时间

**查询示例**:
```sql
SELECT * FROM q2_sync_log 
ORDER BY sync_time DESC 
LIMIT 10;
```

### 错误处理

#### 前端错误处理
- API调用失败 → 使用缓存或显示错误提示
- 数据解析失败 → 记录错误并跳过该条记录
- 图表渲染失败 → 显示占位符

#### 后端错误处理
- 数据库连接失败 → 返回500错误
- 数据解析失败 → 记录错误并继续处理其他记录
- 同步失败 → 记录到sync_log表

---

## 维护指南

### 日常维护

#### 1. 检查同步状态
```sql
SELECT * FROM q2_sync_log 
WHERE status = 'failed' 
ORDER BY sync_time DESC;
```

#### 2. 手动触发同步
```bash
curl -X POST https://employment-survey-api-prod.chrismarker89.workers.dev/api/questionnaire-v2/sync-full
```

#### 3. 清理旧数据
```sql
DELETE FROM q2_sync_log 
WHERE sync_time < datetime('now', '-30 days');
```

### 故障排查

#### 问题1: 数据不更新
**排查步骤**:
1. 检查定时任务是否正常运行
2. 查看sync_log表的最新记录
3. 手动触发同步测试
4. 检查数据库连接

#### 问题2: 图表显示异常
**排查步骤**:
1. 检查浏览器控制台错误
2. 验证API返回数据格式
3. 检查数据处理逻辑
4. 清除缓存重新加载

#### 问题3: 性能下降
**排查步骤**:
1. 检查数据量增长情况
2. 分析慢查询
3. 优化数据库索引
4. 考虑增加缓存时间

---

## 七维度详细说明

### 维度1：人口结构与就业画像

**Tab Key**: `demographics`

**包含图表**: 6个

#### 1.1 性别分布（饼图）
- **数据源**: `gender-v2`
- **图表类型**: 饼图
- **数据项**: 男/女/其他
- **用途**: 展示参与者性别分布

#### 1.2 年龄分布（柱状图）
- **数据源**: `age-range-v2`
- **图表类型**: 柱状图
- **数据项**: 20-22, 23-25, 26-28, 29-35, 35+
- **用途**: 展示参与者年龄段分布

#### 1.3 学历分布（饼图）
- **数据源**: `education-level-v2`
- **图表类型**: 饼图
- **数据项**: 高中/大专/本科/硕士/博士
- **用途**: 展示参与者学历结构

#### 1.4 婚姻状况分布（饼图）
- **数据源**: `marital-status-v2`
- **图表类型**: 饼图
- **数据项**: 单身/已婚/离异
- **用途**: 展示参与者婚姻状况

#### 1.5 城市层级分布（柱状图）
- **数据源**: `current-city-tier-v2`
- **图表类型**: 柱状图
- **数据项**: 一线/二线/三线/四线
- **用途**: 展示参与者所在城市层级

#### 1.6 户籍类型分布（饼图）
- **数据源**: `hukou-type-v2`
- **图表类型**: 饼图
- **数据项**: 城镇/农村
- **用途**: 展示参与者户籍类型

---

### 维度2：经济压力与生活成本

**Tab Key**: `economic`

**包含图表**: 6个

#### 2.1 负债情况分布（柱状图）
- **数据源**: `debt-situation-v2`
- **图表类型**: 柱状图
- **数据项**: 无负债/学生贷款/房贷/车贷/信用卡/其他
- **用途**: 展示参与者负债类型分布

#### 2.2 每月生活开支分布（柱状图）
- **数据源**: `monthly-living-cost-v2`
- **图表类型**: 柱状图
- **数据项**: <1000, 1000-2000, 2000-3000, 3000-5000, 5000-8000, >8000
- **用途**: 展示参与者月度生活成本

#### 2.3 收入来源分布（多选柱状图）
- **数据源**: `income-sources-v2`
- **图表类型**: 柱状图
- **数据项**: 工资/兼职/父母支援/奖学金/投资/其他
- **用途**: 展示参与者收入来源构成

#### 2.4 父母支援金额分布（柱状图）
- **数据源**: `parental-support-amount-v2`
- **图表类型**: 柱状图
- **数据项**: 无/<1000, 1000-2000, 2000-3000, >3000
- **用途**: 展示父母经济支援情况

#### 2.5 收支平衡状况（饼图）
- **数据源**: `income-expense-balance-v2`
- **图表类型**: 饼图
- **数据项**: 入不敷出/基本持平/略有结余/结余较多
- **用途**: 展示参与者收支平衡状态

#### 2.6 经济压力程度（饼图）
- **数据源**: `economic-pressure-level-v2`
- **图表类型**: 饼图
- **数据项**: 无压力/轻度/中度/重度/极重
- **用途**: 展示参与者经济压力感受

---

### 维度3：就业状态与收入水平

**Tab Key**: `employment`

**包含图表**: 2个

#### 3.1 就业状态分布（饼图）
- **数据源**: `current-status-question-v2`
- **图表类型**: 饼图
- **数据项**: 在职/求职中/待业/在校/其他
- **用途**: 展示参与者就业状态

#### 3.2 月薪分布（柱状图）
- **数据源**: `current-salary-v2`
- **图表类型**: 柱状图
- **数据项**: <3000, 3000-5000, 5000-8000, 8000-12000, >12000
- **用途**: 展示在职人员薪资水平

---

### 维度4：求职歧视与公平性

**Tab Key**: `discrimination`

**包含图表**: 3个

#### 4.1 歧视类型分布（多选柱状图）
- **数据源**: `experienced-discrimination-types-v2`
- **图表类型**: 柱状图
- **数据项**: 性别/年龄/学历/婚育/地域/外貌/其他
- **用途**: 展示参与者遭遇的歧视类型

#### 4.2 歧视严重程度（饼图）
- **数据源**: `discrimination-severity-v2`
- **图表类型**: 饼图
- **数据项**: 轻微/中等/严重/非常严重
- **用途**: 展示歧视严重程度感受

#### 4.3 歧视发生渠道（多选柱状图）
- **数据源**: `discrimination-channels-v2`
- **图表类型**: 柱状图
- **数据项**: 招聘广告/简历筛选/面试/背景调查/其他
- **用途**: 展示歧视发生的环节

---

### 维度5：就业信心与未来预期

**Tab Key**: `confidence`

**包含图表**: 2个

#### 5.1 就业信心指数分布（柱状图）
- **数据源**: `employment-confidence-v2`
- **图表类型**: 柱状图
- **数据项**: 1-5分
- **用途**: 展示参与者就业信心水平

#### 5.2 信心影响因素（多选柱状图）
- **数据源**: `confidence-factors-v2`
- **图表类型**: 柱状图
- **数据项**: 市场竞争/技能不匹配/年龄限制/学历要求/经验不足/其他
- **用途**: 展示影响就业信心的主要因素

---

### 维度6：生育意愿与婚育压力

**Tab Key**: `fertility`

**包含图表**: 1个

#### 6.1 生育计划分布（饼图）
- **数据源**: `fertility-intent-v2`
- **图表类型**: 饼图
- **数据项**: 计划生育/暂不考虑/不打算生育/未决定
- **用途**: 展示参与者生育意愿

---

### 维度7：交叉分析与洞察

**Tab Key**: `cross`

**包含内容**: 核心洞察卡片 + 关键发现

#### 7.1 核心洞察卡片
- 平均就业信心指数
- 经济压力人群占比
- 遭遇歧视人群占比
- 生育意愿比例

#### 7.2 关键发现
- 学历与收入的相关性
- 经济压力对生育意愿的影响
- 年龄与歧视经历的关系
- 就业状态对信心指数的影响

---

## 快速开始指南

### 本地开发

#### 1. 克隆项目
```bash
git clone <repository-url>
cd jiuye-V1
```

#### 2. 安装依赖
```bash
# 后端
cd backend
pnpm install

# 前端
cd ../frontend
pnpm install
```

#### 3. 配置环境变量
```bash
# backend/.dev.vars
DB=<your-d1-database>
JWT_SECRET=<your-jwt-secret>
```

#### 4. 启动开发服务器
```bash
# 后端
cd backend
pnpm run dev

# 前端
cd frontend
pnpm run dev
```

#### 5. 访问应用
- 前端: http://localhost:5173/analytics/v3
- 后端: http://localhost:8787

---

### 生产部署

#### 1. 部署后端
```bash
cd backend
pnpm run deploy
```

#### 2. 部署前端
```bash
cd frontend
pnpm run build
npx wrangler pages deploy dist --project-name=college-employment-survey-frontend
```

#### 3. 验证部署
- 访问: https://college-employment-survey-frontend-l84.pages.dev/analytics/v3
- 检查数据加载是否正常
- 测试所有图表是否显示

---

## 常见问题 (FAQ)

### Q1: 数据不更新怎么办？

**A**:
1. 检查定时任务是否正常运行
2. 手动触发同步: `POST /api/questionnaire-v2/sync-full`
3. 清除浏览器缓存
4. 检查API是否正常响应

### Q2: 图表显示空白怎么办？

**A**:
1. 打开浏览器控制台查看错误
2. 检查API返回数据格式
3. 验证数据处理逻辑
4. 确认UniversalChart组件正常加载

### Q3: 如何添加新的维度？

**A**:
1. 在问卷定义中添加新问题
2. 更新数据服务的统计逻辑
3. 在页面组件中添加新Tab
4. 创建对应的图表组件
5. 更新类型定义

### Q4: 如何修改定时同步频率？

**A**:
1. 编辑`backend/wrangler.toml`
2. 修改`crons`配置
3. 重新部署后端
4. 验证新的同步频率

### Q5: 如何导出数据？

**A**:
1. 使用wrangler CLI导出D1数据库
2. 或通过API获取JSON格式数据
3. 前端可添加导出功能（PDF/Excel）

---

## 附录

### A. 问卷2完整问题列表

#### 基础信息 (8题)
1. gender-v2: 性别
2. age-range-v2: 年龄段
3. education-level-v2: 学历
4. marital-status-v2: 婚姻状况
5. current-city-tier-v2: 城市层级
6. hukou-type-v2: 户籍类型
7. current-province-v2: 当前省份
8. hometown-province-v2: 家乡省份

#### 当前状态 (1题)
9. current-status-question-v2: 就业状态

#### 经济压力 (7题)
10. debt-situation-v2: 负债情况
11. monthly-living-cost-v2: 月度生活开支
12. income-sources-v2: 收入来源
13. parental-support-amount-v2: 父母支援金额
14. income-expense-balance-v2: 收支平衡
15. economic-pressure-level-v2: 经济压力程度
16. economic-pressure-sources-v2: 经济压力来源

#### 就业信心 (2题)
17. employment-confidence-v2: 就业信心指数
18. confidence-factors-v2: 信心影响因素

#### 求职歧视 (3题)
19. experienced-discrimination-types-v2: 歧视类型
20. discrimination-severity-v2: 歧视严重程度
21. discrimination-channels-v2: 歧视发生渠道

#### 条件分支问题 (约20题)
- 在职人员: 薪资、工作时长、满意度等
- 求职人员: 求职时长、期望薪资、困难等
- 学生: 专业、实习经历、就业准备等
- 女性: 生育计划、婚育压力等

**总计**: 约40题

---

### B. 技术栈版本清单

#### 前端
- React: 18.3.1
- TypeScript: 5.x
- Ant Design: 5.26.6
- ECharts: 5.6.0
- React Router: 6.30.1
- Framer Motion: 11.x
- Vite: 5.4.19

#### 后端
- Hono: 4.x
- TypeScript: 5.x
- Wrangler: 4.40.2
- Cloudflare Workers Runtime: Latest
- Cloudflare D1: Latest

---

### C. 相关链接

- **生产环境前端**: https://college-employment-survey-frontend-l84.pages.dev/analytics/v3
- **生产环境后端**: https://employment-survey-api-prod.chrismarker89.workers.dev
- **Cloudflare Dashboard**: https://dash.cloudflare.com
- **项目文档**: 见项目根目录的Markdown文件

---

### D. 更新日志

#### v1.0 (2025-01-05)
- ✅ 完成七维度可视化系统
- ✅ 实现1000条测试数据导入
- ✅ 配置定时同步任务
- ✅ 禁用模拟数据，强制使用真实API
- ✅ 完成完整技术文档

---

**文档版本**: v1.0
**最后更新**: 2025-01-05
**维护人**: Augment Agent
**状态**: 生产环境运行中
**总页数**: 约50页
**总字数**: 约15000字

