# 问卷2优化 - 逻辑问题分析与修复方案

## 📋 问题发现

**发现时间**: 2025-01-05  
**发现者**: 用户测试反馈  
**问题描述**: 选择"男、18岁以下、未婚"后，仍会出现"是否有子女"的问题，不符合现实逻辑

---

## 🔍 逻辑问题分析

### 问题1：子女问题无条件显示 ⚠️

**当前实现**:
```typescript
{
  id: 'has-children-v2',
  type: 'radio',
  title: '您是否有子女？',
  required: true,
  // ❌ 没有任何 condition 限制
}
```

**逻辑缺陷**:
- ❌ 18岁以下 + 未婚 → 不应该问子女（法定结婚年龄：男22岁、女20岁）
- ❌ 18-22岁 + 未婚 → 不应该问子女（大概率无子女）
- ✅ 已婚/离异/丧偶 → 应该问子女
- ⚠️ 未婚但年龄较大（如30+）→ 可能有子女（非婚生育）

**影响范围**:
- 所有填写者都会被问到
- 造成不必要的困扰
- 降低问卷体验

---

### 问题2：生育计划问题条件不严谨 ⚠️

**当前实现**:
```typescript
{
  id: 'fertility-intent-v2',
  type: 'radio',
  title: '您是否有生育计划？',
  required: false,
  condition: {
    dependsOn: 'gender-v2',
    operator: 'equals',
    value: 'female'
  }
  // ❌ 仅判断性别=女性
}
```

**逻辑缺陷**:
- ❌ 女性 + 已婚有子女 + 不打算再生 → 不应该问生育计划
- ❌ 女性 + 年龄过大（如45+）→ 不应该问生育计划（生育年龄限制）
- ❌ 女性 + 18岁以下 → 不应该问生育计划（未成年）
- ✅ 女性 + 育龄（20-40岁）+ 未婚或已婚无子女 → 应该问生育计划

**影响范围**:
- 所有女性都会被问到
- 对已有多个子女或高龄女性不友好

---

### 问题3：婚育歧视板块触发条件过宽 ⚠️

**当前实现**:
```typescript
{
  id: 'marriage-discrimination-detail-v2',
  title: '婚育与职业发展',
  condition: {
    dependsOn: 'gender-v2',
    operator: 'equals',
    value: 'female'
  }
  // ❌ 仅判断性别=女性
}
```

**逻辑缺陷**:
- ⚠️ 女性 + 18岁以下 → 婚育歧视不太相关（未到婚育年龄）
- ⚠️ 女性 + 50岁以上 → 婚育歧视相关性降低
- ✅ 女性 + 育龄（20-45岁）→ 婚育歧视最相关

**影响范围**:
- 所有女性都会看到婚育歧视板块
- 对未成年或高龄女性相关性较低

---

### 问题4：年龄歧视板块触发条件合理 ✅

**当前实现**:
```typescript
{
  id: 'age-discrimination-detail-v2',
  title: '年龄与职业发展',
  condition: {
    dependsOn: 'age-range-v2',
    operator: 'equals',
    value: '35+'
  }
}
```

**评估**: ✅ 逻辑合理，35+确实是年龄歧视的主要群体

---

## 🛠️ 修复方案

### 方案A：保守修复（推荐）⭐

**原则**: 最小化改动，仅修复明显的逻辑错误

#### 修复1：子女问题增加条件

**修改**: `has-children-v2` 增加条件显示

**逻辑**:
- 仅在以下情况显示：
  - 婚姻状况 = 已婚/离异/丧偶
  - 或：年龄 ≥ 23岁 且 婚姻状况 ≠ 未婚

**实现**:
```typescript
{
  id: 'has-children-v2',
  type: 'radio',
  title: '您是否有子女？',
  required: true,
  condition: {
    type: 'or', // 需要扩展条件系统支持 OR 逻辑
    conditions: [
      {
        dependsOn: 'marital-status-v2',
        operator: 'in',
        value: ['married', 'divorced', 'widowed']
      },
      {
        type: 'and',
        conditions: [
          {
            dependsOn: 'age-range-v2',
            operator: 'in',
            value: ['23-25', '26-28', '29-34', '35+']
          },
          {
            dependsOn: 'marital-status-v2',
            operator: 'not-equals',
            value: 'single'
          }
        ]
      }
    ]
  }
}
```

**问题**: 当前条件系统不支持复杂的 OR/AND 逻辑

**简化方案**（立即可用）:
```typescript
{
  id: 'has-children-v2',
  type: 'radio',
  title: '您是否有子女？',
  required: true,
  condition: {
    dependsOn: 'marital-status-v2',
    operator: 'in',
    value: ['married', 'divorced', 'widowed']
  }
  // 仅对已婚/离异/丧偶显示
}
```

**优点**: 简单、立即可用、覆盖90%的合理场景  
**缺点**: 未婚但有子女的情况无法覆盖（但这是少数）

---

#### 修复2：生育计划问题增加年龄限制

**修改**: `fertility-intent-v2` 增加年龄条件

**简化方案**（立即可用）:
```typescript
{
  id: 'fertility-intent-v2',
  type: 'radio',
  title: '您是否有生育计划？',
  required: false,
  condition: {
    type: 'and',
    conditions: [
      {
        dependsOn: 'gender-v2',
        operator: 'equals',
        value: 'female'
      },
      {
        dependsOn: 'age-range-v2',
        operator: 'in',
        value: ['18-22', '23-25', '26-28', '29-34', '35+'] // 排除18岁以下
      }
    ]
  }
}
```

**问题**: 当前条件系统不支持 AND 逻辑

**更简化方案**（立即可用）:
```typescript
{
  id: 'fertility-intent-v2',
  type: 'radio',
  title: '您是否有生育计划？',
  required: false,
  condition: {
    dependsOn: 'gender-v2',
    operator: 'equals',
    value: 'female'
  }
  // 保持现状，但在选项中增加"已有子女，不打算再生"
}
```

**调整选项**:
```typescript
options: [
  { value: 'yes-soon', label: '是，近期（1-2年内）' },
  { value: 'yes-later', label: '是，但暂无明确时间' },
  { value: 'no', label: '否，暂无生育计划' },
  { value: 'no-already', label: '已有子女，不打算再生' }, // 新增
  { value: 'prefer-not', label: '不愿透露' }
]
```

---

#### 修复3：婚育歧视板块保持现状

**评估**: 虽然对18岁以下女性相关性较低，但不影响填写体验，保持现状

---

### 方案B：完整优化（需扩展条件系统）

**原则**: 扩展条件系统，支持复杂的 AND/OR/NOT 逻辑

#### 扩展条件类型定义

```typescript
export type QuestionCondition = 
  | SimpleCondition
  | ComplexCondition;

export interface SimpleCondition {
  dependsOn: string;
  operator: 'equals' | 'not-equals' | 'in' | 'not-in' | 'greater-than' | 'less-than';
  value: any;
}

export interface ComplexCondition {
  type: 'and' | 'or' | 'not';
  conditions: QuestionCondition[];
}
```

#### 优点
- 支持任意复杂的逻辑组合
- 可精确控制每个问题的显示条件

#### 缺点
- 需要修改类型定义
- 需要修改前端条件判断逻辑
- 工作量较大

---

## 📊 方案对比

| 方案 | 工作量 | 立即可用 | 覆盖率 | 推荐度 |
|------|--------|---------|--------|--------|
| 方案A（保守修复） | 低 | ✅ 是 | 90% | ⭐⭐⭐⭐⭐ |
| 方案B（完整优化） | 高 | ❌ 否 | 100% | ⭐⭐⭐ |

---

## ✅ 推荐执行方案

### 立即修复（方案A）

#### 修复1：子女问题
```typescript
condition: {
  dependsOn: 'marital-status-v2',
  operator: 'in',
  value: ['married', 'divorced', 'widowed']
}
```

#### 修复2：生育计划问题
- 保持条件不变（仅女性）
- 调整选项，增加"已有子女，不打算再生"

#### 修复3：婚育歧视板块
- 保持现状

---

## 🔄 后续优化（可选）

### 阶段1：扩展条件系统（1-2天）
- 支持 AND/OR/NOT 逻辑
- 更新类型定义
- 更新前端条件判断逻辑

### 阶段2：精细化条件控制（1天）
- 子女问题：已婚/离异/丧偶 或 （年龄≥23 且 未婚）
- 生育计划：女性 且 年龄18-45 且 （未婚 或 已婚无子女）
- 婚育歧视：女性 且 年龄20-45

---

## 📝 执行计划

### 立即执行（今天）
1. ✅ 分析问题（已完成）
2. ⏳ 修复子女问题条件
3. ⏳ 调整生育计划选项
4. ⏳ 测试验证
5. ⏳ 部署更新

### 后续优化（本周）
1. 扩展条件系统（如需要）
2. 精细化条件控制（如需要）

---

**文档版本**: v1.0  
**创建时间**: 2025-01-05  
**作者**: Augment Agent  
**状态**: 待用户确认方案

