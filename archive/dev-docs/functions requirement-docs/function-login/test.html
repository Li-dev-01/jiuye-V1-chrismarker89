<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™»å½•åŠŸèƒ½æµ‹è¯•é¡µé¢</title>
    <link rel="stylesheet" href="components/AdminLoginPage.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .test-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        
        .test-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .test-btn:hover {
            background: #f0f0f0;
        }
        
        .test-btn.primary {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .test-btn.primary:hover {
            background: #0056b3;
        }
        
        .test-result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-warning { background: #ffc107; }
        .status-info { background: #17a2b8; }
        
        #login-container {
            max-width: 400px;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <div class="test-header">
        <h1>ğŸ” ç®¡ç†å‘˜ç™»å½•åŠŸèƒ½æµ‹è¯•</h1>
        <p>æµ‹è¯•ç™»å½•åŠŸèƒ½çš„å„é¡¹ç‰¹æ€§å’ŒAPIæ¥å£</p>
    </div>

    <!-- ç™»å½•ç»„ä»¶æµ‹è¯• -->
    <div class="test-section">
        <h3>ğŸ“± ç™»å½•ç»„ä»¶æµ‹è¯•</h3>
        <div class="test-buttons">
            <button class="test-btn primary" onclick="showLoginComponent()">æ˜¾ç¤ºç™»å½•ç»„ä»¶</button>
            <button class="test-btn" onclick="hideLoginComponent()">éšè—ç™»å½•ç»„ä»¶</button>
            <button class="test-btn" onclick="resetLoginComponent()">é‡ç½®ç»„ä»¶</button>
        </div>
        <div id="login-container" style="display: none;"></div>
    </div>

    <!-- APIæµ‹è¯• -->
    <div class="test-section">
        <h3>ğŸ”§ APIæ¥å£æµ‹è¯•</h3>
        <div class="test-buttons">
            <button class="test-btn primary" onclick="testAllAccounts()">æµ‹è¯•æ‰€æœ‰è´¦å·</button>
            <button class="test-btn" onclick="testSingleLogin()">æµ‹è¯•å•ä¸ªç™»å½•</button>
            <button class="test-btn" onclick="testTokenValidation()">æµ‹è¯•TokenéªŒè¯</button>
            <button class="test-btn" onclick="testPermissionCheck()">æµ‹è¯•æƒé™æ£€æŸ¥</button>
        </div>
        <div class="test-result" id="api-test-result">ç­‰å¾…æµ‹è¯•...</div>
    </div>

    <!-- çŠ¶æ€ç›‘æ§ -->
    <div class="test-section">
        <h3>ğŸ“Š çŠ¶æ€ç›‘æ§</h3>
        <div class="test-buttons">
            <button class="test-btn primary" onclick="refreshStatus()">åˆ·æ–°çŠ¶æ€</button>
            <button class="test-btn" onclick="clearAuthState()">æ¸…é™¤è®¤è¯</button>
            <button class="test-btn" onclick="showDebugInfo()">è°ƒè¯•ä¿¡æ¯</button>
        </div>
        <div id="status-display">
            <p><span class="status-indicator status-info"></span>è®¤è¯çŠ¶æ€: <span id="auth-status">æ£€æŸ¥ä¸­...</span></p>
            <p><span class="status-indicator status-info"></span>å½“å‰ç”¨æˆ·: <span id="current-user">æ— </span></p>
            <p><span class="status-indicator status-info"></span>ç”¨æˆ·è§’è‰²: <span id="user-role">æ— </span></p>
            <p><span class="status-indicator status-info"></span>TokençŠ¶æ€: <span id="token-status">æ— </span></p>
        </div>
    </div>

    <!-- é¢„ç½®è´¦å·ä¿¡æ¯ -->
    <div class="test-section">
        <h3>ğŸ‘¥ é¢„ç½®è´¦å·ä¿¡æ¯</h3>
        <div id="accounts-info"></div>
    </div>

    <!-- æµ‹è¯•æ—¥å¿— -->
    <div class="test-section">
        <h3>ğŸ“ æµ‹è¯•æ—¥å¿—</h3>
        <div class="test-buttons">
            <button class="test-btn" onclick="clearTestLog()">æ¸…é™¤æ—¥å¿—</button>
            <button class="test-btn" onclick="exportTestLog()">å¯¼å‡ºæ—¥å¿—</button>
        </div>
        <div class="test-result" id="test-log">æµ‹è¯•æ—¥å¿—å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
    </div>

    <!-- å¼•å…¥è„šæœ¬ -->
    <script src="services/authService.js"></script>
    <script src="services/mockData.js"></script>
    <script src="components/AdminLoginPage.js"></script>

    <script>
        let loginInstance = null;
        let testLog = [];

        // æ·»åŠ æ—¥å¿—
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            testLog.push(logEntry);
            
            const logElement = document.getElementById('test-log');
            logElement.textContent = testLog.slice(-50).join('\n'); // åªæ˜¾ç¤ºæœ€è¿‘50æ¡
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(logEntry);
        }

        // æ˜¾ç¤ºç™»å½•ç»„ä»¶
        function showLoginComponent() {
            const container = document.getElementById('login-container');
            container.style.display = 'block';
            
            if (!loginInstance) {
                loginInstance = new AdminLoginPage({
                    container: '#login-container',
                    redirectEnabled: false,
                    onSuccess: (user) => {
                        addLog(`ç™»å½•æˆåŠŸ: ${user.name} (${user.role})`, 'success');
                        refreshStatus();
                    },
                    onError: (error) => {
                        addLog(`ç™»å½•å¤±è´¥: ${error}`, 'error');
                        refreshStatus();
                    }
                });
                addLog('ç™»å½•ç»„ä»¶å·²åˆ›å»º');
            }
        }

        // éšè—ç™»å½•ç»„ä»¶
        function hideLoginComponent() {
            const container = document.getElementById('login-container');
            container.style.display = 'none';
            addLog('ç™»å½•ç»„ä»¶å·²éšè—');
        }

        // é‡ç½®ç™»å½•ç»„ä»¶
        function resetLoginComponent() {
            if (loginInstance) {
                loginInstance.destroy();
                loginInstance = null;
                addLog('ç™»å½•ç»„ä»¶å·²é”€æ¯');
            }
            
            const container = document.getElementById('login-container');
            container.innerHTML = '';
            container.style.display = 'none';
        }

        // æµ‹è¯•æ‰€æœ‰è´¦å·
        async function testAllAccounts() {
            addLog('å¼€å§‹æµ‹è¯•æ‰€æœ‰é¢„ç½®è´¦å·...');
            const resultElement = document.getElementById('api-test-result');
            let results = [];
            
            const accounts = AuthService.getTestAccountsList();
            
            for (const account of accounts) {
                try {
                    const result = await AuthService.adminLogin(account.username, 'admin123');
                    const status = result.success ? 'âœ…' : 'âŒ';
                    const message = `${status} ${account.name} (${account.username}): ${result.success ? 'æˆåŠŸ' : result.error}`;
                    results.push(message);
                    addLog(message, result.success ? 'success' : 'error');
                    
                    // å¦‚æœç™»å½•æˆåŠŸï¼Œç«‹å³ç™»å‡ºä»¥ä¾¿æµ‹è¯•ä¸‹ä¸€ä¸ªè´¦å·
                    if (result.success) {
                        AuthService.logout();
                    }
                } catch (error) {
                    const message = `âŒ ${account.name}: ${error.message}`;
                    results.push(message);
                    addLog(message, 'error');
                }
            }
            
            resultElement.textContent = results.join('\n');
            addLog('æ‰€æœ‰è´¦å·æµ‹è¯•å®Œæˆ');
            refreshStatus();
        }

        // æµ‹è¯•å•ä¸ªç™»å½•
        async function testSingleLogin() {
            addLog('æµ‹è¯•å•ä¸ªè´¦å·ç™»å½•...');
            try {
                const result = await AuthService.adminLogin('admin1', 'admin123');
                const resultElement = document.getElementById('api-test-result');
                resultElement.textContent = JSON.stringify(result, null, 2);
                
                if (result.success) {
                    addLog(`å•ä¸ªç™»å½•æµ‹è¯•æˆåŠŸ: ${result.data.user.name}`, 'success');
                } else {
                    addLog(`å•ä¸ªç™»å½•æµ‹è¯•å¤±è´¥: ${result.error}`, 'error');
                }
            } catch (error) {
                addLog(`å•ä¸ªç™»å½•æµ‹è¯•å¼‚å¸¸: ${error.message}`, 'error');
            }
            refreshStatus();
        }

        // æµ‹è¯•TokenéªŒè¯
        async function testTokenValidation() {
            addLog('æµ‹è¯•TokenéªŒè¯...');
            const token = AuthService.getCurrentToken();
            
            if (!token) {
                addLog('æ²¡æœ‰å¯ç”¨çš„Tokenï¼Œè¯·å…ˆç™»å½•', 'warning');
                return;
            }
            
            try {
                const result = await AuthService.validateToken(token);
                const resultElement = document.getElementById('api-test-result');
                resultElement.textContent = JSON.stringify(result, null, 2);
                
                if (result.valid) {
                    addLog('TokenéªŒè¯æˆåŠŸ', 'success');
                } else {
                    addLog(`TokenéªŒè¯å¤±è´¥: ${result.error}`, 'error');
                }
            } catch (error) {
                addLog(`TokenéªŒè¯å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•æƒé™æ£€æŸ¥
        function testPermissionCheck() {
            addLog('æµ‹è¯•æƒé™æ£€æŸ¥...');
            const permissions = ['content_review', 'user_management', 'data_analysis', 'system_config'];
            let results = [];
            
            permissions.forEach(permission => {
                const hasPermission = AuthService.hasPermission(permission);
                const status = hasPermission ? 'âœ…' : 'âŒ';
                const message = `${status} ${permission}: ${hasPermission ? 'æœ‰æƒé™' : 'æ— æƒé™'}`;
                results.push(message);
            });
            
            const resultElement = document.getElementById('api-test-result');
            resultElement.textContent = results.join('\n');
            addLog('æƒé™æ£€æŸ¥å®Œæˆ');
        }

        // åˆ·æ–°çŠ¶æ€
        function refreshStatus() {
            const isAuth = AuthService.isAuthenticated();
            const user = AuthService.getCurrentUser();
            const token = AuthService.getCurrentToken();
            
            document.getElementById('auth-status').textContent = isAuth ? 'å·²ç™»å½•' : 'æœªç™»å½•';
            document.getElementById('current-user').textContent = user ? user.name : 'æ— ';
            document.getElementById('user-role').textContent = user ? user.role : 'æ— ';
            document.getElementById('token-status').textContent = token ? 'æœ‰æ•ˆ' : 'æ— ';
            
            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
            const authIndicator = document.querySelector('#status-display .status-indicator');
            authIndicator.className = `status-indicator ${isAuth ? 'status-success' : 'status-error'}`;
            
            addLog(`çŠ¶æ€å·²åˆ·æ–° - è®¤è¯: ${isAuth ? 'æ˜¯' : 'å¦'}, ç”¨æˆ·: ${user ? user.name : 'æ— '}`);
        }

        // æ¸…é™¤è®¤è¯çŠ¶æ€
        function clearAuthState() {
            AuthService.logout();
            refreshStatus();
            addLog('è®¤è¯çŠ¶æ€å·²æ¸…é™¤', 'warning');
        }

        // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
        function showDebugInfo() {
            const debugInfo = {
                authService: !!window.AuthService,
                mockDataService: !!window.MockDataService,
                debugAuth: !!window.debugAuth,
                debugMockData: !!window.debugMockData,
                currentUser: AuthService.getCurrentUser(),
                currentToken: AuthService.getCurrentToken(),
                isAuthenticated: AuthService.isAuthenticated(),
                testAccounts: AuthService.getTestAccountsList()
            };
            
            const resultElement = document.getElementById('api-test-result');
            resultElement.textContent = JSON.stringify(debugInfo, null, 2);
            addLog('è°ƒè¯•ä¿¡æ¯å·²æ˜¾ç¤º');
        }

        // æ¸…é™¤æµ‹è¯•æ—¥å¿—
        function clearTestLog() {
            testLog = [];
            document.getElementById('test-log').textContent = 'æµ‹è¯•æ—¥å¿—å·²æ¸…é™¤';
        }

        // å¯¼å‡ºæµ‹è¯•æ—¥å¿—
        function exportTestLog() {
            const logContent = testLog.join('\n');
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `login-test-log-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            addLog('æµ‹è¯•æ—¥å¿—å·²å¯¼å‡º');
        }

        // æ˜¾ç¤ºé¢„ç½®è´¦å·ä¿¡æ¯
        function showAccountsInfo() {
            const accounts = AuthService.getTestAccountsList();
            const container = document.getElementById('accounts-info');
            
            const html = accounts.map(account => `
                <div style="border: 1px solid #ddd; border-radius: 4px; padding: 10px; margin: 5px 0; background: #f9f9f9;">
                    <strong>${account.name}</strong> (${account.role})
                    <br>
                    <small>ç”¨æˆ·å: ${account.username} | å¯†ç : admin123</small>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            addLog('æµ‹è¯•é¡µé¢å·²åŠ è½½');
            refreshStatus();
            showAccountsInfo();
            
            // å®šæœŸåˆ·æ–°çŠ¶æ€
            setInterval(refreshStatus, 10000);
            
            addLog('è‡ªåŠ¨çŠ¶æ€åˆ·æ–°å·²å¯ç”¨ (æ¯10ç§’)');
        });
    </script>
</body>
</html>
