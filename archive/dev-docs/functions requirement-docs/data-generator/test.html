<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®ç”Ÿæˆå™¨åŠŸèƒ½æµ‹è¯•</title>
    <link rel="stylesheet" href="components/DataGeneratorPanel.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f0f2f5;
            line-height: 1.6;
        }
        
        .test-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        
        .test-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .test-btn:hover {
            background: #f0f0f0;
        }
        
        .test-btn.primary {
            background: #1890ff;
            color: white;
            border-color: #1890ff;
        }
        
        .test-btn.primary:hover {
            background: #40a9ff;
        }
        
        .test-btn.success {
            background: #52c41a;
            color: white;
            border-color: #52c41a;
        }
        
        .test-btn.success:hover {
            background: #73d13d;
        }
        
        .test-result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        .status-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
        }
        
        .status-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #495057;
        }
        
        .status-value {
            font-family: monospace;
            font-size: 12px;
            color: #6c757d;
        }
        
        .log-container {
            max-height: 400px;
            overflow-y: auto;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        
        .log-timestamp {
            color: #569cd6;
        }
        
        .log-level-info {
            color: #4ec9b0;
        }
        
        .log-level-error {
            color: #f44747;
        }
        
        .log-level-success {
            color: #b5cea8;
        }
        
        .log-level-warning {
            color: #dcdcaa;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .metric-label {
            font-size: 12px;
            opacity: 0.9;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #52c41a, #73d13d);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="test-header">
        <h1>ğŸ¤– æ•°æ®ç”Ÿæˆå™¨åŠŸèƒ½æµ‹è¯•</h1>
        <p>æµ‹è¯•æ•°æ®ç”Ÿæˆå™¨çš„å„é¡¹åŠŸèƒ½å’Œæ€§èƒ½æŒ‡æ ‡</p>
    </div>

    <!-- åŸºç¡€åŠŸèƒ½æµ‹è¯• -->
    <div class="test-section">
        <h3>ğŸ“± åŸºç¡€åŠŸèƒ½æµ‹è¯•</h3>
        <div class="test-buttons">
            <button class="test-btn primary" onclick="testDataGeneratorPanel()">æµ‹è¯•æ•°æ®ç”Ÿæˆå™¨é¢æ¿</button>
            <button class="test-btn" onclick="testServiceConnections()">æµ‹è¯•æœåŠ¡è¿æ¥</button>
            <button class="test-btn" onclick="testConfigValidation()">æµ‹è¯•é…ç½®éªŒè¯</button>
        </div>
    </div>

    <!-- AIç”Ÿæˆæµ‹è¯• -->
    <div class="test-section">
        <h3>ğŸ¤– AIç”Ÿæˆæµ‹è¯•</h3>
        <div class="test-buttons">
            <button class="test-btn primary" onclick="testAIGeneration('questionnaire')">æµ‹è¯•é—®å·ç”Ÿæˆ</button>
            <button class="test-btn primary" onclick="testAIGeneration('story')">æµ‹è¯•æ•…äº‹ç”Ÿæˆ</button>
            <button class="test-btn primary" onclick="testAIGeneration('user')">æµ‹è¯•ç”¨æˆ·ç”Ÿæˆ</button>
            <button class="test-btn" onclick="testAIProviderStatus()">æµ‹è¯•AIæä¾›å•†çŠ¶æ€</button>
        </div>
        <div class="test-result" id="ai-test-result">ç­‰å¾…æµ‹è¯•...</div>
    </div>

    <!-- æœ¬åœ°ç”Ÿæˆæµ‹è¯• -->
    <div class="test-section">
        <h3>âš¡ æœ¬åœ°ç”Ÿæˆæµ‹è¯•</h3>
        <div class="test-buttons">
            <button class="test-btn success" onclick="testLocalGeneration('questionnaire')">æµ‹è¯•æœ¬åœ°é—®å·ç”Ÿæˆ</button>
            <button class="test-btn success" onclick="testLocalGeneration('story')">æµ‹è¯•æœ¬åœ°æ•…äº‹ç”Ÿæˆ</button>
            <button class="test-btn success" onclick="testLocalGeneration('user')">æµ‹è¯•æœ¬åœ°ç”¨æˆ·ç”Ÿæˆ</button>
            <button class="test-btn success" onclick="testLocalGeneration('mixed')">æµ‹è¯•æ··åˆæ•°æ®ç”Ÿæˆ</button>
        </div>
        <div class="test-result" id="local-test-result">ç­‰å¾…æµ‹è¯•...</div>
    </div>

    <!-- æ€§èƒ½ç›‘æ§æµ‹è¯• -->
    <div class="test-section">
        <h3>ğŸ“Š æ€§èƒ½ç›‘æ§æµ‹è¯•</h3>
        <div class="test-buttons">
            <button class="test-btn primary" onclick="testPerformanceMonitor()">æµ‹è¯•æ€§èƒ½ç›‘æ§</button>
            <button class="test-btn" onclick="simulateLoad()">æ¨¡æ‹Ÿè´Ÿè½½æµ‹è¯•</button>
            <button class="test-btn" onclick="testErrorHandling()">æµ‹è¯•é”™è¯¯å¤„ç†</button>
            <button class="test-btn" onclick="exportPerformanceData()">å¯¼å‡ºæ€§èƒ½æ•°æ®</button>
        </div>
        
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-value" id="api-response-time">0ms</div>
                <div class="metric-label">APIå“åº”æ—¶é—´</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="success-rate">0%</div>
                <div class="metric-label">æˆåŠŸç‡</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="error-rate">0%</div>
                <div class="metric-label">é”™è¯¯ç‡</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="generation-efficiency">0/s</div>
                <div class="metric-label">ç”Ÿæˆæ•ˆç‡</div>
            </div>
        </div>
        
        <div class="test-result" id="performance-test-result">ç­‰å¾…æµ‹è¯•...</div>
    </div>

    <!-- æ•°æ®éªŒè¯æµ‹è¯• -->
    <div class="test-section">
        <h3>âœ… æ•°æ®éªŒè¯æµ‹è¯•</h3>
        <div class="test-buttons">
            <button class="test-btn primary" onclick="testDataValidation()">æµ‹è¯•æ•°æ®éªŒè¯</button>
            <button class="test-btn" onclick="testDataIntegrity()">æµ‹è¯•æ•°æ®å®Œæ•´æ€§</button>
            <button class="test-btn" onclick="testDataQuality()">æµ‹è¯•æ•°æ®è´¨é‡</button>
            <button class="test-btn" onclick="generateQualityReport()">ç”Ÿæˆè´¨é‡æŠ¥å‘Š</button>
        </div>
        <div class="test-result" id="validation-test-result">ç­‰å¾…æµ‹è¯•...</div>
    </div>

    <!-- ç³»ç»ŸçŠ¶æ€ç›‘æ§ -->
    <div class="test-section">
        <h3>ğŸ“ˆ ç³»ç»ŸçŠ¶æ€ç›‘æ§</h3>
        <div class="test-buttons">
            <button class="test-btn primary" onclick="refreshSystemStatus()">åˆ·æ–°ç³»ç»ŸçŠ¶æ€</button>
            <button class="test-btn" onclick="showDetailedStats()">æ˜¾ç¤ºè¯¦ç»†ç»Ÿè®¡</button>
            <button class="test-btn" onclick="exportSystemData()">å¯¼å‡ºç³»ç»Ÿæ•°æ®</button>
        </div>
        
        <div class="status-grid">
            <div class="status-card">
                <div class="status-title">æœåŠ¡çŠ¶æ€</div>
                <div class="status-value" id="service-status">æ£€æŸ¥ä¸­...</div>
            </div>
            <div class="status-card">
                <div class="status-title">AIæä¾›å•†</div>
                <div class="status-value" id="ai-provider-status">æ£€æŸ¥ä¸­...</div>
            </div>
            <div class="status-card">
                <div class="status-title">æœ¬åœ°ç”Ÿæˆå™¨</div>
                <div class="status-value" id="local-generator-status">æ£€æŸ¥ä¸­...</div>
            </div>
            <div class="status-card">
                <div class="status-title">æ•°æ®åº“è¿æ¥</div>
                <div class="status-value" id="database-status">æ£€æŸ¥ä¸­...</div>
            </div>
            <div class="status-card">
                <div class="status-title">å†…å­˜ä½¿ç”¨</div>
                <div class="status-value" id="memory-usage">æ£€æŸ¥ä¸­...</div>
            </div>
            <div class="status-card">
                <div class="status-title">ç”Ÿæˆä»»åŠ¡</div>
                <div class="status-value" id="active-tasks">æ£€æŸ¥ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- æ‰¹é‡æµ‹è¯• -->
    <div class="test-section">
        <h3>ğŸ”„ æ‰¹é‡æµ‹è¯•</h3>
        <div class="test-buttons">
            <button class="test-btn primary" onclick="runAllTests()">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
            <button class="test-btn" onclick="runStressTest()">å‹åŠ›æµ‹è¯•</button>
            <button class="test-btn" onclick="runCompatibilityTest()">å…¼å®¹æ€§æµ‹è¯•</button>
            <button class="test-btn" onclick="clearAllTests()">æ¸…é™¤æµ‹è¯•ç»“æœ</button>
        </div>
        
        <div class="progress-bar">
            <div class="progress-fill" id="test-progress" style="width: 0%">0%</div>
        </div>
        
        <div class="test-result" id="batch-test-result">ç­‰å¾…æµ‹è¯•...</div>
    </div>

    <!-- æµ‹è¯•æ—¥å¿— -->
    <div class="test-section">
        <h3>ğŸ“ æµ‹è¯•æ—¥å¿—</h3>
        <div class="test-buttons">
            <button class="test-btn" onclick="clearTestLog()">æ¸…é™¤æ—¥å¿—</button>
            <button class="test-btn" onclick="exportTestLog()">å¯¼å‡ºæ—¥å¿—</button>
            <button class="test-btn" onclick="toggleAutoScroll()">åˆ‡æ¢è‡ªåŠ¨æ»šåŠ¨</button>
        </div>
        <div class="log-container" id="test-log">
            <div class="log-entry">
                <span class="log-timestamp">[ç­‰å¾…]</span>
                <span class="log-level-info">INFO</span>
                æµ‹è¯•æ—¥å¿—å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...
            </div>
        </div>
    </div>

    <!-- å¼•å…¥è„šæœ¬ -->
    <script src="services/dataGenerationService.js"></script>
    <script src="services/localGeneratorService.js"></script>
    <script src="utils/performanceMonitor.js"></script>
    <script src="components/DataGeneratorPanel.js"></script>

    <script>
        let testLog = [];
        let autoScroll = true;
        let testResults = {};
        let performanceMonitor = new PerformanceMonitor();

        // æ·»åŠ æ—¥å¿—
        function addLog(message, level = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = {
                timestamp,
                level,
                message,
                time: Date.now()
            };
            
            testLog.push(logEntry);
            
            const logContainer = document.getElementById('test-log');
            const logElement = document.createElement('div');
            logElement.className = 'log-entry';
            logElement.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="log-level-${level}">${level.toUpperCase()}</span>
                ${message}
            `;
            
            logContainer.appendChild(logElement);
            
            // ä¿æŒæœ€è¿‘100æ¡æ—¥å¿—
            const entries = logContainer.querySelectorAll('.log-entry');
            if (entries.length > 100) {
                entries[0].remove();
            }
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            if (autoScroll) {
                logContainer.scrollTop = logContainer.scrollHeight;
            }
            
            console.log(`[${timestamp}] ${level.toUpperCase()}: ${message}`);
        }

        // æµ‹è¯•æ•°æ®ç”Ÿæˆå™¨é¢æ¿
        function testDataGeneratorPanel() {
            addLog('å¼€å§‹æµ‹è¯•æ•°æ®ç”Ÿæˆå™¨é¢æ¿...', 'info');
            
            try {
                // æ£€æŸ¥é¢æ¿æ˜¯å¦æ­£ç¡®åˆå§‹åŒ–
                if (typeof DataGeneratorPanel !== 'undefined') {
                    addLog('âœ… DataGeneratorPanel ç±»å·²åŠ è½½', 'success');
                } else {
                    throw new Error('DataGeneratorPanel ç±»æœªæ‰¾åˆ°');
                }
                
                // æ£€æŸ¥å…¨å±€å®ä¾‹
                if (typeof dataGeneratorPanel !== 'undefined') {
                    addLog('âœ… å…¨å±€å®ä¾‹å·²åˆ›å»º', 'success');
                } else {
                    addLog('âš ï¸ å…¨å±€å®ä¾‹æœªåˆ›å»ºï¼Œå°è¯•æ‰‹åŠ¨åˆ›å»º', 'warning');
                    window.dataGeneratorPanel = new DataGeneratorPanel();
                }
                
                addLog('æ•°æ®ç”Ÿæˆå™¨é¢æ¿æµ‹è¯•å®Œæˆ', 'success');
                
            } catch (error) {
                addLog(`âŒ é¢æ¿æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•æœåŠ¡è¿æ¥
        async function testServiceConnections() {
            addLog('å¼€å§‹æµ‹è¯•æœåŠ¡è¿æ¥...', 'info');
            
            try {
                // æµ‹è¯•æ•°æ®ç”ŸæˆæœåŠ¡
                if (typeof DataGenerationService !== 'undefined') {
                    addLog('âœ… DataGenerationService å·²åŠ è½½', 'success');
                    
                    const templates = await DataGenerationService.getTemplates();
                    addLog(`âœ… è·å–åˆ° ${templates.length} ä¸ªæ¨¡æ¿`, 'success');
                } else {
                    addLog('âŒ DataGenerationService æœªåŠ è½½', 'error');
                }
                
                // æµ‹è¯•æœ¬åœ°ç”ŸæˆæœåŠ¡
                if (typeof LocalGeneratorService !== 'undefined') {
                    addLog('âœ… LocalGeneratorService å·²åŠ è½½', 'success');
                } else {
                    addLog('âŒ LocalGeneratorService æœªåŠ è½½', 'error');
                }
                
                // æµ‹è¯•æ€§èƒ½ç›‘æ§
                if (typeof PerformanceMonitor !== 'undefined') {
                    addLog('âœ… PerformanceMonitor å·²åŠ è½½', 'success');
                } else {
                    addLog('âŒ PerformanceMonitor æœªåŠ è½½', 'error');
                }
                
                addLog('æœåŠ¡è¿æ¥æµ‹è¯•å®Œæˆ', 'success');
                
            } catch (error) {
                addLog(`âŒ æœåŠ¡è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•é…ç½®éªŒè¯
        function testConfigValidation() {
            addLog('å¼€å§‹æµ‹è¯•é…ç½®éªŒè¯...', 'info');
            
            try {
                const testConfigs = [
                    { type: 'questionnaire', count: 15, quality: 'standard' },
                    { type: 'story', count: 8, quality: 'premium' },
                    { type: 'user', count: 14, quality: 'basic' },
                    { type: 'invalid', count: -1, quality: 'unknown' }
                ];
                
                testConfigs.forEach((config, index) => {
                    const result = DataGenerationService.validateConfig(config);
                    const status = result.isValid ? 'âœ…' : 'âŒ';
                    addLog(`${status} é…ç½®${index + 1}: ${result.isValid ? 'æœ‰æ•ˆ' : 'æ— æ•ˆ - ' + result.errors.join(', ')}`, 
                           result.isValid ? 'success' : 'warning');
                });
                
                addLog('é…ç½®éªŒè¯æµ‹è¯•å®Œæˆ', 'success');
                
            } catch (error) {
                addLog(`âŒ é…ç½®éªŒè¯æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•AIç”Ÿæˆ
        async function testAIGeneration(type) {
            addLog(`å¼€å§‹æµ‹è¯•AIç”Ÿæˆ (${type})...`, 'info');
            const resultElement = document.getElementById('ai-test-result');
            
            try {
                const config = {
                    type,
                    count: 3,
                    quality: 'standard',
                    aiProvider: 'openai'
                };
                
                addLog(`å‘é€AIç”Ÿæˆè¯·æ±‚: ${JSON.stringify(config)}`, 'info');
                
                const result = await DataGenerationService.startAIGeneration(config);
                
                if (result.success) {
                    addLog(`âœ… AIç”Ÿæˆä»»åŠ¡å¯åŠ¨æˆåŠŸ: ${result.data?.generationId || 'unknown'}`, 'success');
                    resultElement.textContent = JSON.stringify(result, null, 2);
                } else {
                    addLog(`âŒ AIç”Ÿæˆä»»åŠ¡å¯åŠ¨å¤±è´¥: ${result.error}`, 'error');
                    resultElement.textContent = `é”™è¯¯: ${result.error}`;
                }
                
            } catch (error) {
                addLog(`âŒ AIç”Ÿæˆæµ‹è¯•å¼‚å¸¸: ${error.message}`, 'error');
                resultElement.textContent = `å¼‚å¸¸: ${error.message}`;
            }
        }

        // æµ‹è¯•æœ¬åœ°ç”Ÿæˆ
        async function testLocalGeneration(type) {
            addLog(`å¼€å§‹æµ‹è¯•æœ¬åœ°ç”Ÿæˆ (${type})...`, 'info');
            const resultElement = document.getElementById('local-test-result');
            
            try {
                const config = {
                    type,
                    count: type === 'mixed' ? 20 : 10,
                    features: {
                        includeVoices: true,
                        includeMetadata: true,
                        deidentification: false
                    }
                };
                
                addLog(`å¼€å§‹æœ¬åœ°ç”Ÿæˆ: ${JSON.stringify(config)}`, 'info');
                
                const result = await LocalGeneratorService.generate(config);
                
                if (result.success) {
                    const data = result.data;
                    addLog(`âœ… æœ¬åœ°ç”Ÿæˆå®Œæˆ: é—®å·${data.questionnaires}ä¸ª, æ•…äº‹${data.stories}ä¸ª, ç”¨æˆ·${data.users}ä¸ª, è¯­éŸ³${data.voices}ä¸ª`, 'success');
                    resultElement.textContent = JSON.stringify(result, null, 2);
                    
                    // è®°å½•æ€§èƒ½æŒ‡æ ‡
                    performanceMonitor.recordGenerationTask(type, data.count, data.duration, true);
                } else {
                    addLog(`âŒ æœ¬åœ°ç”Ÿæˆå¤±è´¥: ${result.error}`, 'error');
                    resultElement.textContent = `é”™è¯¯: ${result.error}`;
                }
                
            } catch (error) {
                addLog(`âŒ æœ¬åœ°ç”Ÿæˆæµ‹è¯•å¼‚å¸¸: ${error.message}`, 'error');
                resultElement.textContent = `å¼‚å¸¸: ${error.message}`;
            }
        }

        // æµ‹è¯•æ€§èƒ½ç›‘æ§
        function testPerformanceMonitor() {
            addLog('å¼€å§‹æµ‹è¯•æ€§èƒ½ç›‘æ§...', 'info');
            const resultElement = document.getElementById('performance-test-result');
            
            try {
                // æ¨¡æ‹Ÿä¸€äº›äº‹ä»¶
                performanceMonitor.recordAPICall('/api/test', 1200, true);
                performanceMonitor.recordAPICall('/api/test', 800, true);
                performanceMonitor.recordAPICall('/api/test', 2000, false, 'Timeout');
                performanceMonitor.recordGenerationTask('questionnaire', 10, 5000, true);
                performanceMonitor.recordUserAction('click_generate', { type: 'questionnaire' });
                
                const metrics = performanceMonitor.getMetrics();
                const events = performanceMonitor.getRecentEvents(10);
                
                addLog(`âœ… æ€§èƒ½ç›‘æ§æµ‹è¯•å®Œæˆ: è®°å½•äº†${events.length}ä¸ªäº‹ä»¶`, 'success');
                
                resultElement.textContent = JSON.stringify({
                    metrics,
                    recentEvents: events.length,
                    performanceGrade: performanceMonitor.getPerformanceGrade()
                }, null, 2);
                
                // æ›´æ–°æŒ‡æ ‡æ˜¾ç¤º
                updateMetricsDisplay(metrics);
                
            } catch (error) {
                addLog(`âŒ æ€§èƒ½ç›‘æ§æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                resultElement.textContent = `é”™è¯¯: ${error.message}`;
            }
        }

        // æ›´æ–°æŒ‡æ ‡æ˜¾ç¤º
        function updateMetricsDisplay(metrics) {
            document.getElementById('api-response-time').textContent = `${Math.round(metrics.apiResponseTime)}ms`;
            document.getElementById('success-rate').textContent = `${metrics.successRate.toFixed(1)}%`;
            document.getElementById('error-rate').textContent = `${metrics.errorRate.toFixed(1)}%`;
            document.getElementById('generation-efficiency').textContent = `${metrics.generationEfficiency.toFixed(2)}/s`;
        }

        // æ¨¡æ‹Ÿè´Ÿè½½æµ‹è¯•
        async function simulateLoad() {
            addLog('å¼€å§‹æ¨¡æ‹Ÿè´Ÿè½½æµ‹è¯•...', 'info');
            
            const loadTests = [
                { type: 'questionnaire', count: 5 },
                { type: 'story', count: 3 },
                { type: 'user', count: 8 },
                { type: 'questionnaire', count: 10 },
                { type: 'story', count: 5 }
            ];
            
            for (let i = 0; i < loadTests.length; i++) {
                const test = loadTests[i];
                addLog(`æ‰§è¡Œè´Ÿè½½æµ‹è¯• ${i + 1}/${loadTests.length}: ${test.type} x ${test.count}`, 'info');
                
                try {
                    await testLocalGeneration(test.type);
                    await new Promise(resolve => setTimeout(resolve, 1000)); // ç­‰å¾…1ç§’
                } catch (error) {
                    addLog(`è´Ÿè½½æµ‹è¯• ${i + 1} å¤±è´¥: ${error.message}`, 'error');
                }
            }
            
            addLog('è´Ÿè½½æµ‹è¯•å®Œæˆ', 'success');
        }

        // æµ‹è¯•é”™è¯¯å¤„ç†
        function testErrorHandling() {
            addLog('å¼€å§‹æµ‹è¯•é”™è¯¯å¤„ç†...', 'info');
            
            try {
                // æ¨¡æ‹Ÿå„ç§é”™è¯¯
                performanceMonitor.recordError(new Error('æµ‹è¯•é”™è¯¯1'), 'æµ‹è¯•ä¸Šä¸‹æ–‡1');
                performanceMonitor.recordError(new Error('ç½‘ç»œè¿æ¥å¤±è´¥'), 'APIè°ƒç”¨');
                performanceMonitor.recordError(new Error('é…ç½®éªŒè¯å¤±è´¥'), 'é…ç½®æ£€æŸ¥');
                
                const errorAnalysis = performanceMonitor.getErrorAnalysis();
                
                addLog(`âœ… é”™è¯¯å¤„ç†æµ‹è¯•å®Œæˆ: è®°å½•äº†${errorAnalysis.totalErrors}ä¸ªé”™è¯¯`, 'success');
                
                document.getElementById('performance-test-result').textContent = JSON.stringify(errorAnalysis, null, 2);
                
            } catch (error) {
                addLog(`âŒ é”™è¯¯å¤„ç†æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•AIæä¾›å•†çŠ¶æ€
        async function testAIProviderStatus() {
            addLog('å¼€å§‹æµ‹è¯•AIæä¾›å•†çŠ¶æ€...', 'info');
            
            try {
                const status = await DataGenerationService.getAIProviderStatus();
                
                Object.entries(status).forEach(([provider, info]) => {
                    const statusText = info.status === 'active' ? 'âœ… æ´»è·ƒ' : 
                                     info.status === 'disabled' ? 'âš ï¸ å·²ç¦ç”¨' : 'âŒ æœªæ¿€æ´»';
                    addLog(`${provider}: ${statusText} (å“åº”æ—¶é—´: ${info.responseTime}ms)`, 'info');
                });
                
                document.getElementById('ai-test-result').textContent = JSON.stringify(status, null, 2);
                addLog('AIæä¾›å•†çŠ¶æ€æµ‹è¯•å®Œæˆ', 'success');
                
            } catch (error) {
                addLog(`âŒ AIæä¾›å•†çŠ¶æ€æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•æ•°æ®éªŒè¯
        async function testDataValidation() {
            addLog('å¼€å§‹æµ‹è¯•æ•°æ®éªŒè¯...', 'info');
            const resultElement = document.getElementById('validation-test-result');
            
            try {
                const result = await LocalGeneratorService.verifyData();
                
                if (result.success) {
                    const data = result.data;
                    addLog(`âœ… æ•°æ®éªŒè¯å®Œæˆ: éªŒè¯äº†${data.questionnaires + data.stories + data.users}æ¡æ•°æ®`, 'success');
                    addLog(`éªŒè¯è¯¦æƒ…: æ ¼å¼æ£€æŸ¥${data.validationDetails?.formatCheck}%, å†…å®¹è´¨é‡${data.validationDetails?.contentQuality}%`, 'info');
                    
                    if (data.errors && data.errors.length > 0) {
                        addLog(`âš ï¸ å‘ç°${data.errors.length}ä¸ªé—®é¢˜: ${data.errors.join(', ')}`, 'warning');
                    }
                    
                    resultElement.textContent = JSON.stringify(result, null, 2);
                } else {
                    addLog(`âŒ æ•°æ®éªŒè¯å¤±è´¥: ${result.error}`, 'error');
                    resultElement.textContent = `é”™è¯¯: ${result.error}`;
                }
                
            } catch (error) {
                addLog(`âŒ æ•°æ®éªŒè¯æµ‹è¯•å¼‚å¸¸: ${error.message}`, 'error');
                resultElement.textContent = `å¼‚å¸¸: ${error.message}`;
            }
        }

        // æµ‹è¯•æ•°æ®å®Œæ•´æ€§
        function testDataIntegrity() {
            addLog('å¼€å§‹æµ‹è¯•æ•°æ®å®Œæ•´æ€§...', 'info');
            
            // æ¨¡æ‹Ÿæ•°æ®å®Œæ•´æ€§æ£€æŸ¥
            const testData = [
                { id: 1, type: 'questionnaire', valid: true },
                { id: 2, type: 'story', valid: true },
                { id: 3, type: 'user', valid: false, error: 'ç¼ºå°‘å¿…å¡«å­—æ®µ' },
                { id: 4, type: 'questionnaire', valid: true }
            ];
            
            let validCount = 0;
            let invalidCount = 0;
            
            testData.forEach(item => {
                if (item.valid) {
                    validCount++;
                    addLog(`âœ… æ•°æ®${item.id} (${item.type}): å®Œæ•´`, 'success');
                } else {
                    invalidCount++;
                    addLog(`âŒ æ•°æ®${item.id} (${item.type}): ${item.error}`, 'error');
                }
            });
            
            const integrityRate = (validCount / testData.length) * 100;
            addLog(`æ•°æ®å®Œæ•´æ€§æµ‹è¯•å®Œæˆ: ${integrityRate}% (${validCount}/${testData.length})`, 'success');
            
            document.getElementById('validation-test-result').textContent = JSON.stringify({
                totalChecked: testData.length,
                validCount,
                invalidCount,
                integrityRate: integrityRate.toFixed(1) + '%'
            }, null, 2);
        }

        // æµ‹è¯•æ•°æ®è´¨é‡
        function testDataQuality() {
            addLog('å¼€å§‹æµ‹è¯•æ•°æ®è´¨é‡...', 'info');
            
            // æ¨¡æ‹Ÿè´¨é‡æ£€æŸ¥
            const qualityMetrics = {
                completeness: 92.5,
                formatMatch: 88.3,
                contentQuality: 85.7,
                uniqueness: 94.2,
                reviewPassRate: 85.2
            };
            
            Object.entries(qualityMetrics).forEach(([metric, value]) => {
                const status = value >= 90 ? 'âœ…' : value >= 80 ? 'âš ï¸' : 'âŒ';
                addLog(`${status} ${metric}: ${value}%`, value >= 80 ? 'success' : 'warning');
            });
            
            const overallQuality = Object.values(qualityMetrics).reduce((sum, val) => sum + val, 0) / Object.keys(qualityMetrics).length;
            addLog(`æ€»ä½“è´¨é‡è¯„åˆ†: ${overallQuality.toFixed(1)}%`, 'success');
            
            document.getElementById('validation-test-result').textContent = JSON.stringify({
                ...qualityMetrics,
                overallQuality: overallQuality.toFixed(1) + '%'
            }, null, 2);
        }

        // ç”Ÿæˆè´¨é‡æŠ¥å‘Š
        async function generateQualityReport() {
            addLog('å¼€å§‹ç”Ÿæˆè´¨é‡æŠ¥å‘Š...', 'info');
            
            try {
                const report = await DataGenerationService.getQualityReport('test-generation-id');
                
                addLog(`âœ… è´¨é‡æŠ¥å‘Šç”Ÿæˆå®Œæˆ`, 'success');
                addLog(`æŠ¥å‘Šæ‘˜è¦: å®Œæ•´æ€§${report.completeness}%, æ ¼å¼åŒ¹é…${report.formatMatch}%, å†…å®¹è´¨é‡${report.contentQuality}%`, 'info');
                
                if (report.issues && report.issues.length > 0) {
                    addLog(`å‘ç°é—®é¢˜: ${report.issues.join(', ')}`, 'warning');
                }
                
                if (report.recommendations && report.recommendations.length > 0) {
                    addLog(`æ”¹è¿›å»ºè®®: ${report.recommendations.join(', ')}`, 'info');
                }
                
                document.getElementById('validation-test-result').textContent = JSON.stringify(report, null, 2);
                
            } catch (error) {
                addLog(`âŒ è´¨é‡æŠ¥å‘Šç”Ÿæˆå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åˆ·æ–°ç³»ç»ŸçŠ¶æ€
        async function refreshSystemStatus() {
            addLog('åˆ·æ–°ç³»ç»ŸçŠ¶æ€...', 'info');
            
            try {
                // æ£€æŸ¥å„ä¸ªç»„ä»¶çŠ¶æ€
                const status = {
                    service: typeof DataGenerationService !== 'undefined' ? 'æ­£å¸¸' : 'å¼‚å¸¸',
                    aiProvider: 'OpenAI: æ´»è·ƒ, Grok: å·²ç¦ç”¨, Claude: æœªæ¿€æ´»',
                    localGenerator: typeof LocalGeneratorService !== 'undefined' ? 'æ­£å¸¸' : 'å¼‚å¸¸',
                    database: 'æ¨¡æ‹Ÿè¿æ¥æ­£å¸¸',
                    memory: performance.memory ? `${Math.round((performance.memory.usedJSHeapSize / performance.memory.totalJSHeapSize) * 100)}%` : 'æœªçŸ¥',
                    activeTasks: '0ä¸ªè¿è¡Œä¸­'
                };
                
                // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                document.getElementById('service-status').textContent = status.service;
                document.getElementById('ai-provider-status').textContent = status.aiProvider;
                document.getElementById('local-generator-status').textContent = status.localGenerator;
                document.getElementById('database-status').textContent = status.database;
                document.getElementById('memory-usage').textContent = status.memory;
                document.getElementById('active-tasks').textContent = status.activeTasks;
                
                addLog('ç³»ç»ŸçŠ¶æ€å·²åˆ·æ–°', 'success');
                
            } catch (error) {
                addLog(`âŒ åˆ·æ–°ç³»ç»ŸçŠ¶æ€å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ˜¾ç¤ºè¯¦ç»†ç»Ÿè®¡
        function showDetailedStats() {
            addLog('æ˜¾ç¤ºè¯¦ç»†ç»Ÿè®¡...', 'info');
            
            const stats = performanceMonitor.getEventStats();
            const trend = performanceMonitor.getPerformanceTrend();
            
            addLog(`è¯¦ç»†ç»Ÿè®¡: æ€»äº‹ä»¶${stats.total}ä¸ª, æˆåŠŸ${stats.success}ä¸ª, é”™è¯¯${stats.error}ä¸ª`, 'info');
            addLog(`å¹³å‡æŒç»­æ—¶é—´: ${stats.averageDuration.toFixed(0)}ms`, 'info');
            addLog(`æ€§èƒ½ç­‰çº§: ${performanceMonitor.getPerformanceGrade()}`, 'info');
            
            console.log('è¯¦ç»†ç»Ÿè®¡æ•°æ®:', { stats, trend });
        }

        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        async function runAllTests() {
            addLog('å¼€å§‹è¿è¡Œæ‰€æœ‰æµ‹è¯•...', 'info');
            const progressBar = document.getElementById('test-progress');
            const resultElement = document.getElementById('batch-test-result');
            
            const tests = [
                { name: 'æ•°æ®ç”Ÿæˆå™¨é¢æ¿', func: testDataGeneratorPanel },
                { name: 'æœåŠ¡è¿æ¥', func: testServiceConnections },
                { name: 'é…ç½®éªŒè¯', func: testConfigValidation },
                { name: 'æœ¬åœ°é—®å·ç”Ÿæˆ', func: () => testLocalGeneration('questionnaire') },
                { name: 'æœ¬åœ°æ•…äº‹ç”Ÿæˆ', func: () => testLocalGeneration('story') },
                { name: 'æœ¬åœ°ç”¨æˆ·ç”Ÿæˆ', func: () => testLocalGeneration('user') },
                { name: 'æ€§èƒ½ç›‘æ§', func: testPerformanceMonitor },
                { name: 'æ•°æ®éªŒè¯', func: testDataValidation },
                { name: 'ç³»ç»ŸçŠ¶æ€', func: refreshSystemStatus }
            ];
            
            const results = [];
            
            for (let i = 0; i < tests.length; i++) {
                const test = tests[i];
                const progress = ((i + 1) / tests.length) * 100;
                
                progressBar.style.width = `${progress}%`;
                progressBar.textContent = `${Math.round(progress)}%`;
                
                addLog(`æ‰§è¡Œæµ‹è¯• ${i + 1}/${tests.length}: ${test.name}`, 'info');
                
                try {
                    await test.func();
                    results.push({ name: test.name, status: 'success' });
                    addLog(`âœ… ${test.name} æµ‹è¯•é€šè¿‡`, 'success');
                } catch (error) {
                    results.push({ name: test.name, status: 'failed', error: error.message });
                    addLog(`âŒ ${test.name} æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                }
                
                // ç­‰å¾…ä¸€ä¸‹å†æ‰§è¡Œä¸‹ä¸€ä¸ªæµ‹è¯•
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            const successCount = results.filter(r => r.status === 'success').length;
            const failedCount = results.filter(r => r.status === 'failed').length;
            
            addLog(`æ‰€æœ‰æµ‹è¯•å®Œæˆ: ${successCount}ä¸ªæˆåŠŸ, ${failedCount}ä¸ªå¤±è´¥`, 'success');
            
            resultElement.textContent = JSON.stringify({
                summary: {
                    total: tests.length,
                    success: successCount,
                    failed: failedCount,
                    successRate: ((successCount / tests.length) * 100).toFixed(1) + '%'
                },
                details: results
            }, null, 2);
        }

        // å‹åŠ›æµ‹è¯•
        async function runStressTest() {
            addLog('å¼€å§‹å‹åŠ›æµ‹è¯•...', 'info');
            
            const stressTests = [];
            for (let i = 0; i < 10; i++) {
                stressTests.push(testLocalGeneration('questionnaire'));
            }
            
            try {
                const startTime = Date.now();
                await Promise.all(stressTests);
                const duration = Date.now() - startTime;
                
                addLog(`âœ… å‹åŠ›æµ‹è¯•å®Œæˆ: å¹¶å‘æ‰§è¡Œ10ä¸ªç”Ÿæˆä»»åŠ¡ï¼Œè€—æ—¶${duration}ms`, 'success');
                
            } catch (error) {
                addLog(`âŒ å‹åŠ›æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // å…¼å®¹æ€§æµ‹è¯•
        function runCompatibilityTest() {
            addLog('å¼€å§‹å…¼å®¹æ€§æµ‹è¯•...', 'info');
            
            const features = [
                { name: 'Web Crypto API', test: () => !!(window.crypto && window.crypto.subtle) },
                { name: 'Performance API', test: () => !!window.performance },
                { name: 'Local Storage', test: () => !!window.localStorage },
                { name: 'Session Storage', test: () => !!window.sessionStorage },
                { name: 'Fetch API', test: () => !!window.fetch },
                { name: 'Promise', test: () => !!window.Promise },
                { name: 'Arrow Functions', test: () => { try { eval('() => {}'); return true; } catch { return false; } } },
                { name: 'Async/Await', test: () => { try { eval('async () => {}'); return true; } catch { return false; } } }
            ];
            
            let supportedCount = 0;
            
            features.forEach(feature => {
                const supported = feature.test();
                if (supported) supportedCount++;
                
                const status = supported ? 'âœ…' : 'âŒ';
                addLog(`${status} ${feature.name}: ${supported ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ'}`, supported ? 'success' : 'warning');
            });
            
            const compatibilityRate = (supportedCount / features.length) * 100;
            addLog(`å…¼å®¹æ€§æµ‹è¯•å®Œæˆ: ${compatibilityRate}% (${supportedCount}/${features.length})`, 'success');
            
            document.getElementById('batch-test-result').textContent = JSON.stringify({
                compatibilityRate: compatibilityRate.toFixed(1) + '%',
                supported: supportedCount,
                total: features.length,
                details: features.map(f => ({ name: f.name, supported: f.test() }))
            }, null, 2);
        }

        // æ¸…é™¤æ‰€æœ‰æµ‹è¯•ç»“æœ
        function clearAllTests() {
            document.querySelectorAll('.test-result').forEach(element => {
                element.textContent = 'ç­‰å¾…æµ‹è¯•...';
            });
            
            document.getElementById('test-progress').style.width = '0%';
            document.getElementById('test-progress').textContent = '0%';
            
            // é‡ç½®æŒ‡æ ‡æ˜¾ç¤º
            document.getElementById('api-response-time').textContent = '0ms';
            document.getElementById('success-rate').textContent = '0%';
            document.getElementById('error-rate').textContent = '0%';
            document.getElementById('generation-efficiency').textContent = '0/s';
            
            addLog('æ‰€æœ‰æµ‹è¯•ç»“æœå·²æ¸…é™¤', 'info');
        }

        // å¯¼å‡ºæ€§èƒ½æ•°æ®
        function exportPerformanceData() {
            const data = performanceMonitor.exportData();
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `performance-data-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            addLog('æ€§èƒ½æ•°æ®å·²å¯¼å‡º', 'success');
        }

        // å¯¼å‡ºç³»ç»Ÿæ•°æ®
        function exportSystemData() {
            const data = {
                testResults,
                testLog: testLog.slice(-50),
                performanceData: performanceMonitor.exportData(),
                systemInfo: {
                    userAgent: navigator.userAgent,
                    timestamp: new Date().toISOString(),
                    url: window.location.href
                }
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `system-data-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            addLog('ç³»ç»Ÿæ•°æ®å·²å¯¼å‡º', 'success');
        }

        // æ¸…é™¤æµ‹è¯•æ—¥å¿—
        function clearTestLog() {
            testLog = [];
            document.getElementById('test-log').innerHTML = '<div class="log-entry"><span class="log-timestamp">[æ¸…é™¤]</span><span class="log-level-info">INFO</span>æ—¥å¿—å·²æ¸…é™¤</div>';
            addLog('æ—¥å¿—å·²æ¸…é™¤', 'info');
        }

        // å¯¼å‡ºæµ‹è¯•æ—¥å¿—
        function exportTestLog() {
            const logContent = testLog.map(entry => 
                `[${entry.timestamp}] ${entry.level.toUpperCase()}: ${entry.message}`
            ).join('\n');
            
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `test-log-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            addLog('æµ‹è¯•æ—¥å¿—å·²å¯¼å‡º', 'success');
        }

        // åˆ‡æ¢è‡ªåŠ¨æ»šåŠ¨
        function toggleAutoScroll() {
            autoScroll = !autoScroll;
            addLog(`è‡ªåŠ¨æ»šåŠ¨å·²${autoScroll ? 'å¯ç”¨' : 'ç¦ç”¨'}`, 'info');
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            addLog('æ•°æ®ç”Ÿæˆå™¨åŠŸèƒ½æµ‹è¯•é¡µé¢å·²åŠ è½½', 'success');
            
            // åˆå§‹åŒ–ç³»ç»ŸçŠ¶æ€
            refreshSystemStatus();
            
            // å®šæœŸæ›´æ–°æ€§èƒ½æŒ‡æ ‡
            setInterval(() => {
                const metrics = performanceMonitor.getMetrics();
                updateMetricsDisplay(metrics);
            }, 5000);
            
            addLog('è‡ªåŠ¨æ€§èƒ½ç›‘æ§å·²å¯ç”¨ (æ¯5ç§’æ›´æ–°)', 'info');
        });
    </script>
</body>
</html>
