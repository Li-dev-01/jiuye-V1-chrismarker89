# AlertManageré…ç½®æ–‡ä»¶
# ç”¨äºç®¡ç†å°±ä¸šè°ƒæŸ¥ç³»ç»Ÿçš„å‘Šè­¦é€šçŸ¥

global:
  # SMTPé…ç½®
  smtp_smarthost: 'localhost:587'
  smtp_from: 'alerts@jiuye-system.com'
  smtp_auth_username: 'alerts@jiuye-system.com'
  smtp_auth_password: 'your-email-password'
  
  # é»˜è®¤é€šçŸ¥æ¨¡æ¿
  smtp_hello: 'jiuye-system.com'

# è·¯ç”±é…ç½®
route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'default'
  routes:
    # ä¸¥é‡å‘Šè­¦ç«‹å³é€šçŸ¥
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      repeat_interval: 5m
    
    # å®‰å…¨å‘Šè­¦ç‰¹æ®Šå¤„ç†
    - match:
        service: security
      receiver: 'security-alerts'
      group_wait: 0s
      repeat_interval: 1m
    
    # APIæ€§èƒ½å‘Šè­¦
    - match:
        service: api
      receiver: 'api-alerts'
      repeat_interval: 15m
    
    # ç³»ç»Ÿèµ„æºå‘Šè­¦
    - match:
        service: system
      receiver: 'system-alerts'
      repeat_interval: 30m
    
    # æ•°æ®åº“å‘Šè­¦
    - match:
        service: database
      receiver: 'database-alerts'
      repeat_interval: 10m

# æ¥æ”¶å™¨é…ç½®
receivers:
  # é»˜è®¤æ¥æ”¶å™¨
  - name: 'default'
    email_configs:
      - to: 'admin@jiuye-system.com'
        subject: '[å°±ä¸šè°ƒæŸ¥ç³»ç»Ÿ] {{ .GroupLabels.alertname }}'
        body: |
          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          æè¿°: {{ .Annotations.description }}
          æ ‡ç­¾: {{ range .Labels.SortedPairs }}{{ .Name }}={{ .Value }} {{ end }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

  # ä¸¥é‡å‘Šè­¦æ¥æ”¶å™¨
  - name: 'critical-alerts'
    email_configs:
      - to: 'admin@jiuye-system.com,ops@jiuye-system.com'
        subject: '[ç´§æ€¥] {{ .GroupLabels.alertname }} - å°±ä¸šè°ƒæŸ¥ç³»ç»Ÿ'
        body: |
          ğŸš¨ ä¸¥é‡å‘Šè­¦ ğŸš¨
          
          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          æè¿°: {{ .Annotations.description }}
          ä¸¥é‡çº§åˆ«: {{ .Labels.severity }}
          æœåŠ¡: {{ .Labels.service }}
          å®ä¾‹: {{ .Labels.instance }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          
          è¯·ç«‹å³å¤„ç†ï¼
          {{ end }}
    
    # å¯ä»¥æ·»åŠ Slacké€šçŸ¥
    # slack_configs:
    #   - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
    #     channel: '#alerts'
    #     title: 'ä¸¥é‡å‘Šè­¦ - å°±ä¸šè°ƒæŸ¥ç³»ç»Ÿ'
    #     text: '{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'

  # å®‰å…¨å‘Šè­¦æ¥æ”¶å™¨
  - name: 'security-alerts'
    email_configs:
      - to: 'security@jiuye-system.com,admin@jiuye-system.com'
        subject: '[å®‰å…¨å‘Šè­¦] {{ .GroupLabels.alertname }} - å°±ä¸šè°ƒæŸ¥ç³»ç»Ÿ'
        body: |
          ğŸ”’ å®‰å…¨å‘Šè­¦ ğŸ”’
          
          {{ range .Alerts }}
          äº‹ä»¶ç±»å‹: {{ .Labels.event_type }}
          æè¿°: {{ .Annotations.description }}
          æ¥æºIP: {{ .Labels.source_ip }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          
          è¯·ç«‹å³æ£€æŸ¥ç³»ç»Ÿå®‰å…¨çŠ¶æ€ï¼
          {{ end }}

  # APIå‘Šè­¦æ¥æ”¶å™¨
  - name: 'api-alerts'
    email_configs:
      - to: 'dev@jiuye-system.com'
        subject: '[APIå‘Šè­¦] {{ .GroupLabels.alertname }} - å°±ä¸šè°ƒæŸ¥ç³»ç»Ÿ'
        body: |
          ğŸ“Š APIæ€§èƒ½å‘Šè­¦
          
          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          æè¿°: {{ .Annotations.description }}
          æœåŠ¡: {{ .Labels.job }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

  # ç³»ç»Ÿå‘Šè­¦æ¥æ”¶å™¨
  - name: 'system-alerts'
    email_configs:
      - to: 'ops@jiuye-system.com'
        subject: '[ç³»ç»Ÿå‘Šè­¦] {{ .GroupLabels.alertname }} - å°±ä¸šè°ƒæŸ¥ç³»ç»Ÿ'
        body: |
          ğŸ–¥ï¸ ç³»ç»Ÿèµ„æºå‘Šè­¦
          
          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          æè¿°: {{ .Annotations.description }}
          å®ä¾‹: {{ .Labels.instance }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

  # æ•°æ®åº“å‘Šè­¦æ¥æ”¶å™¨
  - name: 'database-alerts'
    email_configs:
      - to: 'dba@jiuye-system.com,ops@jiuye-system.com'
        subject: '[æ•°æ®åº“å‘Šè­¦] {{ .GroupLabels.alertname }} - å°±ä¸šè°ƒæŸ¥ç³»ç»Ÿ'
        body: |
          ğŸ—„ï¸ æ•°æ®åº“å‘Šè­¦
          
          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          æè¿°: {{ .Annotations.description }}
          æ•°æ®åº“: {{ .Labels.datname }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

# æŠ‘åˆ¶è§„åˆ™
inhibit_rules:
  # å¦‚æœæœåŠ¡å®Œå…¨ä¸‹çº¿ï¼ŒæŠ‘åˆ¶å…¶ä»–ç›¸å…³å‘Šè­¦
  - source_match:
      alertname: ServiceDown
    target_match:
      service: api
    equal: ['instance']
  
  # å¦‚æœæœ‰ä¸¥é‡çš„ç³»ç»Ÿèµ„æºé—®é¢˜ï¼ŒæŠ‘åˆ¶æ€§èƒ½å‘Šè­¦
  - source_match:
      severity: critical
      service: system
    target_match:
      severity: warning
      service: api
    equal: ['instance']

# æ¨¡æ¿é…ç½®
templates:
  - '/etc/alertmanager/templates/*.tmpl'
