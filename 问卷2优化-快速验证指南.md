# 问卷2优化 - 快速验证指南

## 🚀 快速开始

本指南帮助您在5分钟内验证问卷2优化的核心功能。

---

## ✅ 前置检查

### 1. 确认代码变更已应用

```bash
# 检查问卷定义文件
cat backend/src/data/questionnaire2/definition.ts | grep "gender-v2"
# 应输出：id: 'gender-v2',

# 检查可视化映射文件
cat frontend/src/config/questionnaire2VisualizationMapping.ts | grep "discrimination-analysis-v2"
# 应输出：id: 'discrimination-analysis-v2',
```

### 2. 确认文件无语法错误

```bash
# 后端 TypeScript 检查
cd backend
npx tsc --noEmit src/data/questionnaire2/definition.ts

# 前端 TypeScript 检查
cd frontend
npx tsc --noEmit src/config/questionnaire2VisualizationMapping.ts
```

---

## 🧪 快速验证（3个测试用例）

### 测试用例1：女性35+已婚（完整分支）⭐

**目标**：验证所有分支逻辑正确触发

**步骤**：

1. **启动前端**
   ```bash
   cd frontend
   npm run dev
   # 或 pnpm dev
   ```

2. **打开问卷2页面**
   - 访问：`http://localhost:5173/second-questionnaire`（根据实际端口调整）

3. **填写基础信息**
   - 性别：选择"女"
   - 年龄：选择"35岁以上"
   - 学历：任意选择
   - 婚姻状况：选择"已婚"
   - 子女：选择"是"
   - 生育计划：应显示（仅女性），选择"否"
   - 城市层级：选择"一线城市"
   - 户籍：选择"城镇户口"
   - 工作年限：选择"5-10年"

4. **填写当前状态**
   - 选择"待业/求职中"

5. **填写经济压力**
   - 负债情况：选择"信用卡账单"+"支付宝花呗"
   - 月还款：选择"1000-2000元"
   - 经济压力：选择"中等压力"

6. **填写收入状况**（如显示）
   - 跳过（因为选择了待业）

7. **填写求职歧视**
   - 歧视类型：选择"性别歧视"+"婚育状况歧视"+"年龄歧视"
   - 严重度：应显示，选择"中等影响"
   - 渠道：应显示，选择"简历筛选"+"现场面试"
   - 案例：应显示，可选填或跳过

8. **填写个人优势与忧虑**
   - 个人优势：可选填或跳过
   - 就业忧虑：可选填或跳过
   - 支持类型：选择"反歧视保护"+"技能培训"
   - 支持建议：可选填或跳过

9. **填写就业信心**
   - 6个月信心：选择"一般"
   - 1年信心：选择"比较担心"

10. **验证分支板块显示**
    - ✅ **年龄歧视细化板块**应显示（因为年龄=35+）
      - 填写歧视频率、转型意愿、年龄优势
    - ✅ **婚育歧视细化板块**应显示（因为性别=女性）
      - 填写询问频率、影响感知、用工要求
    - ✅ **求职细节板块**应显示（因为状态=待业）
      - 填写求职时长、投递量、转化率、渠道、Offer数量
    - ❌ **学生职业规划板块**不应显示（因为状态≠学生）

11. **提交问卷**
    - 点击提交
    - 验证提交成功

**预期结果**：
- ✅ 生育计划问题仅对女性显示
- ✅ 3个分支板块正确显示（年龄歧视、婚育歧视、求职细节）
- ✅ 歧视严重度与渠道问题在选择歧视类型后显示
- ✅ 所有问题可正常填写与提交
- ✅ 完成时长约10-12分钟

---

### 测试用例2：男性25岁学生（部分分支）

**目标**：验证分支逻辑的条件排除

**步骤**：

1. **填写基础信息**
   - 性别：选择"男"
   - 年龄：选择"23-25岁"
   - 学历：选择"本科"
   - 婚姻状况：选择"未婚"
   - 子女：选择"否"
   - 生育计划：不应显示（因为性别=男）
   - 城市层级：选择"新一线城市"
   - 户籍：选择"城镇户口"
   - 工作年限：选择"1年以下"

2. **填写当前状态**
   - 选择"在校学生"

3. **填写经济压力**
   - 负债情况：选择"助学贷款"
   - 月还款：选择"300-500元"
   - 经济压力：选择"轻微压力"

4. **填写求职歧视**
   - 歧视类型：选择"目前没有任何负债"
   - 严重度：不应显示（因为歧视类型=无）
   - 渠道：不应显示

5. **填写个人优势与忧虑**
   - 支持类型：选择"职业规划"+"技能培训"

6. **填写就业信心**
   - 6个月信心：选择"比较有信心"
   - 1年信心：选择"一般"

7. **验证分支板块显示**
   - ❌ **年龄歧视细化板块**不应显示（因为年龄≠35+）
   - ❌ **婚育歧视细化板块**不应显示（因为性别=男）
   - ❌ **求职细节板块**不应显示（因为状态≠待业）
   - ✅ **学生职业规划板块**应显示（因为状态=学生）
      - 填写实习经验、实习难度、深造意愿、准备情况

8. **提交问卷**

**预期结果**：
- ✅ 生育计划问题不显示（因为性别=男）
- ✅ 仅学生职业规划板块显示
- ✅ 歧视严重度与渠道问题不显示（因为歧视类型=无）
- ✅ 完成时长约6-8分钟

---

### 测试用例3：隐私保护验证

**目标**：验证"不愿透露"选项可正常使用

**步骤**：

1. **填写基础信息**
   - 性别：选择"不愿透露"
   - 年龄：任意选择
   - 学历：任意选择
   - 婚姻状况：选择"不愿透露"
   - 子女：选择"不愿透露"
   - 生育计划：不应显示（因为性别=不愿透露）
   - 城市层级：任意选择
   - 户籍：选择"不愿透露"
   - 工作年限：任意选择

2. **填写其他问题**
   - 正常填写

3. **提交问卷**

**预期结果**：
- ✅ 所有"不愿透露"选项可正常选择
- ✅ 可正常提交
- ✅ 不影响其他问题填写

---

## 📊 数据验证

### 1. 检查数据库存储

```sql
-- 查询最新提交的问卷2数据
SELECT 
  id,
  questionnaire_id,
  created_at,
  JSON_EXTRACT(questionnaire, '$.gender-v2') as gender,
  JSON_EXTRACT(questionnaire, '$.age-range-v2') as age,
  JSON_EXTRACT(questionnaire, '$.experienced-discrimination-types-v2') as discrimination_types
FROM questionnaire_v2_responses
ORDER BY created_at DESC
LIMIT 5;
```

### 2. 检查宽表字段（如已实现）

```sql
-- 查询宽表字段
DESCRIBE questionnaire_v2_responses_wide;

-- 应包含新增字段：
-- gender_v2, marital_status_v2, has_children_v2, 
-- current_city_tier_v2, years_experience_v2,
-- experienced_discrimination_types_v2, discrimination_severity_v2,
-- job_seeking_duration_v2, applications_per_week_v2, etc.
```

---

## 🎨 可视化验证

### 1. 访问问卷2分析页面

```
http://localhost:5173/second-questionnaire-analytics
```

### 2. 检查新增维度图表

- [ ] **基础人口统计**
  - [ ] 性别分布饼图（含图标👨👩🧑🔒）
  - [ ] 婚姻状况饼图
  - [ ] 城市层级柱状图
  - [ ] 工作年限柱状图

- [ ] **求职歧视分析**（如已实现）
  - [ ] 歧视类型柱状图（14种）
  - [ ] 歧视严重度柱状图（5级）
  - [ ] 歧视渠道柱状图（9个）

- [ ] **求职行为分析**（如已实现）
  - [ ] 求职时长柱状图
  - [ ] 投递量柱状图
  - [ ] 转化率柱状图
  - [ ] 渠道使用柱状图
  - [ ] Offer数量柱状图

---

## ⚠️ 常见问题排查

### 问题1：生育计划问题未显示

**原因**：条件逻辑未触发  
**检查**：
1. 确认性别选择为"女"
2. 检查 `condition.dependsOn` 是否正确指向 `gender-v2`
3. 检查前端分支逻辑处理代码

### 问题2：分支板块未显示

**原因**：分支逻辑未触发  
**检查**：
1. 确认触发条件满足（如年龄=35+）
2. 检查 `branchLogic.affectedSections` 配置
3. 检查前端 `useBranchLogic` hook 是否正确处理

### 问题3：提交失败

**原因**：数据验证失败  
**检查**：
1. 查看浏览器控制台错误信息
2. 检查必填字段是否填写
3. 检查后端验证逻辑

### 问题4：可视化图表无数据

**原因**：映射配置或数据提取逻辑问题  
**检查**：
1. 确认 `questionnaire2VisualizationMapping.ts` 配置正确
2. 检查 `questionnaire2VisualizationService.ts` 数据提取逻辑
3. 检查后端分析接口是否返回新字段数据

---

## 📝 验收报告模板

### 快速验证结果

**测试时间**: ___________  
**测试人**: ___________

| 测试用例 | 状态 | 问题描述 |
|---------|------|----------|
| 女性35+已婚（完整分支） | ⬜ 通过 / ⬜ 失败 | |
| 男性25岁学生（部分分支） | ⬜ 通过 / ⬜ 失败 | |
| 隐私保护验证 | ⬜ 通过 / ⬜ 失败 | |

### 分支逻辑验证

| 分支板块 | 触发条件 | 是否正确显示 |
|---------|---------|-------------|
| 生育计划问题 | 性别=女性 | ⬜ 是 / ⬜ 否 |
| 年龄歧视细化 | 年龄=35+ | ⬜ 是 / ⬜ 否 |
| 婚育歧视细化 | 性别=女性 | ⬜ 是 / ⬜ 否 |
| 求职细节 | 状态=待业 | ⬜ 是 / ⬜ 否 |
| 学生职业规划 | 状态=学生 | ⬜ 是 / ⬜ 否 |

### 数据存储验证

- [ ] 新增字段正确入库
- [ ] 复选题数据格式正确
- [ ] 开放题文本完整存储
- [ ] 分支路径记录正确

### 可视化验证

- [ ] 性别分布图显示正确
- [ ] 婚育状况图显示正确
- [ ] 城市层级图显示正确
- [ ] 歧视分析图显示正确（如已实现）
- [ ] 求职行为图显示正确（如已实现）

---

## 🎉 验收通过标准

- ✅ 3个测试用例全部通过
- ✅ 5个分支逻辑正确触发
- ✅ 数据完整入库
- ✅ 可视化图表正常显示（已实现部分）
- ✅ 无阻塞性问题

---

## 📞 需要帮助？

如遇到问题，请查看：
- `问卷2优化-PR1-定义变更摘要.md`（问卷定义详情）
- `问卷2优化-PR2-可视化映射扩展摘要.md`（可视化配置详情）
- `问卷2优化-PR3-端到端验收清单.md`（完整验收清单）
- `问卷2优化-总体执行摘要.md`（整体概览）

---

**文档版本**: v1.0  
**创建时间**: 2025-01-05  
**作者**: Augment Agent

