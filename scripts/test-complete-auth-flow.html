<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>完整认证流程测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1890ff;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-left: 4px solid #1890ff;
            border-radius: 4px;
        }
        .code {
            background: #f1f1f1;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            margin: 10px 0;
            word-break: break-all;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .button:hover {
            background: #40a9ff;
        }
        .success {
            color: #52c41a;
            font-weight: bold;
        }
        .error {
            color: #ff4d4f;
            font-weight: bold;
        }
        .warning {
            color: #fa8c16;
            font-weight: bold;
        }
        .result {
            background: #fff;
            border: 1px solid #d9d9d9;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        .step {
            margin: 10px 0;
            padding: 10px;
            background: #e6f7ff;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 完整认证流程测试</h1>
        
        <div class="section">
            <h3>测试步骤</h3>
            <div class="step">1. 测试修复后的登录API端点</div>
            <div class="step">2. 模拟完整的前端登录流程</div>
            <div class="step">3. 验证认证状态设置</div>
            <div class="step">4. 测试管理员页面数据加载</div>
            <div class="step">5. 验证所有管理功能</div>
        </div>

        <div class="section">
            <h3>1. 测试修复后的登录API</h3>
            <button class="button" onclick="testLoginAPI()">测试登录API</button>
            <div id="loginApiResult" class="result"></div>
        </div>

        <div class="section">
            <h3>2. 模拟前端登录流程</h3>
            <button class="button" onclick="simulateLogin()">模拟完整登录</button>
            <div id="loginFlowResult" class="result"></div>
        </div>

        <div class="section">
            <h3>3. 验证认证状态</h3>
            <button class="button" onclick="verifyAuthState()">验证认证状态</button>
            <div id="authStateResult" class="result"></div>
        </div>

        <div class="section">
            <h3>4. 测试管理员数据加载</h3>
            <button class="button" onclick="testAdminDataLoading()">测试数据加载</button>
            <div id="dataLoadingResult" class="result"></div>
        </div>

        <div class="section">
            <h3>5. 打开修复后的管理页面</h3>
            <button class="button" onclick="openAdminPage()">打开管理页面</button>
            <div id="adminPageResult" class="result"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://employment-survey-api-prod.chrismarker89.workers.dev';
        const ADMIN_URL = 'https://632fb8ff.college-employment-survey-frontend-l84.pages.dev';

        async function testLoginAPI() {
            try {
                // 测试修复后的API端点
                const response = await fetch(`${API_BASE}/api/auth/admin/generate-token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        username: 'admin', 
                        password: 'admin123' 
                    })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('loginApiResult').innerHTML = `
                        <div class="success">✅ 登录API测试成功</div>
                        <div><strong>Token:</strong> ${data.data.token.substring(0, 30)}...</div>
                        <div><strong>用户类型:</strong> ${data.data.userType}</div>
                        <div><strong>用户名:</strong> ${data.data.username}</div>
                        <div><strong>过期时间:</strong> ${data.data.expiresIn}</div>
                    `;
                    return data.data.token;
                } else {
                    throw new Error(data.message || '登录失败');
                }
            } catch (error) {
                document.getElementById('loginApiResult').innerHTML = `
                    <div class="error">❌ 登录API测试失败: ${error.message}</div>
                `;
                return null;
            }
        }

        async function simulateLogin() {
            try {
                // 1. 调用登录API
                const token = await testLoginAPI();
                if (!token) {
                    throw new Error('无法获取token');
                }

                // 2. 模拟前端认证状态设置
                const currentUser = {
                    id: 'admin',
                    username: 'admin',
                    userType: 'SUPER_ADMIN',
                    permissions: ['ALL', 'USER_MANAGEMENT', 'CONTENT_MANAGEMENT', 'SYSTEM_MANAGEMENT']
                };

                const currentSession = {
                    sessionId: 'session_' + Date.now(),
                    userId: 'admin',
                    userType: 'SUPER_ADMIN',
                    expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
                    createdAt: new Date().toISOString()
                };

                // 3. 设置localStorage
                localStorage.setItem('management_auth_token', token);
                localStorage.setItem('management_current_user', JSON.stringify(currentUser));
                localStorage.setItem('management_current_session', JSON.stringify(currentSession));

                document.getElementById('loginFlowResult').innerHTML = `
                    <div class="success">✅ 完整登录流程模拟成功</div>
                    <div><strong>Token已设置:</strong> ${token.substring(0, 30)}...</div>
                    <div><strong>用户信息已设置:</strong> ${currentUser.username} (${currentUser.userType})</div>
                    <div><strong>会话信息已设置:</strong> ${currentSession.sessionId}</div>
                    <div><strong>localStorage键:</strong> ${Object.keys(localStorage).filter(k => k.includes('management')).join(', ')}</div>
                `;

                return true;
            } catch (error) {
                document.getElementById('loginFlowResult').innerHTML = `
                    <div class="error">❌ 登录流程模拟失败: ${error.message}</div>
                `;
                return false;
            }
        }

        function verifyAuthState() {
            try {
                // 检查localStorage中的认证信息
                const authToken = localStorage.getItem('management_auth_token');
                const currentUser = localStorage.getItem('management_current_user');
                const currentSession = localStorage.getItem('management_current_session');

                let parsedUser = null;
                let parsedSession = null;

                try {
                    parsedUser = currentUser ? JSON.parse(currentUser) : null;
                    parsedSession = currentSession ? JSON.parse(currentSession) : null;
                } catch (e) {
                    throw new Error('认证数据解析失败: ' + e.message);
                }

                // 验证会话有效性
                const isSessionValid = parsedSession && new Date(parsedSession.expiresAt) > new Date();
                const isAuthenticated = !!(authToken && parsedUser && parsedSession && isSessionValid);

                const result = {
                    hasToken: !!authToken,
                    hasUser: !!parsedUser,
                    hasSession: !!parsedSession,
                    isSessionValid: isSessionValid,
                    isAuthenticated: isAuthenticated,
                    userType: parsedUser?.userType,
                    permissions: parsedUser?.permissions,
                    sessionExpiry: parsedSession?.expiresAt
                };

                const status = isAuthenticated ? 'success' : 'error';
                const icon = isAuthenticated ? '✅' : '❌';

                document.getElementById('authStateResult').innerHTML = `
                    <div class="${status}">${icon} 认证状态验证结果</div>
                    <div class="code">${JSON.stringify(result, null, 2)}</div>
                    ${isAuthenticated ? 
                        '<div class="success">🎉 认证状态完全正常！管理页面应该能正常加载数据了。</div>' : 
                        '<div class="error">⚠️ 认证状态异常，需要重新登录。</div>'
                    }
                `;

                return isAuthenticated;
            } catch (error) {
                document.getElementById('authStateResult').innerHTML = `
                    <div class="error">❌ 认证状态验证失败: ${error.message}</div>
                `;
                return false;
            }
        }

        async function testAdminDataLoading() {
            try {
                const authToken = localStorage.getItem('management_auth_token');
                if (!authToken) {
                    throw new Error('缺少认证token，请先完成登录流程');
                }

                // 测试所有管理员API
                const apis = [
                    { name: '仪表板统计', url: '/api/admin/dashboard/stats' },
                    { name: '用户列表', url: '/api/admin/users?page=1&pageSize=5' },
                    { name: '审核员列表', url: '/api/admin/reviewers' },
                    { name: '内容标签', url: '/api/admin/content/tags' },
                    { name: '数据库表', url: '/api/admin/database/tables' }
                ];

                let results = [];

                for (const api of apis) {
                    try {
                        const response = await fetch(`${API_BASE}${api.url}`, {
                            headers: {
                                'Authorization': `Bearer ${authToken}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        const data = await response.json();
                        results.push({
                            name: api.name,
                            status: response.status,
                            success: response.ok,
                            dataCount: data.data?.items?.length || data.data?.length || (data.data ? 1 : 0),
                            message: data.message
                        });
                    } catch (error) {
                        results.push({
                            name: api.name,
                            status: 'ERROR',
                            success: false,
                            error: error.message
                        });
                    }
                }

                const allSuccess = results.every(r => r.success);
                const icon = allSuccess ? '✅' : '❌';

                document.getElementById('dataLoadingResult').innerHTML = `
                    <div class="${allSuccess ? 'success' : 'error'}">${icon} 管理员数据加载测试结果</div>
                    <div class="code">${JSON.stringify(results, null, 2)}</div>
                    ${allSuccess ? 
                        '<div class="success">🎉 所有管理员API都正常工作！数据加载完全正常。</div>' : 
                        '<div class="error">⚠️ 部分API调用失败，需要检查具体问题。</div>'
                    }
                `;

                return allSuccess;
            } catch (error) {
                document.getElementById('dataLoadingResult').innerHTML = `
                    <div class="error">❌ 数据加载测试失败: ${error.message}</div>
                `;
                return false;
            }
        }

        async function openAdminPage() {
            try {
                // 确保认证状态正确
                const isAuthenticated = verifyAuthState();
                if (!isAuthenticated) {
                    throw new Error('认证状态异常，请先完成登录流程');
                }

                // 打开管理员页面
                const adminPageUrl = `${ADMIN_URL}/admin`;
                window.open(adminPageUrl, '_blank');

                document.getElementById('adminPageResult').innerHTML = `
                    <div class="success">✅ 已打开修复后的管理员页面</div>
                    <div><strong>页面URL:</strong> ${adminPageUrl}</div>
                    <div class="warning">⚠️ 如果页面仍然显示空白数据，请：</div>
                    <div>1. 刷新页面</div>
                    <div>2. 检查浏览器控制台是否有错误</div>
                    <div>3. 确认localStorage中的认证信息</div>
                    <div>4. 尝试重新登录</div>
                `;
            } catch (error) {
                document.getElementById('adminPageResult').innerHTML = `
                    <div class="error">❌ 打开管理页面失败: ${error.message}</div>
                `;
            }
        }

        // 页面加载时自动运行基础检查
        window.onload = function() {
            verifyAuthState();
        };
    </script>
</body>
</html>
