<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®Œæ•´è®¤è¯æµç¨‹æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1890ff;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-left: 4px solid #1890ff;
            border-radius: 4px;
        }
        .code {
            background: #f1f1f1;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            margin: 10px 0;
            word-break: break-all;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .button:hover {
            background: #40a9ff;
        }
        .success {
            color: #52c41a;
            font-weight: bold;
        }
        .error {
            color: #ff4d4f;
            font-weight: bold;
        }
        .warning {
            color: #fa8c16;
            font-weight: bold;
        }
        .result {
            background: #fff;
            border: 1px solid #d9d9d9;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        .step {
            margin: 10px 0;
            padding: 10px;
            background: #e6f7ff;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ å®Œæ•´è®¤è¯æµç¨‹æµ‹è¯•</h1>
        
        <div class="section">
            <h3>æµ‹è¯•æ­¥éª¤</h3>
            <div class="step">1. æµ‹è¯•ä¿®å¤åçš„ç™»å½•APIç«¯ç‚¹</div>
            <div class="step">2. æ¨¡æ‹Ÿå®Œæ•´çš„å‰ç«¯ç™»å½•æµç¨‹</div>
            <div class="step">3. éªŒè¯è®¤è¯çŠ¶æ€è®¾ç½®</div>
            <div class="step">4. æµ‹è¯•ç®¡ç†å‘˜é¡µé¢æ•°æ®åŠ è½½</div>
            <div class="step">5. éªŒè¯æ‰€æœ‰ç®¡ç†åŠŸèƒ½</div>
        </div>

        <div class="section">
            <h3>1. æµ‹è¯•ä¿®å¤åçš„ç™»å½•API</h3>
            <button class="button" onclick="testLoginAPI()">æµ‹è¯•ç™»å½•API</button>
            <div id="loginApiResult" class="result"></div>
        </div>

        <div class="section">
            <h3>2. æ¨¡æ‹Ÿå‰ç«¯ç™»å½•æµç¨‹</h3>
            <button class="button" onclick="simulateLogin()">æ¨¡æ‹Ÿå®Œæ•´ç™»å½•</button>
            <div id="loginFlowResult" class="result"></div>
        </div>

        <div class="section">
            <h3>3. éªŒè¯è®¤è¯çŠ¶æ€</h3>
            <button class="button" onclick="verifyAuthState()">éªŒè¯è®¤è¯çŠ¶æ€</button>
            <div id="authStateResult" class="result"></div>
        </div>

        <div class="section">
            <h3>4. æµ‹è¯•ç®¡ç†å‘˜æ•°æ®åŠ è½½</h3>
            <button class="button" onclick="testAdminDataLoading()">æµ‹è¯•æ•°æ®åŠ è½½</button>
            <div id="dataLoadingResult" class="result"></div>
        </div>

        <div class="section">
            <h3>5. æ‰“å¼€ä¿®å¤åçš„ç®¡ç†é¡µé¢</h3>
            <button class="button" onclick="openAdminPage()">æ‰“å¼€ç®¡ç†é¡µé¢</button>
            <div id="adminPageResult" class="result"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://employment-survey-api-prod.chrismarker89.workers.dev';
        const ADMIN_URL = 'https://632fb8ff.college-employment-survey-frontend-l84.pages.dev';

        async function testLoginAPI() {
            try {
                // æµ‹è¯•ä¿®å¤åçš„APIç«¯ç‚¹
                const response = await fetch(`${API_BASE}/api/auth/admin/generate-token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        username: 'admin', 
                        password: 'admin123' 
                    })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('loginApiResult').innerHTML = `
                        <div class="success">âœ… ç™»å½•APIæµ‹è¯•æˆåŠŸ</div>
                        <div><strong>Token:</strong> ${data.data.token.substring(0, 30)}...</div>
                        <div><strong>ç”¨æˆ·ç±»å‹:</strong> ${data.data.userType}</div>
                        <div><strong>ç”¨æˆ·å:</strong> ${data.data.username}</div>
                        <div><strong>è¿‡æœŸæ—¶é—´:</strong> ${data.data.expiresIn}</div>
                    `;
                    return data.data.token;
                } else {
                    throw new Error(data.message || 'ç™»å½•å¤±è´¥');
                }
            } catch (error) {
                document.getElementById('loginApiResult').innerHTML = `
                    <div class="error">âŒ ç™»å½•APIæµ‹è¯•å¤±è´¥: ${error.message}</div>
                `;
                return null;
            }
        }

        async function simulateLogin() {
            try {
                // 1. è°ƒç”¨ç™»å½•API
                const token = await testLoginAPI();
                if (!token) {
                    throw new Error('æ— æ³•è·å–token');
                }

                // 2. æ¨¡æ‹Ÿå‰ç«¯è®¤è¯çŠ¶æ€è®¾ç½®
                const currentUser = {
                    id: 'admin',
                    username: 'admin',
                    userType: 'SUPER_ADMIN',
                    permissions: ['ALL', 'USER_MANAGEMENT', 'CONTENT_MANAGEMENT', 'SYSTEM_MANAGEMENT']
                };

                const currentSession = {
                    sessionId: 'session_' + Date.now(),
                    userId: 'admin',
                    userType: 'SUPER_ADMIN',
                    expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
                    createdAt: new Date().toISOString()
                };

                // 3. è®¾ç½®localStorage
                localStorage.setItem('management_auth_token', token);
                localStorage.setItem('management_current_user', JSON.stringify(currentUser));
                localStorage.setItem('management_current_session', JSON.stringify(currentSession));

                document.getElementById('loginFlowResult').innerHTML = `
                    <div class="success">âœ… å®Œæ•´ç™»å½•æµç¨‹æ¨¡æ‹ŸæˆåŠŸ</div>
                    <div><strong>Tokenå·²è®¾ç½®:</strong> ${token.substring(0, 30)}...</div>
                    <div><strong>ç”¨æˆ·ä¿¡æ¯å·²è®¾ç½®:</strong> ${currentUser.username} (${currentUser.userType})</div>
                    <div><strong>ä¼šè¯ä¿¡æ¯å·²è®¾ç½®:</strong> ${currentSession.sessionId}</div>
                    <div><strong>localStorageé”®:</strong> ${Object.keys(localStorage).filter(k => k.includes('management')).join(', ')}</div>
                `;

                return true;
            } catch (error) {
                document.getElementById('loginFlowResult').innerHTML = `
                    <div class="error">âŒ ç™»å½•æµç¨‹æ¨¡æ‹Ÿå¤±è´¥: ${error.message}</div>
                `;
                return false;
            }
        }

        function verifyAuthState() {
            try {
                // æ£€æŸ¥localStorageä¸­çš„è®¤è¯ä¿¡æ¯
                const authToken = localStorage.getItem('management_auth_token');
                const currentUser = localStorage.getItem('management_current_user');
                const currentSession = localStorage.getItem('management_current_session');

                let parsedUser = null;
                let parsedSession = null;

                try {
                    parsedUser = currentUser ? JSON.parse(currentUser) : null;
                    parsedSession = currentSession ? JSON.parse(currentSession) : null;
                } catch (e) {
                    throw new Error('è®¤è¯æ•°æ®è§£æå¤±è´¥: ' + e.message);
                }

                // éªŒè¯ä¼šè¯æœ‰æ•ˆæ€§
                const isSessionValid = parsedSession && new Date(parsedSession.expiresAt) > new Date();
                const isAuthenticated = !!(authToken && parsedUser && parsedSession && isSessionValid);

                const result = {
                    hasToken: !!authToken,
                    hasUser: !!parsedUser,
                    hasSession: !!parsedSession,
                    isSessionValid: isSessionValid,
                    isAuthenticated: isAuthenticated,
                    userType: parsedUser?.userType,
                    permissions: parsedUser?.permissions,
                    sessionExpiry: parsedSession?.expiresAt
                };

                const status = isAuthenticated ? 'success' : 'error';
                const icon = isAuthenticated ? 'âœ…' : 'âŒ';

                document.getElementById('authStateResult').innerHTML = `
                    <div class="${status}">${icon} è®¤è¯çŠ¶æ€éªŒè¯ç»“æœ</div>
                    <div class="code">${JSON.stringify(result, null, 2)}</div>
                    ${isAuthenticated ? 
                        '<div class="success">ğŸ‰ è®¤è¯çŠ¶æ€å®Œå…¨æ­£å¸¸ï¼ç®¡ç†é¡µé¢åº”è¯¥èƒ½æ­£å¸¸åŠ è½½æ•°æ®äº†ã€‚</div>' : 
                        '<div class="error">âš ï¸ è®¤è¯çŠ¶æ€å¼‚å¸¸ï¼Œéœ€è¦é‡æ–°ç™»å½•ã€‚</div>'
                    }
                `;

                return isAuthenticated;
            } catch (error) {
                document.getElementById('authStateResult').innerHTML = `
                    <div class="error">âŒ è®¤è¯çŠ¶æ€éªŒè¯å¤±è´¥: ${error.message}</div>
                `;
                return false;
            }
        }

        async function testAdminDataLoading() {
            try {
                const authToken = localStorage.getItem('management_auth_token');
                if (!authToken) {
                    throw new Error('ç¼ºå°‘è®¤è¯tokenï¼Œè¯·å…ˆå®Œæˆç™»å½•æµç¨‹');
                }

                // æµ‹è¯•æ‰€æœ‰ç®¡ç†å‘˜API
                const apis = [
                    { name: 'ä»ªè¡¨æ¿ç»Ÿè®¡', url: '/api/admin/dashboard/stats' },
                    { name: 'ç”¨æˆ·åˆ—è¡¨', url: '/api/admin/users?page=1&pageSize=5' },
                    { name: 'å®¡æ ¸å‘˜åˆ—è¡¨', url: '/api/admin/reviewers' },
                    { name: 'å†…å®¹æ ‡ç­¾', url: '/api/admin/content/tags' },
                    { name: 'æ•°æ®åº“è¡¨', url: '/api/admin/database/tables' }
                ];

                let results = [];

                for (const api of apis) {
                    try {
                        const response = await fetch(`${API_BASE}${api.url}`, {
                            headers: {
                                'Authorization': `Bearer ${authToken}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        const data = await response.json();
                        results.push({
                            name: api.name,
                            status: response.status,
                            success: response.ok,
                            dataCount: data.data?.items?.length || data.data?.length || (data.data ? 1 : 0),
                            message: data.message
                        });
                    } catch (error) {
                        results.push({
                            name: api.name,
                            status: 'ERROR',
                            success: false,
                            error: error.message
                        });
                    }
                }

                const allSuccess = results.every(r => r.success);
                const icon = allSuccess ? 'âœ…' : 'âŒ';

                document.getElementById('dataLoadingResult').innerHTML = `
                    <div class="${allSuccess ? 'success' : 'error'}">${icon} ç®¡ç†å‘˜æ•°æ®åŠ è½½æµ‹è¯•ç»“æœ</div>
                    <div class="code">${JSON.stringify(results, null, 2)}</div>
                    ${allSuccess ? 
                        '<div class="success">ğŸ‰ æ‰€æœ‰ç®¡ç†å‘˜APIéƒ½æ­£å¸¸å·¥ä½œï¼æ•°æ®åŠ è½½å®Œå…¨æ­£å¸¸ã€‚</div>' : 
                        '<div class="error">âš ï¸ éƒ¨åˆ†APIè°ƒç”¨å¤±è´¥ï¼Œéœ€è¦æ£€æŸ¥å…·ä½“é—®é¢˜ã€‚</div>'
                    }
                `;

                return allSuccess;
            } catch (error) {
                document.getElementById('dataLoadingResult').innerHTML = `
                    <div class="error">âŒ æ•°æ®åŠ è½½æµ‹è¯•å¤±è´¥: ${error.message}</div>
                `;
                return false;
            }
        }

        async function openAdminPage() {
            try {
                // ç¡®ä¿è®¤è¯çŠ¶æ€æ­£ç¡®
                const isAuthenticated = verifyAuthState();
                if (!isAuthenticated) {
                    throw new Error('è®¤è¯çŠ¶æ€å¼‚å¸¸ï¼Œè¯·å…ˆå®Œæˆç™»å½•æµç¨‹');
                }

                // æ‰“å¼€ç®¡ç†å‘˜é¡µé¢
                const adminPageUrl = `${ADMIN_URL}/admin`;
                window.open(adminPageUrl, '_blank');

                document.getElementById('adminPageResult').innerHTML = `
                    <div class="success">âœ… å·²æ‰“å¼€ä¿®å¤åçš„ç®¡ç†å‘˜é¡µé¢</div>
                    <div><strong>é¡µé¢URL:</strong> ${adminPageUrl}</div>
                    <div class="warning">âš ï¸ å¦‚æœé¡µé¢ä»ç„¶æ˜¾ç¤ºç©ºç™½æ•°æ®ï¼Œè¯·ï¼š</div>
                    <div>1. åˆ·æ–°é¡µé¢</div>
                    <div>2. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯</div>
                    <div>3. ç¡®è®¤localStorageä¸­çš„è®¤è¯ä¿¡æ¯</div>
                    <div>4. å°è¯•é‡æ–°ç™»å½•</div>
                `;
            } catch (error) {
                document.getElementById('adminPageResult').innerHTML = `
                    <div class="error">âŒ æ‰“å¼€ç®¡ç†é¡µé¢å¤±è´¥: ${error.message}</div>
                `;
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡ŒåŸºç¡€æ£€æŸ¥
        window.onload = function() {
            verifyAuthState();
        };
    </script>
</body>
</html>
