<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰ç«¯è®¤è¯çŠ¶æ€è°ƒè¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1890ff;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-left: 4px solid #1890ff;
            border-radius: 4px;
        }
        .code {
            background: #f1f1f1;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            margin: 10px 0;
            word-break: break-all;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .button:hover {
            background: #40a9ff;
        }
        .success {
            color: #52c41a;
            font-weight: bold;
        }
        .error {
            color: #ff4d4f;
            font-weight: bold;
        }
        .warning {
            color: #fa8c16;
            font-weight: bold;
        }
        .result {
            background: #fff;
            border: 1px solid #d9d9d9;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” å‰ç«¯è®¤è¯çŠ¶æ€è°ƒè¯•å·¥å…·</h1>
        
        <div class="section">
            <h3>1. è®¾ç½®å®Œæ•´çš„ç®¡ç†å‘˜è®¤è¯çŠ¶æ€</h3>
            <button class="button" onclick="setupCompleteAuth()">è®¾ç½®å®Œæ•´è®¤è¯çŠ¶æ€</button>
            <div id="setupResult" class="result"></div>
        </div>

        <div class="section">
            <h3>2. æ£€æŸ¥localStorageçŠ¶æ€</h3>
            <button class="button" onclick="checkLocalStorage()">æ£€æŸ¥localStorage</button>
            <div id="localStorageResult" class="result"></div>
        </div>

        <div class="section">
            <h3>3. æ¨¡æ‹Ÿå‰ç«¯è®¤è¯æ£€æŸ¥</h3>
            <button class="button" onclick="simulateAuthCheck()">æ¨¡æ‹Ÿè®¤è¯æ£€æŸ¥</button>
            <div id="authCheckResult" class="result"></div>
        </div>

        <div class="section">
            <h3>4. æµ‹è¯•ç®¡ç†å‘˜APIè°ƒç”¨</h3>
            <button class="button" onclick="testAdminAPIs()">æµ‹è¯•æ‰€æœ‰ç®¡ç†å‘˜API</button>
            <div id="apiTestResult" class="result"></div>
        </div>

        <div class="section">
            <h3>5. å¼ºåˆ¶åˆ·æ–°ç®¡ç†å‘˜é¡µé¢</h3>
            <button class="button" onclick="forceRefreshAdmin()">å¼ºåˆ¶åˆ·æ–°å¹¶è·³è½¬</button>
            <div id="refreshResult" class="result"></div>
        </div>
    </div>

    <script>
        const TOKEN = 'mgmt_token_SUPER_ADMIN_1758632380252';
        const API_BASE = 'https://employment-survey-api-prod.chrismarker89.workers.dev';

        function setupCompleteAuth() {
            // è®¾ç½®æ‰€æœ‰å¿…è¦çš„è®¤è¯ä¿¡æ¯
            const currentUser = {
                id: 'super_admin',
                username: 'super_admin',
                email: 'admin@system.local',
                userType: 'SUPER_ADMIN',
                permissions: ['ALL', 'USER_MANAGEMENT', 'CONTENT_MANAGEMENT', 'SYSTEM_MANAGEMENT'],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            const currentSession = {
                sessionId: 'session_' + Date.now(),
                userId: 'super_admin',
                userType: 'SUPER_ADMIN',
                expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
                createdAt: new Date().toISOString()
            };

            // è®¾ç½®localStorage
            localStorage.setItem('management_auth_token', TOKEN);
            localStorage.setItem('management_current_user', JSON.stringify(currentUser));
            localStorage.setItem('management_current_session', JSON.stringify(currentSession));

            // è®¾ç½®å…¶ä»–å¯èƒ½éœ€è¦çš„çŠ¶æ€
            localStorage.setItem('management_auth_state', JSON.stringify({
                isAuthenticated: true,
                currentUser: currentUser,
                currentSession: currentSession,
                authToken: TOKEN
            }));

            document.getElementById('setupResult').innerHTML = `
                <div class="success">âœ… å®Œæ•´è®¤è¯çŠ¶æ€å·²è®¾ç½®</div>
                <div><strong>ç”¨æˆ·ç±»å‹:</strong> ${currentUser.userType}</div>
                <div><strong>æƒé™:</strong> ${currentUser.permissions.join(', ')}</div>
                <div><strong>Token:</strong> ${TOKEN.substring(0, 30)}...</div>
                <div><strong>ä¼šè¯è¿‡æœŸæ—¶é—´:</strong> ${currentSession.expiresAt}</div>
            `;
        }

        function checkLocalStorage() {
            const keys = Object.keys(localStorage);
            const managementKeys = keys.filter(k => k.includes('management'));
            
            const authData = {};
            managementKeys.forEach(key => {
                try {
                    const value = localStorage.getItem(key);
                    authData[key] = value.startsWith('{') ? JSON.parse(value) : value;
                } catch (e) {
                    authData[key] = localStorage.getItem(key);
                }
            });

            document.getElementById('localStorageResult').innerHTML = `
                <div><strong>ç®¡ç†ç›¸å…³çš„localStorageé”®:</strong></div>
                <div class="code">${managementKeys.join('\n')}</div>
                <div><strong>è®¤è¯æ•°æ®:</strong></div>
                <div class="code">${JSON.stringify(authData, null, 2)}</div>
            `;
        }

        function simulateAuthCheck() {
            // æ¨¡æ‹Ÿå‰ç«¯çš„è®¤è¯æ£€æŸ¥é€»è¾‘
            const authToken = localStorage.getItem('management_auth_token');
            const currentUser = localStorage.getItem('management_current_user');
            const currentSession = localStorage.getItem('management_current_session');

            let parsedUser = null;
            let parsedSession = null;

            try {
                parsedUser = currentUser ? JSON.parse(currentUser) : null;
                parsedSession = currentSession ? JSON.parse(currentSession) : null;
            } catch (e) {
                console.error('è§£æè®¤è¯æ•°æ®å¤±è´¥:', e);
            }

            // æ£€æŸ¥ä¼šè¯æ˜¯å¦æœ‰æ•ˆ
            const isSessionValid = parsedSession && new Date(parsedSession.expiresAt) > new Date();
            const isAuthenticated = !!(authToken && parsedUser && parsedSession && isSessionValid);

            const result = {
                hasToken: !!authToken,
                hasUser: !!parsedUser,
                hasSession: !!parsedSession,
                isSessionValid: isSessionValid,
                isAuthenticated: isAuthenticated,
                userType: parsedUser?.userType,
                permissions: parsedUser?.permissions,
                sessionExpiry: parsedSession?.expiresAt
            };

            const status = isAuthenticated ? 'success' : 'error';
            const icon = isAuthenticated ? 'âœ…' : 'âŒ';

            document.getElementById('authCheckResult').innerHTML = `
                <div class="${status}">${icon} è®¤è¯çŠ¶æ€æ£€æŸ¥ç»“æœ</div>
                <div class="code">${JSON.stringify(result, null, 2)}</div>
                ${!isAuthenticated ? '<div class="error">âš ï¸ è®¤è¯æ£€æŸ¥å¤±è´¥ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆç®¡ç†é¡µé¢ä¸åŠ è½½æ•°æ®çš„åŸå› ï¼</div>' : ''}
            `;
        }

        async function testAdminAPIs() {
            const apis = [
                { name: 'ä»ªè¡¨æ¿ç»Ÿè®¡', url: '/api/admin/dashboard/stats' },
                { name: 'ç”¨æˆ·åˆ—è¡¨', url: '/api/admin/users?page=1&pageSize=5' },
                { name: 'å®¡æ ¸å‘˜åˆ—è¡¨', url: '/api/admin/reviewers' },
                { name: 'å†…å®¹æ ‡ç­¾', url: '/api/admin/content/tags' },
                { name: 'æ•°æ®åº“è¡¨', url: '/api/admin/database/tables' }
            ];

            let results = [];

            for (const api of apis) {
                try {
                    const response = await fetch(`${API_BASE}${api.url}`, {
                        headers: {
                            'Authorization': `Bearer ${TOKEN}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    const data = await response.json();
                    results.push({
                        name: api.name,
                        status: response.status,
                        success: response.ok,
                        dataCount: data.data?.items?.length || data.data?.length || (data.data ? 1 : 0)
                    });
                } catch (error) {
                    results.push({
                        name: api.name,
                        status: 'ERROR',
                        success: false,
                        error: error.message
                    });
                }
            }

            const allSuccess = results.every(r => r.success);
            const icon = allSuccess ? 'âœ…' : 'âŒ';

            document.getElementById('apiTestResult').innerHTML = `
                <div class="${allSuccess ? 'success' : 'error'}">${icon} APIæµ‹è¯•ç»“æœ</div>
                <div class="code">${JSON.stringify(results, null, 2)}</div>
                ${allSuccess ? '<div class="success">æ‰€æœ‰APIéƒ½æ­£å¸¸å·¥ä½œï¼é—®é¢˜ç¡®å®åœ¨å‰ç«¯è®¤è¯çŠ¶æ€ã€‚</div>' : ''}
            `;
        }

        function forceRefreshAdmin() {
            // ç¡®ä¿è®¤è¯çŠ¶æ€æ­£ç¡®è®¾ç½®
            setupCompleteAuth();
            
            // ç­‰å¾…ä¸€ä¸‹è®©localStorageç”Ÿæ•ˆ
            setTimeout(() => {
                // æ‰“å¼€ç®¡ç†å‘˜é¡µé¢
                const adminUrl = 'https://adfe3dcb.college-employment-survey-frontend-l84.pages.dev/admin';
                window.open(adminUrl, '_blank');
                
                document.getElementById('refreshResult').innerHTML = `
                    <div class="success">âœ… å·²è®¾ç½®è®¤è¯çŠ¶æ€å¹¶æ‰“å¼€ç®¡ç†å‘˜é¡µé¢</div>
                    <div>å¦‚æœé¡µé¢ä»ç„¶æ˜¾ç¤ºç©ºç™½æ•°æ®ï¼Œè¯·ï¼š</div>
                    <div>1. æŒ‰F12æ‰“å¼€å¼€å‘è€…å·¥å…·</div>
                    <div>2. åœ¨Consoleä¸­æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯</div>
                    <div>3. åœ¨Networkæ ‡ç­¾ä¸­æŸ¥çœ‹APIè¯·æ±‚æ˜¯å¦å‘é€</div>
                    <div>4. åˆ·æ–°é¡µé¢è¯•è¯•</div>
                `;
            }, 500);
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.onload = function() {
            checkLocalStorage();
            simulateAuthCheck();
        };
    </script>
</body>
</html>
