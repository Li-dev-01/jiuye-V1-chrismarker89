# ç»Ÿè®¡é€»è¾‘ä¿®æ­£æ–¹æ¡ˆ

## é—®é¢˜åˆ†æ

### ğŸ¯ **ç”¨æˆ·çš„æ­£ç¡®ç†è§£**
> "åˆ†æ”¯å¹¶ä¸åº”è¯¥å½±å“ç»Ÿè®¡ï¼Œå› ä¸ºé€»è¾‘æ˜¯ï¼Œåˆ†æ”¯åšäººæ”¯çš„ç»Ÿè®¡ï¼Œå¹¶ä¸çŸ›ç›¾ï¼Œå› ä¸ºæ¯ä¸€é“é¢˜ç›®ï¼Œåªæ˜¯å¯¹é€‰é¡¹åšå®æ—¶æ¯”ä¾‹ç»Ÿè®¡ï¼Œäººå¤šäººå°‘ï¼Œå¹¶æ²¡æœ‰åŒºåˆ«çš„ã€‚"

ç”¨æˆ·å®Œå…¨æ­£ç¡®ï¼è¿™ç¡®å®æ˜¯ä¹‹å‰è®¾è®¡çš„é€»è¾‘ç¼ºé™·ã€‚

### âŒ **ä¹‹å‰çš„é”™è¯¯é€»è¾‘**
```typescript
// é”™è¯¯ï¼šç”¨æ€»é—®å·æ•°ä½œä¸ºåˆ†æ¯
percentage = (é€‰æ‹©è¯¥é€‰é¡¹çš„äººæ•° / æ€»é—®å·å“åº”æ•°) * 100

// é—®é¢˜ï¼š
// - å¦‚æœ100äººå¡«é—®å·ï¼Œä½†åªæœ‰10äººçœ‹åˆ°æŸé¢˜
// - å…¶ä¸­6äººé€‰Aï¼Œ4äººé€‰B
// - é”™è¯¯è®¡ç®—ï¼šA = 6/100 = 6%, B = 4/100 = 4%
// - è¿™æ ·ç»Ÿè®¡æ¯«æ— æ„ä¹‰ï¼
```

### âœ… **ä¿®æ­£åçš„æ­£ç¡®é€»è¾‘**
```typescript
// æ­£ç¡®ï¼šç”¨å®é™…å›ç­”è¯¥é¢˜çš„äººæ•°ä½œä¸ºåˆ†æ¯
percentage = (é€‰æ‹©è¯¥é€‰é¡¹çš„äººæ•° / å®é™…å›ç­”è¯¥é¢˜çš„äººæ•°) * 100

// æ­£ç¡®è®¡ç®—ï¼š
// - 100äººå¡«é—®å·ï¼Œ10äººçœ‹åˆ°æŸé¢˜
// - å…¶ä¸­6äººé€‰Aï¼Œ4äººé€‰B
// - æ­£ç¡®è®¡ç®—ï¼šA = 6/10 = 60%, B = 4/10 = 40%
// - è¿™æ ·æ‰æœ‰ç»Ÿè®¡æ„ä¹‰ï¼
```

## ä¿®æ­£å®æ–½

### 1. **æ ¸å¿ƒç®—æ³•ä¿®æ­£**

#### ä¿®æ­£å‰ï¼š
```typescript
const questionStats: Record<string, Record<string, number>> = {};

// é”™è¯¯ï¼šåªç»Ÿè®¡é€‰é¡¹è®¡æ•°ï¼Œæ²¡æœ‰è®°å½•å®é™…å›ç­”äººæ•°
for (const [questionId, value] of Object.entries(flatData)) {
  if (!questionStats[questionId]) {
    questionStats[questionId] = {};
  }
  questionStats[questionId][value] = (questionStats[questionId][value] || 0) + 1;
}

// é”™è¯¯ï¼šç”¨æ€»é—®å·æ•°è®¡ç®—ç™¾åˆ†æ¯”
const totalForQuestion = Object.values(optionCounts).reduce((sum, count) => sum + count, 0);
percentage = Math.round((count / totalForQuestion) * 100 * 100) / 100;
```

#### ä¿®æ­£åï¼š
```typescript
const questionStats: Record<string, {
  totalAnswered: number;  // å…³é”®ï¼šè®°å½•å®é™…å›ç­”è¯¥é¢˜çš„äººæ•°
  optionCounts: Record<string, number>;
}> = {};

// æ­£ç¡®ï¼šè®°å½•æ¯é¢˜çš„å®é™…å›ç­”äººæ•°
for (const [questionId, value] of Object.entries(flatData)) {
  if (!questionStats[questionId]) {
    questionStats[questionId] = {
      totalAnswered: 0,
      optionCounts: {}
    };
  }
  
  // å…³é”®ï¼šæ¯ä¸ªå›ç­”è¯¥é¢˜çš„ç”¨æˆ·è®¡å…¥æ€»æ•°
  questionStats[questionId].totalAnswered++;
  
  questionStats[questionId].optionCounts[value] = 
    (questionStats[questionId].optionCounts[value] || 0) + 1;
}

// æ­£ç¡®ï¼šç”¨å®é™…å›ç­”è¯¥é¢˜çš„äººæ•°è®¡ç®—ç™¾åˆ†æ¯”
percentage = Math.round((count / totalAnswered) * 100 * 100) / 100;
```

### 2. **æ•°æ®ç»“æ„å¢å¼º**

#### æ–°å¢å­—æ®µï¼š
```typescript
{
  questionId: "age-range",
  totalAnswered: 6,        // å®é™…å›ç­”è¯¥é¢˜çš„äººæ•°
  displayRate: 100,        // é¢˜ç›®æ˜¾ç¤ºç‡ = totalAnswered / totalQuestionnaires
  options: [
    {
      value: "20-22",
      count: 5,
      percentage: 83.33      // 5/6 = 83.33% (æ­£ç¡®è®¡ç®—)
    }
  ],
  metadata: {
    totalQuestionnaires: 6,  // æ€»é—®å·æ•°
    actualAnswers: 6,        // å®é™…å›ç­”æ•°
    isConditional: false     // æ˜¯å¦ä¸ºæ¡ä»¶æ˜¾ç¤ºé¢˜ç›®
  }
}
```

### 3. **API å¢å¼º**

#### æ–°å¢APIç«¯ç‚¹ï¼š
- `GET /api/analytics/corrected-statistics/:questionnaireId` - ä¿®æ­£åçš„ç»Ÿè®¡é€»è¾‘
- `GET /api/analytics/data-completeness-analysis/:questionnaireId` - æ•°æ®å®Œæ•´æ€§åˆ†æ
- `GET /api/analytics/raw-data-sample/:questionnaireId` - åŸå§‹æ•°æ®æŸ¥çœ‹

#### ä¿®æ­£ç°æœ‰APIï¼š
- `GET /api/universal-questionnaire/statistics/:questionnaireId` - å·²ä½¿ç”¨ä¿®æ­£é€»è¾‘

## å®é™…æ•ˆæœå¯¹æ¯”

### å½“å‰æ•°æ®çŠ¶å†µï¼š
- **æ€»é—®å·æ•°**ï¼š6ä»½
- **åŸºç¡€ä¿¡æ¯é¢˜ç›®**ï¼š6äººå›ç­”ï¼ˆæ˜¾ç¤ºç‡100%ï¼‰
- **æ¡ä»¶æ˜¾ç¤ºé¢˜ç›®**ï¼š0äººå›ç­”ï¼ˆæ˜¾ç¤ºç‡0%ï¼‰

### ç»Ÿè®¡ç»“æœç¤ºä¾‹ï¼š

#### å¹´é¾„æ®µç»Ÿè®¡ï¼ˆ6äººå›ç­”ï¼‰ï¼š
```json
{
  "questionId": "age-range",
  "totalAnswered": 6,
  "displayRate": 100,
  "options": [
    {"value": "20-22", "count": 5, "percentage": 83.33},
    {"value": "23-25", "count": 1, "percentage": 16.67}
  ]
}
```

#### å¦‚æœæ˜¯æ¡ä»¶é¢˜ç›®ï¼ˆå‡è®¾åªæœ‰2äººå›ç­”ï¼‰ï¼š
```json
{
  "questionId": "work-industry",
  "totalAnswered": 2,
  "displayRate": 33.33,  // 2/6 = 33.33%
  "options": [
    {"value": "tech", "count": 1, "percentage": 50},      // 1/2 = 50%
    {"value": "finance", "count": 1, "percentage": 50}    // 1/2 = 50%
  ]
}
```

## æ ¸å¿ƒä¼˜åŠ¿

### 1. **ç»Ÿè®¡æ„ä¹‰æ˜ç¡®**
- æ¯é“é¢˜çš„ç™¾åˆ†æ¯”éƒ½æœ‰æ˜ç¡®å«ä¹‰
- ä¸å—é—®å·åˆ†æ”¯é€»è¾‘å½±å“
- çœŸå®åæ˜ é€‰é¡¹åˆ†å¸ƒ

### 2. **æ”¯æŒæ¡ä»¶æ˜¾ç¤º**
- æ¡ä»¶é¢˜ç›®ç‹¬ç«‹ç»Ÿè®¡
- æ˜¾ç¤ºç‡æŒ‡æ ‡å¸®åŠ©ç†è§£æ•°æ®
- ä¸åŒåˆ†æ”¯çš„é¢˜ç›®éƒ½èƒ½æ­£ç¡®ç»Ÿè®¡

### 3. **æ•°æ®é€æ˜åº¦**
- æ¸…æ¥šæ˜¾ç¤ºå®é™…å›ç­”äººæ•°
- åŒºåˆ†æ€»é—®å·æ•°å’Œå®é™…å›ç­”æ•°
- ä¾¿äºæ•°æ®è´¨é‡è¯„ä¼°

### 4. **æ‰©å±•æ€§å¼º**
- æ”¯æŒå¤æ‚çš„åˆ†æ”¯é€»è¾‘
- é€‚ç”¨äºä»»ä½•æ¡ä»¶æ˜¾ç¤ºåœºæ™¯
- ä¾¿äºåç»­åŠŸèƒ½æ‰©å±•

## éªŒè¯æ–¹æ³•

### 1. **APIæµ‹è¯•**
```bash
# æŸ¥çœ‹ä¿®æ­£åçš„ç»Ÿè®¡
curl "http://localhost:8787/api/analytics/corrected-statistics/employment-survey-2024"

# æŸ¥çœ‹æ•°æ®å®Œæ•´æ€§åˆ†æ
curl "http://localhost:8787/api/analytics/data-completeness-analysis/employment-survey-2024"

# æŸ¥çœ‹åŸå§‹æ•°æ®æ ·æœ¬
curl "http://localhost:8787/api/analytics/raw-data-sample/employment-survey-2024"
```

### 2. **é€»è¾‘éªŒè¯**
- âœ… åŸºç¡€é¢˜ç›®ï¼š6äººå›ç­”ï¼Œç™¾åˆ†æ¯”æ­£ç¡®ï¼ˆ83.33% + 16.67% = 100%ï¼‰
- âœ… æ¡ä»¶é¢˜ç›®ï¼š0äººå›ç­”ï¼Œæ˜¾ç¤ºç‡0%ï¼Œç¬¦åˆé¢„æœŸ
- âœ… æ•°æ®ç»“æ„ï¼šåŒ…å«æ‰€æœ‰å¿…è¦çš„å…ƒæ•°æ®ä¿¡æ¯

### 3. **è¾¹ç•Œæƒ…å†µ**
- 1äººå›ç­”ï¼špercentage = 100%
- å¤šäººå›ç­”ï¼špercentageæ€»å’Œ = 100%
- 0äººå›ç­”ï¼šä¸æ˜¾ç¤ºç»Ÿè®¡æ•°æ®

## ç»“è®º

è¿™æ¬¡ä¿®æ­£è§£å†³äº†ç»Ÿè®¡é€»è¾‘çš„æ ¹æœ¬é—®é¢˜ï¼š

1. **æ¯é“é¢˜ç›®ç‹¬ç«‹ç»Ÿè®¡** - ç¬¦åˆç”¨æˆ·çš„æ­£ç¡®ç†è§£
2. **ç™¾åˆ†æ¯”è®¡ç®—å‡†ç¡®** - ä½¿ç”¨å®é™…å›ç­”äººæ•°ä½œä¸ºåˆ†æ¯
3. **æ”¯æŒåˆ†æ”¯é€»è¾‘** - æ¡ä»¶æ˜¾ç¤ºé¢˜ç›®ä¹Ÿèƒ½æ­£ç¡®ç»Ÿè®¡
4. **æ•°æ®é€æ˜å¯ä¿¡** - æä¾›å®Œæ•´çš„ç»Ÿè®¡å…ƒæ•°æ®

ç°åœ¨çš„ç»Ÿè®¡ç³»ç»ŸçœŸæ­£åšåˆ°äº†"åˆ†æ”¯åšåˆ†æ”¯çš„ç»Ÿè®¡"ï¼Œæ¯é“é¢˜ç›®éƒ½èƒ½ç‹¬ç«‹ã€å‡†ç¡®åœ°åæ˜ é€‰é¡¹åˆ†å¸ƒï¼Œä¸ç®¡æœ‰å¤šå°‘äººçœ‹åˆ°è¿™é“é¢˜ã€‚è¿™æ­£æ˜¯ç”¨æˆ·æœŸæœ›çš„æ­£ç¡®é€»è¾‘ï¼
